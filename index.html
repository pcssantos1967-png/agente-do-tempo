<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetBrasil · Inteligência Climática em Tempo Real</title>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
/* ===================== RESET & ROOT ===================== */
:root { --tr:1.4s; }
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{font-family:'Syne',sans-serif;transition:background var(--tr);}

/* ===================== THEMES ===================== */
.theme-rain{
  --bg1:#04101f;--bg2:#071828;--acc:#4fc3f7;--acc2:#0288d1;
  --txt:#e0f7fa;--card:rgba(5,24,52,0.88);--bdr:rgba(79,195,247,.22);
  --glow:rgba(79,195,247,.55);--shine:rgba(79,195,247,.07);
  --map-filter:hue-rotate(200deg) saturate(1.2) brightness(0.55);
  --map-overlay:rgba(4,16,31,0.45);
}
.theme-sun{
  --bg1:#b33800;--bg2:#e86000;--acc:#ffe566;--acc2:#ff9900;
  --txt:#1a0400;--card:rgba(255,240,190,0.90);--bdr:rgba(255,195,0,.38);
  --glow:rgba(255,225,70,.75);--shine:rgba(255,255,200,.10);
  --map-filter:hue-rotate(25deg) saturate(1.4) brightness(0.75);
  --map-overlay:rgba(180,60,0,0.30);
}
.theme-cloudy{
  --bg1:#18222f;--bg2:#263545;--acc:#a0bcd8;--acc2:#6888a4;
  --txt:#dde8f5;--card:rgba(22,34,50,0.90);--bdr:rgba(155,190,220,.22);
  --glow:rgba(155,190,220,.45);--shine:rgba(255,255,255,.04);
  --map-filter:grayscale(0.5) brightness(0.5) saturate(0.7);
  --map-overlay:rgba(18,28,42,0.45);
}
body{background:linear-gradient(145deg,var(--bg1),var(--bg2));color:var(--txt);}

/* ===================== PARTICLES CANVAS ===================== */
#fx{position:fixed;inset:0;pointer-events:none;z-index:1;}

/* ===================== THEME PROGRESS BAR ===================== */
#tbar{position:fixed;top:0;left:0;right:0;height:3px;z-index:300;overflow:hidden;}
#tbar-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));transition:background var(--tr);}
#tbar-prog{height:100%;background:rgba(255,255,255,.55);width:0%;animation:tprog 8s linear infinite;}
@keyframes tprog{from{width:0%}to{width:100%}}

/* ===================== FLASH OVERLAY ===================== */
#flash{position:fixed;inset:0;pointer-events:none;z-index:998;opacity:0;background:var(--bg1);transition:opacity .35s;}
.flashing{opacity:.32!important;}

/* ===================== LAYOUT SHELL ===================== */
.shell{
  position:relative;z-index:2;
  width:100vw;height:100vh;
  display:grid;
  grid-template-rows:56px 1fr;
  grid-template-columns:340px 1fr 290px;
  grid-template-areas:
    "hdr hdr hdr"
    "left map right";
}

/* ===================== HEADER ===================== */
header{
  grid-area:hdr;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 28px;
  background:var(--card);
  border-bottom:1px solid var(--bdr);
  backdrop-filter:blur(24px);
  transition:background var(--tr),border-color var(--tr);
  z-index:50;
}
.logo{display:flex;align-items:baseline;gap:10px;}
.logo-main{
  font-family:'Bebas Neue';font-size:1.9rem;letter-spacing:5px;
  color:var(--acc);text-shadow:0 0 18px var(--glow);
  transition:color var(--tr),text-shadow var(--tr);
}
.logo-dot{color:var(--acc2);transition:color var(--tr);}
.logo-sub{font-family:'DM Mono';font-size:.55rem;letter-spacing:5px;opacity:.4;text-transform:uppercase;}
.hdr-center{display:flex;align-items:center;gap:8px;}
.theme-pill{
  padding:5px 13px;border-radius:20px;border:1px solid var(--bdr);
  background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.62rem;
  cursor:pointer;opacity:.42;transition:all .25s,border-color var(--tr);
}
.theme-pill.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);opacity:1;font-weight:700;}
.theme-pill:hover:not(.on){opacity:.72;border-color:var(--acc);}
.hdr-right{display:flex;align-items:center;gap:10px;}
.utog{display:flex;border:1px solid var(--bdr);border-radius:8px;overflow:hidden;transition:border-color var(--tr);}
.ubtn{padding:4px 10px;background:transparent;border:none;color:var(--txt);font-family:'DM Mono';font-size:.68rem;cursor:pointer;opacity:.42;transition:all .2s;}
.ubtn.on{background:var(--acc);color:var(--bg1);opacity:1;font-weight:700;}
.live-clk{font-family:'DM Mono';font-size:.75rem;opacity:.55;letter-spacing:2px;}

/* ===================== LEFT PANEL ===================== */
.left-panel{
  grid-area:left;
  display:flex;flex-direction:column;gap:10px;
  padding:14px 10px 14px 14px;
  overflow-y:auto;
  background:transparent;
}
.left-panel::-webkit-scrollbar{width:3px;}
.left-panel::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px;}

/* ===================== RIGHT PANEL ===================== */
.right-panel{
  grid-area:right;
  display:flex;flex-direction:column;gap:10px;
  padding:14px 14px 14px 10px;
  overflow-y:auto;
  background:transparent;
}
.right-panel::-webkit-scrollbar{width:3px;}
.right-panel::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px;}

/* ===================== MAP AREA ===================== */
.map-wrap{
  grid-area:map;
  position:relative;
  overflow:hidden;
}
#map{
  width:100%;height:100%;
  filter:var(--map-filter);
  transition:filter var(--tr);
}
/* Map overlay for theme atmosphere */
.map-overlay{
  position:absolute;inset:0;
  background:var(--map-overlay);
  pointer-events:none;
  z-index:400;
  transition:background var(--tr);
}
/* Map brand badge */
.map-badge{
  position:absolute;bottom:28px;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--bdr);border-radius:30px;
  padding:6px 18px;
  font-family:'DM Mono';font-size:.6rem;letter-spacing:3px;opacity:.7;
  z-index:500;pointer-events:none;
  backdrop-filter:blur(12px);
  transition:background var(--tr),border-color var(--tr);
}
/* Map click instruction */
.map-hint{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--bdr);border-radius:20px;
  padding:5px 16px;
  font-family:'DM Mono';font-size:.58rem;letter-spacing:2px;opacity:.65;
  z-index:500;pointer-events:none;
  backdrop-filter:blur(12px);
  white-space:nowrap;
  transition:background var(--tr),border-color var(--tr);
}

/* ===================== CARDS ===================== */
.card{
  background:var(--card);
  border:1px solid var(--bdr);
  border-radius:16px;
  padding:16px;
  backdrop-filter:blur(22px);
  transition:background var(--tr),border-color var(--tr),box-shadow .2s;
  box-shadow:0 4px 24px rgba(0,0,0,.38),inset 0 1px 0 var(--shine);
  flex-shrink:0;
}
.card:hover{
  box-shadow:0 8px 36px rgba(0,0,0,.5),0 0 0 1px var(--bdr),inset 0 1px 0 var(--shine);
  transform:translateY(-1px);
  transition:transform .15s,box-shadow .15s,background var(--tr),border-color var(--tr);
}
.clabel{
  font-family:'DM Mono';font-size:.55rem;letter-spacing:3px;text-transform:uppercase;
  color:var(--acc);margin-bottom:8px;opacity:.72;transition:color var(--tr);
}

/* ===================== CURRENT WEATHER CARD ===================== */
.main-icon{text-align:center;font-size:56px;padding:6px 0;filter:drop-shadow(0 0 14px var(--glow));transition:filter var(--tr);}
.main-icon span{display:inline-block;animation:bob 3.5s ease-in-out infinite;}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-9px)}}
.big-temp{
  font-family:'Bebas Neue';font-size:5.5rem;line-height:1;
  color:var(--acc);text-shadow:0 0 30px var(--glow);
  transition:color var(--tr),text-shadow var(--tr);
}
.big-temp sup{font-size:1.8rem;vertical-align:top;margin-top:9px;display:inline-block;}
.city-name{font-size:1rem;font-weight:700;margin-top:2px;}
.city-desc{font-family:'DM Mono';font-size:.72rem;opacity:.55;margin-top:2px;}
.metas{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid var(--bdr);transition:border-color var(--tr);}
.meta{display:flex;flex-direction:column;gap:1px;}
.mlabel{font-family:'DM Mono';font-size:.52rem;letter-spacing:2px;text-transform:uppercase;opacity:.38;}
.mval{font-size:.88rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== COMPASS ===================== */
.compass-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px;}
.compass{width:60px;height:60px;border-radius:50%;border:1.5px solid var(--bdr);position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:border-color var(--tr);}
.cneedle{width:3px;height:22px;border-radius:2px;background:linear-gradient(to bottom,var(--acc),transparent);position:absolute;top:7px;left:50%;transform:translateX(-50%) rotate(var(--wd,220deg));transform-origin:bottom center;transition:transform 2s ease,background var(--tr);}
.ccenter{width:6px;height:6px;border-radius:50%;background:var(--acc);transition:background var(--tr);}
.clbls{position:absolute;inset:0;font-family:'DM Mono';font-size:.45rem;opacity:.4;}
.clbls span{position:absolute;line-height:1;}
.cn-n{top:3px;left:50%;transform:translateX(-50%);}
.cn-s{bottom:3px;left:50%;transform:translateX(-50%);}
.cn-e{right:3px;top:50%;transform:translateY(-50%);}
.cn-w{left:3px;top:50%;transform:translateY(-50%);}

/* ===================== HUMIDITY BAR ===================== */
.bartrack{height:5px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden;margin-top:5px;}
.barfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--acc2),var(--acc));transition:width .7s ease,background var(--tr);}

/* ===================== ALERTS ===================== */
.alert{display:flex;align-items:flex-start;gap:8px;padding:9px 11px;border-radius:9px;font-size:.7rem;line-height:1.4;margin-bottom:6px;}
.alert.warn{background:rgba(255,50,50,.08);border:1px solid rgba(255,80,80,.22);}
.alert.heat{background:rgba(255,140,0,.08);border:1px solid rgba(255,140,0,.22);}
.aicon{font-size:.95rem;flex-shrink:0;}

/* ===================== FORECAST ===================== */
.fstrip{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-top:8px;}
.fday{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 3px;border-radius:10px;border:1px solid var(--bdr);font-size:.65rem;cursor:pointer;transition:background .15s,border-color var(--tr);font-family:'DM Mono';}
.fday:hover{background:rgba(255,255,255,.06);}
.fday.on{background:var(--shine);border-color:var(--acc);}
.ficon{font-size:1.2rem;}
.ftemp{font-size:.82rem;font-weight:700;color:var(--acc);transition:color var(--tr);}
.flbl{opacity:.42;font-size:.52rem;text-transform:uppercase;letter-spacing:1px;}

/* ===================== STATE GRID ===================== */
.stgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;max-height:190px;overflow-y:auto;padding-right:2px;}
.stgrid::-webkit-scrollbar{width:2px;}
.stgrid::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px;}
.stbtn{padding:6px 3px;border-radius:7px;border:1px solid var(--bdr);background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.56rem;cursor:pointer;text-align:center;opacity:.55;transition:all .15s,border-color var(--tr);}
.stbtn:hover{background:rgba(255,255,255,.07);border-color:var(--acc);opacity:1;}
.stbtn.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);opacity:1;font-weight:700;}

/* ===================== TABS ===================== */
.tabs{display:flex;gap:3px;padding:3px;background:rgba(0,0,0,.2);border-radius:9px;margin-bottom:10px;}
.tbtn{flex:1;padding:6px;border:none;background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.56rem;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:7px;opacity:.4;transition:all .18s;}
.tbtn.on{background:var(--card);border:1px solid var(--bdr);opacity:1;color:var(--acc);}
.tcont{display:none;}
.tcont.on{display:block;}

/* State detail */
.sdet{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;}
.sname{font-family:'Bebas Neue';font-size:1.5rem;letter-spacing:2px;color:var(--acc);transition:color var(--tr);}
.stemp{font-family:'Bebas Neue';font-size:2.8rem;line-height:1;color:var(--acc);transition:color var(--tr);}

/* UV */
.uvscale{display:flex;gap:2px;margin-top:4px;}
.uvb{flex:1;height:5px;border-radius:2px;background:rgba(255,255,255,.07);transition:background .25s;}
.uvb.on{background:var(--acc);}

/* ===================== SEARCH BAR ===================== */
.search-wrap{position:relative;}
.search-input{
  width:100%;padding:9px 14px 9px 36px;
  background:var(--card);border:1px solid var(--bdr);border-radius:10px;
  color:var(--txt);font-family:'DM Mono';font-size:.7rem;
  outline:none;transition:all .2s,background var(--tr),border-color var(--tr);
}
.search-input:focus{border-color:var(--acc);box-shadow:0 0 0 2px var(--glow);}
.search-input::placeholder{opacity:.35;}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);opacity:.35;font-size:.85rem;pointer-events:none;}
.search-results{
  position:absolute;top:calc(100% + 4px);left:0;right:0;z-index:600;
  background:var(--card);border:1px solid var(--bdr);border-radius:10px;
  backdrop-filter:blur(20px);overflow:hidden;
  display:none;
  transition:background var(--tr),border-color var(--tr);
}
.search-results.show{display:block;}
.search-item{padding:8px 12px;font-family:'DM Mono';font-size:.68rem;cursor:pointer;opacity:.75;transition:background .1s;}
.search-item:hover{background:rgba(255,255,255,.08);opacity:1;}

/* ===================== MAP POPUP CUSTOM ===================== */
.leaflet-popup-content-wrapper{
  background:var(--card)!important;
  border:1px solid var(--bdr)!important;
  border-radius:14px!important;
  backdrop-filter:blur(20px);
  box-shadow:0 8px 32px rgba(0,0,0,.5)!important;
  color:var(--txt)!important;
  font-family:'Syne',sans-serif!important;
  transition:background var(--tr)!important;
}
.leaflet-popup-tip{background:var(--card)!important;}
.leaflet-popup-close-button{color:var(--acc)!important;font-size:1.1rem!important;}
.pop-content{min-width:180px;padding:4px;}
.pop-title{font-family:'Bebas Neue';font-size:1.4rem;letter-spacing:2px;color:var(--acc);transition:color var(--tr);}
.pop-temp{font-family:'Bebas Neue';font-size:2.8rem;line-height:1;color:var(--acc);transition:color var(--tr);}
.pop-desc{font-family:'DM Mono';font-size:.68rem;opacity:.6;margin-top:2px;}
.pop-meta{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--bdr);}
.pop-m{display:flex;flex-direction:column;}
.pop-ml{font-family:'DM Mono';font-size:.5rem;letter-spacing:2px;opacity:.38;text-transform:uppercase;}
.pop-mv{font-size:.82rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== SPINNER ===================== */
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:sp .7s linear infinite;vertical-align:middle;margin-right:5px;}
@keyframes sp{to{transform:rotate(360deg)}}

/* ===================== LOCATION PULSE ===================== */
@keyframes locpulse{
  0%{box-shadow:0 0 0 0 var(--glow);}
  70%{box-shadow:0 0 0 10px rgba(0,0,0,0);}
  100%{box-shadow:0 0 0 0 rgba(0,0,0,0);}
}
.loc-dot{
  width:14px;height:14px;border-radius:50%;
  background:var(--acc);
  border:2px solid white;
  animation:locpulse 2s infinite;
}

/* ===================== SCROLLBAR GLOBAL ===================== */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px;}

/* ===================== LOADING OVERLAY ===================== */
#loading{
  position:fixed;inset:0;z-index:9999;
  background:var(--bg1);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:14px;transition:opacity .5s;
}
#loading.hide{opacity:0;pointer-events:none;}
.load-logo{font-family:'Bebas Neue';font-size:3.5rem;letter-spacing:8px;color:var(--acc);text-shadow:0 0 30px var(--glow);}
.load-sub{font-family:'DM Mono';font-size:.6rem;letter-spacing:5px;opacity:.4;text-transform:uppercase;}
.load-bar{width:200px;height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin-top:8px;}
.load-prog{height:100%;background:linear-gradient(90deg,var(--acc2),var(--acc));border-radius:2px;animation:loadprog 2.2s ease forwards;}
@keyframes loadprog{from{width:0%}to{width:100%}}

/* ===================== RESPONSIVE ===================== */
@media(max-width:1100px){
  .shell{grid-template-columns:280px 1fr 0px;grid-template-areas:"hdr hdr hdr" "left map map";}
  .right-panel{display:none;}
}
@media(max-width:700px){
  .shell{grid-template-columns:0px 1fr 0px;grid-template-areas:"hdr hdr hdr" "map map map";}
  .left-panel{display:none;}
}
</style>
</head>
<body class="theme-rain">

<!-- LOADING SCREEN -->
<div id="loading">
  <div class="load-logo">MetBrasil</div>
  <div class="load-sub">Inteligência Climática · Carregando...</div>
  <div class="load-bar"><div class="load-prog"></div></div>
</div>

<!-- THEME PROGRESS BAR -->
<div id="tbar"><div id="tbar-fill"><div id="tbar-prog"></div></div></div>

<!-- FLASH OVERLAY -->
<div id="flash"></div>

<!-- PARTICLES -->
<canvas id="fx"></canvas>

<!-- MAIN SHELL -->
<div class="shell">

  <!-- ========== HEADER ========== -->
  <header>
    <div class="logo">
      <span class="logo-main">Met<span class="logo-dot">·</span>Brasil</span>
      <span class="logo-sub">metbrasil.com.br · clima em tempo real</span>
    </div>
    <div class="hdr-center">
      <button class="theme-pill on" data-t="rain">&#127783; Chuva</button>
      <button class="theme-pill" data-t="sun">&#9728;&#65039; Verão</button>
      <button class="theme-pill" data-t="cloudy">&#9729;&#65039; Nublado</button>
    </div>
    <div class="hdr-right">
      <div class="utog">
        <button class="ubtn on" id="bC">°C</button>
        <button class="ubtn" id="bF">°F</button>
      </div>
      <span class="live-clk" id="clk">--:--:--</span>
    </div>
  </header>

  <!-- ========== LEFT PANEL ========== -->
  <div class="left-panel">

    <!-- SEARCH -->
    <div class="card" style="padding:12px;">
      <div class="clabel">&#128269; Buscar Cidade ou Estado</div>
      <div class="search-wrap">
        <span class="search-icon">&#128270;</span>
        <input class="search-input" id="searchInput" type="text" placeholder="Ex: Brasília, Manaus, Recife...">
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <!-- CURRENT LOCATION -->
    <div class="card">
      <div class="clabel">&#128205; Sua Localização · IP</div>
      <div class="main-icon"><span id="micon">&#9928;&#65039;</span></div>
      <div class="big-temp" id="mtemp">--<sup>°C</sup></div>
      <div class="city-name" id="mcity"><span class="spin"></span>Detectando...</div>
      <div class="city-desc" id="mdesc">Aguardando dados...</div>
      <div class="metas">
        <div class="meta"><span class="mlabel">Sensação</span><span class="mval" id="mfeel">--°</span></div>
        <div class="meta"><span class="mlabel">Umidade</span><span class="mval" id="mhum">--%</span></div>
        <div class="meta"><span class="mlabel">Vento</span><span class="mval" id="mwind">--</span></div>
        <div class="meta"><span class="mlabel">Pressão</span><span class="mval" id="mpress">--</span></div>
        <div class="meta"><span class="mlabel">Visib.</span><span class="mval" id="mvis">--</span></div>
        <div class="meta"><span class="mlabel">Nuvens</span><span class="mval" id="mclouds">--%</span></div>
      </div>
    </div>

    <!-- CLOCK + COMPASS -->
    <div class="card">
      <div class="clabel">&#128336; Horário · Brasília (UTC-3)</div>
      <div style="font-family:'Bebas Neue';font-size:1.9rem;letter-spacing:4px;color:var(--acc);transition:color var(--tr);" id="bigclk">--:--:--</div>
      <div style="font-family:'DM Mono';font-size:.55rem;opacity:.38;letter-spacing:2px;margin-top:1px;" id="clkdate">---</div>
      <div class="compass-row">
        <div>
          <div style="font-family:'DM Mono';font-size:.52rem;opacity:.35;letter-spacing:2px;margin-bottom:3px;">DIREÇÃO DO VENTO</div>
          <div style="font-family:'DM Mono';font-size:.75rem;color:var(--acc);transition:color var(--tr);" id="windlabel">-- km/h · --</div>
        </div>
        <div class="compass">
          <div class="clbls">
            <span class="cn-n">N</span><span class="cn-s">S</span>
            <span class="cn-e">L</span><span class="cn-w">O</span>
          </div>
          <div class="cneedle" id="cneedle"></div>
          <div class="ccenter"></div>
        </div>
      </div>
    </div>

    <!-- ALERTS -->
    <div class="card">
      <div class="clabel">&#9888;&#65039; Alertas Meteorológicos</div>
      <div class="alert warn"><span class="aicon">&#127783;&#65039;</span><span>Chuvas intensas no Sudeste — acumulados acima de 60mm nas próximas 24h.</span></div>
      <div class="alert heat"><span class="aicon">&#127777;&#65039;</span><span>Onda de calor no Nordeste — máximas de até 40°C esta semana.</span></div>
    </div>

    <!-- HUMIDITY -->
    <div class="card">
      <div class="clabel">&#128167; Umidade Relativa</div>
      <div style="display:flex;gap:12px;align-items:center;margin-top:4px;">
        <div style="font-family:'Bebas Neue';font-size:2.2rem;color:var(--acc);transition:color var(--tr);" id="hpct">--%</div>
        <div style="flex:1;">
          <div class="bartrack"><div class="barfill" id="hbar" style="width:0%"></div></div>
          <div class="mlabel" style="margin-top:4px;" id="hdesc">---</div>
        </div>
      </div>
    </div>

  </div>

  <!-- ========== MAP ========== -->
  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-overlay"></div>
    <div class="map-hint">&#128433;&#65039; CLIQUE NO MAPA · ZOOM · ARRASTE · ESTADOS INTERATIVOS</div>
    <div class="map-badge">MET<span style="opacity:.5">·</span>BRASIL · metbrasil.com.br</div>
  </div>

  <!-- ========== RIGHT PANEL ========== -->
  <div class="right-panel">

    <!-- FORECAST -->
    <div class="card">
      <div class="clabel">&#128197; Previsão 5 Dias</div>
      <div class="fstrip" id="fstrip"></div>
    </div>

    <!-- STATES -->
    <div class="card" style="flex:1;min-height:0;">
      <div class="clabel">&#128506;&#65039; Temperatura por Estado</div>
      <div class="tabs">
        <button class="tbtn on" data-tab="grid">TODOS</button>
        <button class="tbtn" data-tab="sel">DETALHE</button>
      </div>
      <div class="tcont on" id="tc-grid">
        <div class="stgrid" id="stgrid"></div>
      </div>
      <div class="tcont" id="tc-sel">
        <div class="sdet">
          <div>
            <div class="sname" id="sname">–</div>
            <div class="city-desc" id="sdesc" style="margin-top:2px;">Selecione um estado</div>
            <div style="margin-top:10px;">
              <div class="mlabel">UMIDADE</div>
              <div class="bartrack"><div class="barfill" id="shumbar" style="width:0%"></div></div>
              <span style="font-family:'DM Mono';font-size:.58rem;opacity:.45;" id="shumval">--%</span>
            </div>
            <div style="margin-top:8px;">
              <div class="mlabel">ÍNDICE UV</div>
              <div class="uvscale" id="uvs">
                <div class="uvb"></div><div class="uvb"></div><div class="uvb"></div><div class="uvb"></div>
                <div class="uvb"></div><div class="uvb"></div><div class="uvb"></div><div class="uvb"></div>
                <div class="uvb"></div><div class="uvb"></div>
              </div>
            </div>
            <div style="margin-top:8px;">
              <div class="mlabel">VENTO</div>
              <div class="mval" id="swind" style="font-size:.82rem;">--</div>
            </div>
          </div>
          <div style="text-align:right;">
            <div class="stemp" id="stemp">--°</div>
            <div style="font-size:1.8rem;margin-top:4px;" id="sicon">&#127780;&#65039;</div>
            <div class="mlabel" id="sprecip" style="margin-top:4px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAP LEGEND -->
    <div class="card">
      <div class="clabel">&#127777;&#65039; Legenda do Mapa</div>
      <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px;">
        <div style="display:flex;align-items:center;gap:8px;font-family:'DM Mono';font-size:.62rem;opacity:.7;">
          <div style="width:12px;height:12px;border-radius:50%;background:#4fc3f7;flex-shrink:0;"></div>
          <span>Ponto clicável — dados ao vivo</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;font-family:'DM Mono';font-size:.62rem;opacity:.7;">
          <div style="width:12px;height:12px;border-radius:50%;background:#4CAF50;flex-shrink:0;"></div>
          <span>Abaixo de 20°C</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;font-family:'DM Mono';font-size:.62rem;opacity:.7;">
          <div style="width:12px;height:12px;border-radius:50%;background:#FF9800;flex-shrink:0;"></div>
          <span>20°C — 30°C</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;font-family:'DM Mono';font-size:.62rem;opacity:.7;">
          <div style="width:12px;height:12px;border-radius:50%;background:#f44336;flex-shrink:0;"></div>
          <span>Acima de 30°C</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;font-family:'DM Mono';font-size:.62rem;opacity:.7;">
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(79,195,247,.35);border:1px solid rgba(79,195,247,.5);flex-shrink:0;"></div>
          <span>Sua localização (IP)</span>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ===================== JAVASCRIPT ===================== -->
<script>
// ============ STATE DATA ============
const STATES = [
  {code:'AC',name:'Acre',lat:-9.97,lon:-67.81},
  {code:'AL',name:'Alagoas',lat:-9.57,lon:-36.78},
  {code:'AM',name:'Amazonas',lat:-3.07,lon:-60.03},
  {code:'AP',name:'Amapá',lat:0.9,lon:-52.0},
  {code:'BA',name:'Bahia',lat:-12.35,lon:-41.7},
  {code:'CE',name:'Ceará',lat:-3.72,lon:-38.54},
  {code:'DF',name:'Dist. Federal',lat:-15.78,lon:-47.93},
  {code:'ES',name:'Esp. Santo',lat:-19.83,lon:-40.32},
  {code:'GO',name:'Goiás',lat:-15.83,lon:-49.61},
  {code:'MA',name:'Maranhão',lat:-4.97,lon:-45.3},
  {code:'MG',name:'Minas Gerais',lat:-18.1,lon:-44.38},
  {code:'MS',name:'Mato G. Sul',lat:-20.44,lon:-54.65},
  {code:'MT',name:'Mato Grosso',lat:-12.64,lon:-55.42},
  {code:'PA',name:'Pará',lat:-3.79,lon:-52.48},
  {code:'PB',name:'Paraíba',lat:-7.24,lon:-36.78},
  {code:'PE',name:'Pernambuco',lat:-8.38,lon:-38.0},
  {code:'PI',name:'Piauí',lat:-6.6,lon:-42.73},
  {code:'PR',name:'Paraná',lat:-24.89,lon:-51.55},
  {code:'RJ',name:'Rio de Janeiro',lat:-22.84,lon:-43.15},
  {code:'RN',name:'R. G. Norte',lat:-5.74,lon:-36.67},
  {code:'RO',name:'Rondônia',lat:-10.83,lon:-63.34},
  {code:'RR',name:'Roraima',lat:2.0,lon:-61.37},
  {code:'RS',name:'R. G. Sul',lat:-30.03,lon:-51.22},
  {code:'SC',name:'Santa Cat.',lat:-27.59,lon:-48.55},
  {code:'SE',name:'Sergipe',lat:-10.57,lon:-37.38},
  {code:'SP',name:'São Paulo',lat:-23.55,lon:-46.63},
  {code:'TO',name:'Tocantins',lat:-10.17,lon:-48.33},
];

// ============ STATE VARS ============
let cache={}, celsius=true, curTheme='rain', themeIdx=0, autoMode=true, autoTimer;
const THEMES=['rain','sun','cloudy'];
let uLat=null, uLon=null, map=null, userMarker=null;
let stateMarkers=[];

// ============ PARTICLES CANVAS ============
const cv=document.getElementById('fx'), cx=cv.getContext('2d');
let pts=[];
function rcv(){cv.width=innerWidth;cv.height=innerHeight;}
window.addEventListener('resize',rcv);rcv();
class Pt{
  constructor(){this.init();}
  init(){
    this.x=Math.random()*cv.width; this.y=Math.random()*cv.height; this.t=curTheme;
    if(this.t==='rain'){
      this.vx=-1.5-Math.random(); this.vy=9+Math.random()*7;
      this.sz=.8+Math.random()*1.5; this.len=9+Math.random()*12; this.a=.13+Math.random()*.32;
    }else if(this.t==='sun'){
      this.vx=(Math.random()-.5)*.4; this.vy=-.2-Math.random()*.38;
      this.sz=1.2+Math.random()*3.2; this.len=0; this.a=.1+Math.random()*.22;
    }else{
      this.vx=.2+Math.random()*.38; this.vy=(Math.random()-.5)*.12;
      this.sz=28+Math.random()*65; this.len=0; this.a=.02+Math.random()*.035;
    }
  }
}
function ipts(){const n=curTheme==='rain'?120:curTheme==='sun'?50:9;pts=Array.from({length:n},()=>new Pt());}
function loop(){
  cx.clearRect(0,0,cv.width,cv.height);
  for(const p of pts){
    if(p.t!==curTheme){p.t=curTheme;p.init();}
    cx.save();
    if(curTheme==='rain'){
      cx.strokeStyle=`rgba(79,195,247,${p.a})`;cx.lineWidth=p.sz;
      cx.beginPath();cx.moveTo(p.x,p.y);cx.lineTo(p.x+p.vx*2,p.y+p.len);cx.stroke();
    }else if(curTheme==='sun'){
      cx.fillStyle=`rgba(255,232,90,${p.a})`;
      cx.beginPath();cx.arc(p.x,p.y,p.sz,0,Math.PI*2);cx.fill();
    }else{
      cx.fillStyle=`rgba(155,185,215,${p.a})`;
      cx.beginPath();cx.ellipse(p.x,p.y,p.sz*2.2,p.sz,0,0,Math.PI*2);cx.fill();
    }
    cx.restore();
    p.x+=p.vx;p.y+=p.vy;
    if(p.y>cv.height+20){p.y=-20;p.x=Math.random()*cv.width;}
    if(p.x>cv.width+120){p.x=-120;}
    if(p.y<-20){p.y=cv.height+20;}
  }
  requestAnimationFrame(loop);
}
ipts();loop();

// ============ THEME SYSTEM ============
function setTheme(t,manual=false){
  curTheme=t;
  if(manual){autoMode=false;clearInterval(autoTimer);}
  const fl=document.getElementById('flash');
  fl.classList.add('flashing');
  setTimeout(()=>fl.classList.remove('flashing'),380);
  document.body.className='theme-'+t;
  document.querySelectorAll('.theme-pill').forEach(p=>p.classList.toggle('on',p.dataset.t===t));
  const pr=document.getElementById('tbar-prog');
  pr.style.animation='none';pr.offsetHeight;pr.style.animation='';
  ipts();
  // Update map markers color
  if(map) refreshMarkerColors();
  // Update main icon
  const icons={rain:'\u26C8\uFE0F',sun:'\u2600\uFE0F',cloudy:'\u26C5'};
  document.getElementById('micon').textContent=icons[t];
}
function startAuto(){
  clearInterval(autoTimer);
  autoTimer=setInterval(()=>{
    if(!autoMode)return;
    themeIdx=(themeIdx+1)%THEMES.length;
    setTheme(THEMES[themeIdx]);
  },8000);
}
document.querySelectorAll('.theme-pill').forEach(b=>{
  b.addEventListener('click',()=>{
    autoMode=false;clearInterval(autoTimer);
    setTheme(b.dataset.t,true);
    setTimeout(()=>{autoMode=true;startAuto();},24000);
  });
});
startAuto();

// ============ CLOCK ============
function tick(){
  const brt=new Date(new Date().toLocaleString('en',{timeZone:'America/Sao_Paulo'}));
  const t=brt.toTimeString().slice(0,8);
  document.getElementById('clk').textContent=t;
  document.getElementById('bigclk').textContent=t;
  const D=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  const M=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  document.getElementById('clkdate').textContent=`${D[brt.getDay()]} · ${brt.getDate()} ${M[brt.getMonth()]} ${brt.getFullYear()}`;
}
setInterval(tick,1000);tick();

// ============ UNIT TOGGLE ============
document.getElementById('bC').onclick=()=>{celsius=true;document.getElementById('bC').classList.add('on');document.getElementById('bF').classList.remove('on');refreshAll();};
document.getElementById('bF').onclick=()=>{celsius=false;document.getElementById('bF').classList.add('on');document.getElementById('bC').classList.remove('on');refreshAll();};
function toC(c){return celsius?Math.round(c)+'°C':Math.round(c*9/5+32)+'°F';}
function toN(c){return celsius?Math.round(c):Math.round(c*9/5+32);}

// ============ WMO CODES ============
function wmoIcon(c){
  if(c===0)return'\u2600\uFE0F';if(c<=2)return'\u26C5';if(c===3)return'\u2601\uFE0F';
  if(c<=49)return'\uD83C\uDF2B\uFE0F';if(c<=59)return'\uD83C\uDF26\uFE0F';if(c<=69)return'\u2744\uFE0F';
  if(c<=82)return'\uD83C\uDF27\uFE0F';if(c<=94)return'\u26C8\uFE0F';return'\u26C8\uFE0F';
}
function wmoDesc(c){
  if(c===0)return'Céu limpo';if(c<=2)return'Parcialmente nublado';if(c===3)return'Nublado';
  if(c<=49)return'Nevoeiro';if(c<=59)return'Garoa';if(c<=79)return'Neve/Granizo';
  if(c<=82)return'Chuva';if(c<=94)return'Tempestade';return'Tempestade severa';
}

// ============ FETCH WEATHER ============
async function fw(lat,lon){
  const k=`${lat.toFixed(1)},${lon.toFixed(1)}`;
  if(cache[k])return cache[k];
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,surface_pressure,visibility,cloud_cover&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max&timezone=America%2FSao_Paulo&forecast_days=5`);
    const d=await r.json();cache[k]=d;return d;
  }catch(e){return null;}
}

// ============ LEAFLET MAP INIT ============
function initMap(lat,lon){
  // Use CartoDB dark tiles which look great
  map=L.map('map',{
    center:[lat,lon],
    zoom:5,
    zoomControl:true,
    attributionControl:true,
  });

  // Dark/styled tile layer
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains:'abcd',
    maxZoom:18
  }).addTo(map);

  // Click on map to get weather
  map.on('click',async(e)=>{
    const {lat:lt,lng:ln}=e.latlng;
    await showMapPopup(lt,ln,null);
  });

  // Fit Brazil bounds
  map.fitBounds([[-34,-74],[5,-28]]);
}

// ============ TEMP COLOR ============
function tempColor(t){
  if(t===null)return'#9fb8d8';
  if(t<20)return'#4CAF50';
  if(t<30)return'#FF9800';
  return'#f44336';
}

// ============ CREATE MARKER ICON ============
function makeIcon(temp,icon,highlight=false){
  const col=tempColor(temp);
  const sz=highlight?48:42;
  const t=temp!==null?Math.round(temp)+'°':'?°';
  return L.divIcon({
    className:'',
    iconSize:[sz,sz],
    iconAnchor:[sz/2,sz/2],
    popupAnchor:[0,-(sz/2+4)],
    html:`<div style="
      width:${sz}px;height:${sz}px;border-radius:50%;
      background:${col};
      border:2px solid rgba(255,255,255,${highlight?'.85':'.5'});
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow:0 0 ${highlight?16:10}px ${col},0 2px 8px rgba(0,0,0,.5);
      font-family:'Bebas Neue',sans-serif;
      line-height:1;
      cursor:pointer;
      transition:transform .2s;
      ${highlight?'transform:scale(1.1);':''}
    ">
      <span style="font-size:${highlight?'1rem':'.85rem'};color:white;font-weight:700;letter-spacing:.5px;">${t}</span>
      <span style="font-size:${highlight?'.9rem':'.75rem'};margin-top:-2px;">${icon}</span>
    </div>`
  });
}

// ============ USER LOCATION ICON ============
function makeUserIcon(){
  return L.divIcon({
    className:'',
    iconSize:[20,20],
    iconAnchor:[10,10],
    html:`<div class="loc-dot" style="width:18px;height:18px;border-radius:50%;background:var(--acc);border:2.5px solid white;box-shadow:0 0 12px var(--glow),0 2px 6px rgba(0,0,0,.5);animation:locpulse 2s infinite;"></div>`
  });
}

// ============ PLACE STATE MARKERS ============
async function placeStateMarkers(){
  const ps=STATES.map(s=>fw(s.lat,s.lon).then(d=>({s,d})));
  const res=await Promise.all(ps);

  res.forEach(({s,d})=>{
    s._t=d?d.current.temperature_2m:null;
    s._h=d?d.current.relative_humidity_2m:null;
    s._w=d?d.current.wind_speed_10m:null;
    s._wdir=d?d.current.wind_direction_10m:null;
    s._c=d?d.current.weather_code:0;
    s._daily=d?d.daily:null;
    s._prec=d?d.daily.precipitation_probability_max[0]:null;
    s._feel=d?d.current.apparent_temperature:null;
    s._press=d?d.current.surface_pressure:null;

    const icon=makeIcon(s._t,wmoIcon(s._c));
    const marker=L.marker([s.lat,s.lon],{icon}).addTo(map);

    marker.on('click',()=>{
      selState(s);
      showStatePopup(s,marker);
    });
    stateMarkers.push({s,marker});
  });

  // Build state grid
  buildStateGrid(res);
  // Hide loading
  setTimeout(()=>{document.getElementById('loading').classList.add('hide');},400);
}

function refreshMarkerColors(){
  stateMarkers.forEach(({s,marker})=>{
    marker.setIcon(makeIcon(s._t,wmoIcon(s._c)));
  });
  if(userMarker) userMarker.setIcon(makeUserIcon());
}

// ============ MAP POPUP FOR STATE ============
function showStatePopup(s,marker){
  const t=s._t!==null?toC(s._t):'--°';
  const feel=s._feel!==null?toC(s._feel):'--';
  const hum=s._h?s._h+'%':'--';
  const wind=s._w?Math.round(s._w)+' km/h':'--';
  const html=`
    <div class="pop-content">
      <div class="pop-title">${s.name}</div>
      <div style="display:flex;align-items:baseline;gap:8px;">
        <div class="pop-temp">${toN(s._t||0)}</div>
        <div style="font-size:.9rem;opacity:.6;">${celsius?'°C':'°F'}</div>
        <div style="font-size:1.6rem;margin-left:4px;">${wmoIcon(s._c)}</div>
      </div>
      <div class="pop-desc">${wmoDesc(s._c)}</div>
      <div class="pop-meta">
        <div class="pop-m"><span class="pop-ml">Sensação</span><span class="pop-mv">${feel}</span></div>
        <div class="pop-m"><span class="pop-ml">Umidade</span><span class="pop-mv">${hum}</span></div>
        <div class="pop-m"><span class="pop-ml">Vento</span><span class="pop-mv">${wind}</span></div>
        <div class="pop-m"><span class="pop-ml">Chuva</span><span class="pop-mv">${s._prec!==null?s._prec+'%':'--'}</span></div>
      </div>
    </div>`;
  marker.bindPopup(html,{maxWidth:240}).openPopup();
}

// ============ CLICK ON EMPTY MAP ============
async function showMapPopup(lat,lon,name){
  const d=await fw(lat,lon);
  if(!d)return;
  const c=d.current;
  const tmpMk=L.marker([lat,lon],{icon:makeIcon(c.temperature_2m,wmoIcon(c.weather_code),true)}).addTo(map);
  const html=`
    <div class="pop-content">
      <div class="pop-title">${name||'\uD83D\uDCCD '+lat.toFixed(2)+', '+lon.toFixed(2)}</div>
      <div style="display:flex;align-items:baseline;gap:8px;">
        <div class="pop-temp">${toN(c.temperature_2m)}</div>
        <div style="font-size:.9rem;opacity:.6;">${celsius?'°C':'°F'}</div>
        <div style="font-size:1.6rem;margin-left:4px;">${wmoIcon(c.weather_code)}</div>
      </div>
      <div class="pop-desc">${wmoDesc(c.weather_code)}</div>
      <div class="pop-meta">
        <div class="pop-m"><span class="pop-ml">Sensação</span><span class="pop-mv">${toC(c.apparent_temperature)}</span></div>
        <div class="pop-m"><span class="pop-ml">Umidade</span><span class="pop-mv">${c.relative_humidity_2m}%</span></div>
        <div class="pop-m"><span class="pop-ml">Vento</span><span class="pop-mv">${Math.round(c.wind_speed_10m)} km/h</span></div>
        <div class="pop-m"><span class="pop-ml">Pressão</span><span class="pop-mv">${Math.round(c.surface_pressure)} hPa</span></div>
      </div>
    </div>`;
  tmpMk.bindPopup(html,{maxWidth:240}).openPopup();
  tmpMk.on('popupclose',()=>map.removeLayer(tmpMk));
}

// ============ LOAD MAIN LOCATION ============
async function loadMain(lat,lon,city){
  const d=await fw(lat,lon);if(!d)return;
  const c=d.current;
  document.getElementById('mcity').textContent=city;
  document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'°C':'°F')+'</sup>';
  document.getElementById('mdesc').textContent=wmoDesc(c.weather_code);
  document.getElementById('micon').textContent=wmoIcon(c.weather_code);
  document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
  document.getElementById('mhum').textContent=c.relative_humidity_2m+'%';
  document.getElementById('mwind').textContent=Math.round(c.wind_speed_10m)+' km/h';
  document.getElementById('mpress').textContent=Math.round(c.surface_pressure)+' hPa';
  document.getElementById('mvis').textContent=c.visibility?(c.visibility/1000).toFixed(1)+' km':'--';
  document.getElementById('mclouds').textContent=c.cloud_cover+'%';
  document.getElementById('cneedle').style.setProperty('--wd',c.wind_direction_10m+'deg');
  document.getElementById('windlabel').textContent=Math.round(c.wind_speed_10m)+' km/h · '+windDir(c.wind_direction_10m);
  document.getElementById('hpct').textContent=c.relative_humidity_2m+'%';
  document.getElementById('hbar').style.width=c.relative_humidity_2m+'%';
  const h=c.relative_humidity_2m;
  document.getElementById('hdesc').textContent=h<30?'Baixa — hidrate-se!':h<60?'Confortável':'Alta — tempo abafado';
  renderFcast(d.daily);

  // User pin on map
  if(userMarker)map.removeLayer(userMarker);
  userMarker=L.marker([lat,lon],{icon:makeUserIcon(),zIndexOffset:1000}).addTo(map);
  const html=`
    <div class="pop-content">
      <div class="pop-title">\uD83D\uDCCD ${city}</div>
      <div style="display:flex;align-items:baseline;gap:8px;">
        <div class="pop-temp">${toN(c.temperature_2m)}</div>
        <div style="font-size:.9rem;opacity:.6;">${celsius?'°C':'°F'}</div>
        <div style="font-size:1.6rem;margin-left:4px;">${wmoIcon(c.weather_code)}</div>
      </div>
      <div class="pop-desc">${wmoDesc(c.weather_code)} · Sua localização</div>
    </div>`;
  userMarker.bindPopup(html,{maxWidth:220});
}

function windDir(deg){
  const dirs=['N','NNE','NE','ENE','L','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];
  return dirs[Math.round(deg/22.5)%16];
}

// ============ FORECAST ============
function renderFcast(daily){
  const D=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  const s=document.getElementById('fstrip');s.innerHTML='';
  for(let i=0;i<5;i++){
    const dt=new Date(daily.time[i]);
    const el=document.createElement('div');
    el.className='fday'+(i===0?' on':'');
    el.innerHTML=`<span class="flbl">${i===0?'HOJE':D[dt.getDay()]}</span>
      <span class="ficon">${wmoIcon(daily.weather_code[i])}</span>
      <span class="ftemp">${toN(daily.temperature_2m_max[i])}°</span>
      <span class="flbl" style="opacity:.3;">${toN(daily.temperature_2m_min[i])}°</span>
      <span class="flbl">${daily.precipitation_probability_max[i]}%\uD83D\uDCA7</span>`;
    el.onclick=()=>{document.querySelectorAll('.fday').forEach(f=>f.classList.remove('on'));el.classList.add('on');}
    s.appendChild(el);
  }
}

// ============ STATE GRID ============
function buildStateGrid(res){
  const g=document.getElementById('stgrid');g.innerHTML='';
  res.forEach(({s})=>{
    const btn=document.createElement('button');
    btn.className='stbtn';btn.id='sb-'+s.code;
    btn.innerHTML=wmoIcon(s._c)+'<br><b>'+s.code+'</b><br>'+(s._t!==null?toN(s._t)+'°':'?');
    btn.title=s.name;
    btn.onclick=()=>{
      selState(s);
      const m=stateMarkers.find(x=>x.s.code===s.code);
      if(m){map.setView([s.lat,s.lon],7,{animate:true});showStatePopup(s,m.marker);}
    };
    g.appendChild(btn);
  });
}

function selState(s){
  document.querySelectorAll('.stbtn').forEach(b=>b.classList.remove('on'));
  const btn=document.getElementById('sb-'+s.code);if(btn)btn.classList.add('on');
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('on'));
  document.querySelectorAll('.tcont').forEach(c=>c.classList.remove('on'));
  document.querySelector('[data-tab="sel"]').classList.add('on');
  document.getElementById('tc-sel').classList.add('on');
  document.getElementById('sname').textContent=s.name;
  document.getElementById('sdesc').textContent=wmoDesc(s._c);
  document.getElementById('stemp').textContent=s._t!==null?toC(s._t):'--°';
  document.getElementById('sicon').textContent=wmoIcon(s._c);
  const h=s._h||0;
  document.getElementById('shumbar').style.width=h+'%';
  document.getElementById('shumval').textContent=h+'%';
  document.getElementById('swind').textContent=s._w?Math.round(s._w)+' km/h':'--';
  document.getElementById('sprecip').textContent=s._prec!==null?s._prec+'% chuva hoje':'';
  const uv=Math.floor(Math.random()*10)+1;
  document.querySelectorAll('.uvb').forEach((b,i)=>b.classList.toggle('on',i<uv));
  if(s._daily)renderFcast(s._daily);
}

// ============ TABS ============
document.querySelectorAll('.tbtn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tbtn').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tcont').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById('tc-'+b.dataset.tab).classList.add('on');
  };
});

// ============ SEARCH ============
const CITY_SUGGESTIONS=[
  {name:'Brasília, DF',lat:-15.78,lon:-47.93},
  {name:'São Paulo, SP',lat:-23.55,lon:-46.63},
  {name:'Rio de Janeiro, RJ',lat:-22.90,lon:-43.17},
  {name:'Salvador, BA',lat:-12.97,lon:-38.50},
  {name:'Fortaleza, CE',lat:-3.72,lon:-38.54},
  {name:'Manaus, AM',lat:-3.10,lon:-60.02},
  {name:'Belém, PA',lat:-1.45,lon:-48.50},
  {name:'Recife, PE',lat:-8.05,lon:-34.92},
  {name:'Porto Alegre, RS',lat:-30.03,lon:-51.22},
  {name:'Curitiba, PR',lat:-25.43,lon:-49.27},
  {name:'Belo Horizonte, MG',lat:-19.92,lon:-43.94},
  {name:'Natal, RN',lat:-5.79,lon:-35.21},
  {name:'Maceió, AL',lat:-9.67,lon:-35.73},
  {name:'João Pessoa, PB',lat:-7.12,lon:-34.86},
  {name:'Goiânia, GO',lat:-16.68,lon:-49.25},
  {name:'Florianópolis, SC',lat:-27.59,lon:-48.55},
  {name:'Teresina, PI',lat:-5.09,lon:-42.80},
  {name:'Campo Grande, MS',lat:-20.44,lon:-54.65},
  {name:'Porto Velho, RO',lat:-8.76,lon:-63.90},
  {name:'Boa Vista, RR',lat:2.82,lon:-60.67},
  {name:'Macapá, AP',lat:0.03,lon:-51.07},
  {name:'Rio Branco, AC',lat:-9.97,lon:-67.81},
  {name:'Palmas, TO',lat:-10.17,lon:-48.33},
  {name:'Vitória, ES',lat:-20.32,lon:-40.34},
  {name:'Aracaju, SE',lat:-10.91,lon:-37.07},
  {name:'São Luís, MA',lat:-2.53,lon:-44.30},
  {name:'Cuiabá, MT',lat:-15.60,lon:-56.10},
];

const sinput=document.getElementById('searchInput');
const sresults=document.getElementById('searchResults');
sinput.addEventListener('input',()=>{
  const q=sinput.value.toLowerCase().trim();
  if(q.length<2){sresults.classList.remove('show');return;}
  const matches=CITY_SUGGESTIONS.filter(c=>c.name.toLowerCase().includes(q)).slice(0,6);
  if(!matches.length){sresults.classList.remove('show');return;}
  sresults.innerHTML=matches.map(c=>`<div class="search-item" data-lat="${c.lat}" data-lon="${c.lon}" data-name="${c.name}">${c.name}</div>`).join('');
  sresults.classList.add('show');
  sresults.querySelectorAll('.search-item').forEach(el=>{
    el.addEventListener('click',async()=>{
      const lt=parseFloat(el.dataset.lat),ln=parseFloat(el.dataset.lon),nm=el.dataset.name;
      sinput.value=nm;
      sresults.classList.remove('show');
      map.setView([lt,ln],10,{animate:true});
      await showMapPopup(lt,ln,nm);
      // Also update main card
      await loadMain(lt,ln,nm);
    });
  });
});
document.addEventListener('click',e=>{if(!e.target.closest('.search-wrap'))sresults.classList.remove('show');});

// ============ REFRESH ALL ON UNIT CHANGE ============
function refreshAll(){
  if(uLat){
    const k=`${uLat.toFixed(1)},${uLon.toFixed(1)}`;
    if(cache[k]){
      const c=cache[k].current;
      document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'°C':'°F')+'</sup>';
      document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
      renderFcast(cache[k].daily);
    }
  }
  STATES.forEach(s=>{
    const btn=document.getElementById('sb-'+s.code);
    if(btn&&s._t!==null) btn.innerHTML=wmoIcon(s._c)+'<br><b>'+s.code+'</b><br>'+toN(s._t)+'°';
  });
  const sn=document.getElementById('sname').textContent;
  const ss=STATES.find(x=>x.name===sn);
  if(ss&&ss._t!==null) document.getElementById('stemp').textContent=toC(ss._t);
  refreshMarkerColors();
}

// ============ INIT ============
async function init(){
  // Init map centered on Brazil first
  initMap(-14,-52);

  // Get user location
  try{
    const r=await fetch('https://ipapi.co/json/');
    const d=await r.json();
    uLat=parseFloat(d.latitude);uLon=parseFloat(d.longitude);
    const city=d.city+', '+d.region_code;
    await loadMain(uLat,uLon,city);
  }catch(e){
    uLat=-23.55;uLon=-46.63;
    await loadMain(uLat,uLon,'São Paulo, SP');
  }

  // Place all state markers (this also hides loading when done)
  await placeStateMarkers();
}

init();
</script>
</body>
</html>
