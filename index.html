<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetBrasil · Inteligência Climática para Esportes</title>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
/* ===================== RESET & ROOT ===================== */
:root{--tr:1.2s;--sport-color:#0097a7;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{font-family:'Syne',sans-serif;transition:background var(--tr);}

/* ===================== THEMES ===================== */
.theme-rain{
  --bg1:#030d1c;--bg2:#071828;--acc:#4fc3f7;--acc2:#0288d1;
  --txt:#e0f7fa;--card:rgba(5,24,52,0.92);--bdr:rgba(79,195,247,.22);
  --glow:rgba(79,195,247,.55);--shine:rgba(79,195,247,.07);
  --map-filter:hue-rotate(200deg) saturate(1.2) brightness(0.55);
  --map-overlay:rgba(4,16,31,0.45);
}
.theme-sun{
  --bg1:#a83200;--bg2:#d45500;--acc:#ffe566;--acc2:#ff9900;
  --txt:#1a0400;--card:rgba(255,240,190,0.92);--bdr:rgba(255,195,0,.38);
  --glow:rgba(255,225,70,.75);--shine:rgba(255,255,200,.10);
  --map-filter:hue-rotate(25deg) saturate(1.4) brightness(0.75);
  --map-overlay:rgba(180,60,0,0.30);
}
.theme-cloudy{
  --bg1:#141e2c;--bg2:#1e2d40;--acc:#a0bcd8;--acc2:#6888a4;
  --txt:#dde8f5;--card:rgba(22,34,50,0.92);--bdr:rgba(155,190,220,.22);
  --glow:rgba(155,190,220,.45);--shine:rgba(255,255,255,.04);
  --map-filter:grayscale(0.5) brightness(0.5) saturate(0.7);
  --map-overlay:rgba(18,28,42,0.45);
}
body{background:linear-gradient(145deg,var(--bg1),var(--bg2));color:var(--txt);}

/* ===================== SPORT MODES ===================== */
.mode-surf{--sport-color:#0097a7;}
.mode-kite{--sport-color:#7c4dff;}
.mode-wind{--sport-color:#00897b;}
.mode-para{--sport-color:#f57c00;}
.mode-sail{--sport-color:#1565c0;}
.mode-fish{--sport-color:#558b2f;}

/* ===================== PARTICLES CANVAS ===================== */
#fx{position:fixed;inset:0;pointer-events:none;z-index:1;}

/* ===================== THEME PROGRESS BAR ===================== */
#tbar{position:fixed;top:0;left:0;right:0;height:3px;z-index:300;overflow:hidden;}
#tbar-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));transition:background var(--tr);}
#tbar-prog{height:100%;background:rgba(255,255,255,.55);width:0%;animation:tprog 8s linear infinite;}
@keyframes tprog{from{width:0%}to{width:100%}}

/* ===================== FLASH OVERLAY ===================== */
#flash{position:fixed;inset:0;pointer-events:none;z-index:998;opacity:0;background:var(--bg1);transition:opacity .35s;}
.flashing{opacity:.32!important;}

/* ===================== LAYOUT SHELL ===================== */
.shell{
  position:relative;z-index:2;
  width:100vw;height:100vh;
  display:grid;
  grid-template-rows:52px 38px 1fr;
  grid-template-columns:330px 1fr 280px;
  grid-template-areas:
    "hdr hdr hdr"
    "sport sport sport"
    "left map right";
}

/* ===================== HEADER ===================== */
header{
  grid-area:hdr;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;
  background:var(--card);
  border-bottom:1px solid var(--bdr);
  backdrop-filter:blur(24px);
  transition:background var(--tr),border-color var(--tr);
  z-index:50;
}
.logo{display:flex;align-items:baseline;gap:8px;}
.logo-main{
  font-family:'Bebas Neue';font-size:1.7rem;letter-spacing:4px;
  color:var(--acc);text-shadow:0 0 18px var(--glow);
  transition:color var(--tr),text-shadow var(--tr);
}
.logo-dot{color:var(--acc2);transition:color var(--tr);}
.logo-sub{font-family:'DM Mono';font-size:.5rem;letter-spacing:4px;opacity:.4;text-transform:uppercase;}
.hdr-center{display:flex;align-items:center;gap:6px;}
.theme-pill{
  padding:4px 10px;border-radius:16px;border:1px solid var(--bdr);
  background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.58rem;
  cursor:pointer;opacity:.42;transition:all .25s,border-color var(--tr);
}
.theme-pill.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);opacity:1;font-weight:700;}
.theme-pill:hover:not(.on){opacity:.72;border-color:var(--acc);}
.hdr-right{display:flex;align-items:center;gap:8px;}
.utog{display:flex;border:1px solid var(--bdr);border-radius:6px;overflow:hidden;transition:border-color var(--tr);}
.ubtn{padding:3px 8px;background:transparent;border:none;color:var(--txt);font-family:'DM Mono';font-size:.62rem;cursor:pointer;opacity:.42;transition:all .2s;}
.ubtn.on{background:var(--acc);color:var(--bg1);opacity:1;font-weight:700;}
.live-clk{font-family:'DM Mono';font-size:.68rem;opacity:.55;letter-spacing:2px;}

/* ===================== SPORT BAR ===================== */
.sport-bar{
  grid-area:sport;
  display:flex;align-items:center;justify-content:center;gap:4px;
  padding:0 20px;
  background:rgba(0,0,0,.25);
  border-bottom:1px solid var(--bdr);
  transition:border-color var(--tr);
}
.sport-btn{
  display:flex;align-items:center;gap:5px;
  padding:6px 14px;border-radius:20px;border:1px solid transparent;
  background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.6rem;
  cursor:pointer;opacity:.5;transition:all .2s;text-transform:uppercase;letter-spacing:1px;
}
.sport-btn:hover{opacity:.8;border-color:var(--bdr);}
.sport-btn.on{
  background:var(--sport-color);color:#fff;opacity:1;
  border-color:var(--sport-color);box-shadow:0 0 12px var(--sport-color);
}
.sport-btn .sicon{font-size:.9rem;}

/* ===================== LEFT PANEL ===================== */
.left-panel{
  grid-area:left;
  display:flex;flex-direction:column;gap:8px;
  padding:10px 8px 10px 12px;
  overflow-y:auto;
  background:transparent;
}
.left-panel::-webkit-scrollbar{width:3px;}
.left-panel::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px;}

/* ===================== RIGHT PANEL ===================== */
.right-panel{
  grid-area:right;
  display:flex;flex-direction:column;gap:8px;
  padding:10px 12px 10px 8px;
  overflow-y:auto;
  background:transparent;
}
.right-panel::-webkit-scrollbar{width:3px;}
.right-panel::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px;}

/* ===================== MAP AREA ===================== */
.map-wrap{
  grid-area:map;
  position:relative;
  overflow:hidden;
}
#map{width:100%;height:100%;filter:var(--map-filter);transition:filter var(--tr);}
.map-overlay{position:absolute;inset:0;background:var(--map-overlay);pointer-events:none;z-index:400;transition:background var(--tr);}
.map-badge{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--bdr);border-radius:20px;
  padding:5px 14px;font-family:'DM Mono';font-size:.55rem;letter-spacing:2px;opacity:.7;
  z-index:500;pointer-events:none;backdrop-filter:blur(12px);transition:background var(--tr),border-color var(--tr);
}
.map-hint{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--bdr);border-radius:16px;
  padding:4px 12px;font-family:'DM Mono';font-size:.52rem;letter-spacing:2px;opacity:.6;
  z-index:500;pointer-events:none;backdrop-filter:blur(12px);white-space:nowrap;transition:background var(--tr),border-color var(--tr);
}

/* ===================== CARDS ===================== */
.card{
  background:var(--card);
  border:1px solid var(--bdr);
  border-radius:14px;
  padding:12px;
  backdrop-filter:blur(22px);
  transition:background var(--tr),border-color var(--tr),box-shadow .2s;
  box-shadow:0 4px 20px rgba(0,0,0,.35),inset 0 1px 0 var(--shine);
  flex-shrink:0;
}
.card:hover{box-shadow:0 6px 28px rgba(0,0,0,.45),0 0 0 1px var(--bdr),inset 0 1px 0 var(--shine);}
.clabel{
  font-family:'DM Mono';font-size:.5rem;letter-spacing:2px;text-transform:uppercase;
  color:var(--acc);margin-bottom:6px;opacity:.7;transition:color var(--tr);
}

/* ===================== CONDITION CARD ===================== */
.cond-badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 12px;border-radius:20px;
  font-family:'Bebas Neue';font-size:1.1rem;letter-spacing:2px;
  color:#fff;margin-bottom:8px;
}
.cond-epic{background:linear-gradient(135deg,#00c853,#00e676);}
.cond-good{background:linear-gradient(135deg,#2196f3,#03a9f4);}
.cond-fair{background:linear-gradient(135deg,#ff9800,#ffc107);}
.cond-poor{background:linear-gradient(135deg,#f44336,#e91e63);}
.cond-flat{background:linear-gradient(135deg,#607d8b,#90a4ae);}
.stars{font-size:.9rem;letter-spacing:1px;}

/* ===================== WEATHER DISPLAY ===================== */
.main-icon{text-align:center;font-size:48px;padding:4px 0;filter:drop-shadow(0 0 12px var(--glow));transition:filter var(--tr);}
.main-icon span{display:inline-block;animation:bob 3.5s ease-in-out infinite;}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.big-temp{
  font-family:'Bebas Neue';font-size:4.5rem;line-height:1;
  color:var(--acc);text-shadow:0 0 25px var(--glow);
  transition:color var(--tr),text-shadow var(--tr);
}
.big-temp sup{font-size:1.5rem;vertical-align:top;margin-top:8px;display:inline-block;}
.city-name{font-size:.9rem;font-weight:700;margin-top:2px;}
.city-desc{font-family:'DM Mono';font-size:.65rem;opacity:.55;margin-top:2px;}

/* ===================== WIND ROSE ===================== */
.wind-rose{
  width:90px;height:90px;border-radius:50%;
  border:2px solid var(--bdr);
  position:relative;margin:8px auto;
  transition:border-color var(--tr);
}
.wr-labels{position:absolute;inset:0;font-family:'DM Mono';font-size:.4rem;opacity:.5;}
.wr-labels span{position:absolute;line-height:1;}
.wr-n{top:4px;left:50%;transform:translateX(-50%);}
.wr-s{bottom:4px;left:50%;transform:translateX(-50%);}
.wr-e{right:4px;top:50%;transform:translateY(-50%);}
.wr-w{left:4px;top:50%;transform:translateY(-50%);}
.wr-ne{top:12px;right:12px;}.wr-nw{top:12px;left:12px;}
.wr-se{bottom:12px;right:12px;}.wr-sw{bottom:12px;left:12px;}
.wr-needle{
  position:absolute;width:4px;height:36px;
  background:linear-gradient(to bottom,var(--sport-color) 60%,transparent);
  left:50%;top:9px;transform:translateX(-50%) rotate(var(--wd,0deg));
  transform-origin:bottom center;border-radius:2px;
  transition:transform 1.5s ease,background var(--tr);
}
.wr-center{
  position:absolute;width:10px;height:10px;border-radius:50%;
  background:var(--sport-color);left:50%;top:50%;transform:translate(-50%,-50%);
  transition:background var(--tr);
}
.wr-info{text-align:center;margin-top:6px;}
.wr-speed{font-family:'Bebas Neue';font-size:1.6rem;color:var(--acc);transition:color var(--tr);}
.wr-dir{font-family:'DM Mono';font-size:.6rem;opacity:.6;}
.wr-beaufort{font-family:'DM Mono';font-size:.5rem;opacity:.45;margin-top:2px;}

/* ===================== KITE RATING BAR ===================== */
.kite-bar{margin-top:8px;}
.kite-track{height:8px;background:rgba(255,255,255,.08);border-radius:4px;overflow:hidden;position:relative;}
.kite-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#4CAF50,#8BC34A,#FFEB3B,#FF9800,#f44336);transition:width .5s ease;}
.kite-label{display:flex;justify-content:space-between;margin-top:3px;font-family:'DM Mono';font-size:.48rem;opacity:.5;}

/* ===================== HOURLY STRIP ===================== */
.hour-strip{display:flex;gap:3px;overflow-x:auto;padding:4px 0;}
.hour-strip::-webkit-scrollbar{height:2px;}
.hour-strip::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px;}
.hour-item{
  flex-shrink:0;width:42px;padding:6px 2px;
  border-radius:8px;border:1px solid var(--bdr);
  text-align:center;font-family:'DM Mono';font-size:.5rem;
  transition:background .15s,border-color var(--tr);cursor:pointer;
}
.hour-item:hover{background:rgba(255,255,255,.06);}
.hour-item.peak{border-color:var(--sport-color);background:rgba(var(--sport-color),.1);}
.hour-item .htime{opacity:.5;margin-bottom:2px;}
.hour-item .hicon{font-size:.85rem;}
.hour-item .htemp{font-weight:700;color:var(--acc);transition:color var(--tr);}
.hour-item .hwind{opacity:.6;font-size:.45rem;}

/* ===================== WIND TABLE (Windguru style) ===================== */
.wind-table{width:100%;border-collapse:collapse;font-family:'DM Mono';font-size:.5rem;}
.wind-table th,.wind-table td{padding:4px 2px;text-align:center;border:1px solid var(--bdr);transition:border-color var(--tr);}
.wind-table th{background:rgba(0,0,0,.2);font-weight:500;opacity:.6;text-transform:uppercase;letter-spacing:1px;}
.wind-table .wt-icon{font-size:.8rem;}
.wind-table .wt-temp{color:var(--acc);font-weight:700;transition:color var(--tr);}
.wind-table .wt-wind{font-weight:600;}
.wind-table .wt-gust{opacity:.6;font-size:.45rem;}
.wind-table .wt-dir{opacity:.7;}
.wind-table .wt-precip{color:#4fc3f7;}

/* ===================== STATE GRID ===================== */
.stgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;max-height:160px;overflow-y:auto;padding-right:2px;}
.stgrid::-webkit-scrollbar{width:2px;}
.stgrid::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px;}
.stbtn{padding:5px 2px;border-radius:6px;border:1px solid var(--bdr);background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.5rem;cursor:pointer;text-align:center;opacity:.5;transition:all .15s,border-color var(--tr);}
.stbtn:hover{background:rgba(255,255,255,.07);border-color:var(--acc);opacity:1;}
.stbtn.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);opacity:1;font-weight:700;}

/* ===================== SPOTS GRID ===================== */
.spots-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:3px;max-height:120px;overflow-y:auto;}
.spot-btn{
  padding:6px 4px;border-radius:6px;border:1px solid var(--bdr);
  background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.48rem;
  cursor:pointer;text-align:left;opacity:.6;transition:all .15s;
  display:flex;align-items:center;gap:4px;
}
.spot-btn:hover{background:rgba(255,255,255,.06);opacity:1;border-color:var(--sport-color);}
.spot-btn .spot-icon{font-size:.7rem;}
.spot-btn .spot-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ===================== TABS ===================== */
.tabs{display:flex;gap:2px;padding:2px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:8px;}
.tbtn{flex:1;padding:5px;border:none;background:transparent;color:var(--txt);font-family:'DM Mono';font-size:.5rem;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:6px;opacity:.4;transition:all .18s;}
.tbtn.on{background:var(--card);border:1px solid var(--bdr);opacity:1;color:var(--acc);}
.tcont{display:none;}
.tcont.on{display:block;}

/* ===================== METAS GRID ===================== */
.metas{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--bdr);transition:border-color var(--tr);}
.meta{display:flex;flex-direction:column;gap:1px;}
.mlabel{font-family:'DM Mono';font-size:.45rem;letter-spacing:2px;text-transform:uppercase;opacity:.35;}
.mval{font-size:.8rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== SEARCH ===================== */
.search-wrap{position:relative;}
.search-input{
  width:100%;padding:8px 12px 8px 32px;
  background:var(--card);border:1px solid var(--bdr);border-radius:8px;
  color:var(--txt);font-family:'DM Mono';font-size:.65rem;
  outline:none;transition:all .2s,background var(--tr),border-color var(--tr);
}
.search-input:focus{border-color:var(--acc);box-shadow:0 0 0 2px var(--glow);}
.search-input::placeholder{opacity:.35;}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.35;font-size:.75rem;pointer-events:none;}
.search-results{
  position:absolute;top:calc(100% + 4px);left:0;right:0;z-index:600;
  background:var(--card);border:1px solid var(--bdr);border-radius:8px;
  backdrop-filter:blur(20px);overflow:hidden;display:none;
  transition:background var(--tr),border-color var(--tr);
}
.search-results.show{display:block;}
.search-item{padding:6px 10px;font-family:'DM Mono';font-size:.6rem;cursor:pointer;opacity:.75;transition:background .1s;}
.search-item:hover{background:rgba(255,255,255,.08);opacity:1;}

/* ===================== MAP POPUP ===================== */
.leaflet-popup-content-wrapper{
  background:var(--card)!important;border:1px solid var(--bdr)!important;
  border-radius:12px!important;backdrop-filter:blur(20px);
  box-shadow:0 8px 32px rgba(0,0,0,.5)!important;
  color:var(--txt)!important;font-family:'Syne',sans-serif!important;
}
.leaflet-popup-tip{background:var(--card)!important;}
.leaflet-popup-close-button{color:var(--acc)!important;font-size:1rem!important;}
.pop-content{min-width:160px;padding:4px;}
.pop-title{font-family:'Bebas Neue';font-size:1.2rem;letter-spacing:2px;color:var(--acc);transition:color var(--tr);}
.pop-temp{font-family:'Bebas Neue';font-size:2.4rem;line-height:1;color:var(--acc);transition:color var(--tr);}
.pop-desc{font-family:'DM Mono';font-size:.6rem;opacity:.6;margin-top:2px;}
.pop-meta{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:8px;padding-top:8px;border-top:1px solid var(--bdr);}
.pop-m{display:flex;flex-direction:column;}
.pop-ml{font-family:'DM Mono';font-size:.45rem;letter-spacing:1px;opacity:.35;text-transform:uppercase;}
.pop-mv{font-size:.75rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== SPINNER & LOADING ===================== */
.spin{display:inline-block;width:12px;height:12px;border:2px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:sp .7s linear infinite;vertical-align:middle;margin-right:4px;}
@keyframes sp{to{transform:rotate(360deg)}}
@keyframes locpulse{0%{box-shadow:0 0 0 0 var(--glow);}70%{box-shadow:0 0 0 10px rgba(0,0,0,0);}100%{box-shadow:0 0 0 0 rgba(0,0,0,0);}}
.loc-dot{width:14px;height:14px;border-radius:50%;background:var(--acc);border:2px solid white;animation:locpulse 2s infinite;}
#loading{
  position:fixed;inset:0;z-index:9999;background:var(--bg1);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;transition:opacity .5s;
}
#loading.hide{opacity:0;pointer-events:none;}
.load-logo{font-family:'Bebas Neue';font-size:3rem;letter-spacing:6px;color:var(--acc);text-shadow:0 0 25px var(--glow);}
.load-sub{font-family:'DM Mono';font-size:.55rem;letter-spacing:4px;opacity:.4;text-transform:uppercase;}
.load-bar{width:180px;height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin-top:6px;}
.load-prog{height:100%;background:linear-gradient(90deg,var(--acc2),var(--acc));border-radius:2px;animation:loadprog 2s ease forwards;}
@keyframes loadprog{from{width:0%}to{width:100%}}

/* ===================== SCROLLBAR ===================== */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px;}

/* ===================== RESPONSIVE ===================== */
@media(max-width:1100px){
  .shell{grid-template-columns:280px 1fr 0px;grid-template-areas:"hdr hdr hdr" "sport sport sport" "left map map";}
  .right-panel{display:none;}
}
@media(max-width:680px){
  .shell{grid-template-columns:0px 1fr 0px;grid-template-areas:"hdr hdr hdr" "sport sport sport" "map map map";}
  .left-panel{display:none;}
  .sport-bar{overflow-x:auto;justify-content:flex-start;}
}
</style>
</head>
<body class="theme-rain mode-surf">

<!-- LOADING -->
<div id="loading">
  <div class="load-logo">MetBrasil</div>
  <div class="load-sub">Inteligência Climática · Carregando...</div>
  <div class="load-bar"><div class="load-prog"></div></div>
</div>

<!-- THEME BAR -->
<div id="tbar"><div id="tbar-fill"><div id="tbar-prog"></div></div></div>

<!-- FLASH -->
<div id="flash"></div>

<!-- PARTICLES -->
<canvas id="fx"></canvas>

<!-- SHELL -->
<div class="shell">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <span class="logo-main">Met<span class="logo-dot">·</span>Brasil</span>
      <span class="logo-sub">metbrasil.com.br</span>
    </div>
    <div class="hdr-center">
      <button class="theme-pill on" data-t="rain">&#127783; Chuva</button>
      <button class="theme-pill" data-t="sun">&#9728;&#65039; Sol</button>
      <button class="theme-pill" data-t="cloudy">&#9729;&#65039; Nublado</button>
    </div>
    <div class="hdr-right">
      <div class="utog">
        <button class="ubtn on" id="bC">°C</button>
        <button class="ubtn" id="bF">°F</button>
      </div>
      <div class="utog">
        <button class="ubtn on" id="bKmh">km/h</button>
        <button class="ubtn" id="bKt">nós</button>
      </div>
      <span class="live-clk" id="clk">--:--</span>
    </div>
  </header>

  <!-- SPORT BAR -->
  <div class="sport-bar">
    <button class="sport-btn on" data-sport="surf"><span class="sicon">&#127940;</span>Surf</button>
    <button class="sport-btn" data-sport="kite"><span class="sicon">&#129667;</span>Kite</button>
    <button class="sport-btn" data-sport="wind"><span class="sicon">&#127940;</span>Windsurf</button>
    <button class="sport-btn" data-sport="para"><span class="sicon">&#129666;</span>Parapente</button>
    <button class="sport-btn" data-sport="sail"><span class="sicon">&#9973;</span>Vela</button>
    <button class="sport-btn" data-sport="fish"><span class="sicon">&#127907;</span>Pesca</button>
  </div>

  <!-- LEFT PANEL -->
  <div class="left-panel">

    <!-- SEARCH -->
    <div class="card" style="padding:10px;">
      <div class="search-wrap">
        <span class="search-icon">&#128269;</span>
        <input class="search-input" id="searchInput" type="text" placeholder="Buscar cidade ou spot...">
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <!-- CONDITION -->
    <div class="card">
      <div class="clabel">&#127919; Condição Atual</div>
      <div id="condBadge" class="cond-badge cond-good">BOM <span class="stars">&#9733;&#9733;&#9733;&#9733;&#9734;</span></div>
      <div class="main-icon"><span id="micon">&#9928;&#65039;</span></div>
      <div class="big-temp" id="mtemp">--<sup>°C</sup></div>
      <div class="city-name" id="mcity"><span class="spin"></span>Detectando...</div>
      <div class="city-desc" id="mdesc">Aguardando dados...</div>
    </div>

    <!-- WIND ROSE -->
    <div class="card">
      <div class="clabel">&#127744; Vento</div>
      <div class="wind-rose">
        <div class="wr-labels">
          <span class="wr-n">N</span><span class="wr-s">S</span>
          <span class="wr-e">L</span><span class="wr-w">O</span>
          <span class="wr-ne">NE</span><span class="wr-nw">NO</span>
          <span class="wr-se">SE</span><span class="wr-sw">SO</span>
        </div>
        <div class="wr-needle" id="wrNeedle"></div>
        <div class="wr-center"></div>
      </div>
      <div class="wr-info">
        <div class="wr-speed" id="wrSpeed">-- km/h</div>
        <div class="wr-dir" id="wrDir">--</div>
        <div class="wr-beaufort" id="wrBeaufort">--</div>
      </div>
      <div class="kite-bar">
        <div class="clabel" style="margin-bottom:3px;">&#129667; Rating Kite/Wind</div>
        <div class="kite-track"><div class="kite-fill" id="kiteFill" style="width:0%"></div></div>
        <div class="kite-label"><span>Fraco</span><span id="kiteVal">0/10</span><span>Forte</span></div>
      </div>
    </div>

    <!-- HOURLY -->
    <div class="card">
      <div class="clabel">&#128337; Previsão Horária</div>
      <div class="hour-strip" id="hourStrip"></div>
    </div>

    <!-- METAS -->
    <div class="card">
      <div class="clabel">&#128202; Dados Detalhados</div>
      <div class="metas">
        <div class="meta"><span class="mlabel">Sensação</span><span class="mval" id="mfeel">--°</span></div>
        <div class="meta"><span class="mlabel">Umidade</span><span class="mval" id="mhum">--%</span></div>
        <div class="meta"><span class="mlabel">Rajadas</span><span class="mval" id="mgust">--</span></div>
        <div class="meta"><span class="mlabel">Pressão</span><span class="mval" id="mpress">--</span></div>
        <div class="meta"><span class="mlabel">Visib.</span><span class="mval" id="mvis">--</span></div>
        <div class="meta"><span class="mlabel">Nuvens</span><span class="mval" id="mclouds">--%</span></div>
      </div>
    </div>

  </div>

  <!-- MAP -->
  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-overlay"></div>
    <div class="map-hint">&#128433;&#65039; CLIQUE NO MAPA OU SPOTS</div>
    <div class="map-badge">MET·BRASIL · metbrasil.com.br</div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <!-- WIND TABLE -->
    <div class="card">
      <div class="clabel">&#128168; Tabela de Vento · 5 Dias</div>
      <table class="wind-table" id="windTable">
        <thead><tr><th>Dia</th><th></th><th>Temp</th><th>Vento</th><th>Dir</th><th>&#128167;</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TABS: STATES / SPOTS -->
    <div class="card" style="flex:1;min-height:0;">
      <div class="tabs">
        <button class="tbtn on" data-tab="states">Estados</button>
        <button class="tbtn" data-tab="spots">Spots</button>
      </div>
      <div class="tcont on" id="tc-states">
        <div class="stgrid" id="stgrid"></div>
      </div>
      <div class="tcont" id="tc-spots">
        <div class="spots-grid" id="spotsGrid"></div>
      </div>
    </div>

    <!-- LEGEND -->
    <div class="card">
      <div class="clabel">&#127777;&#65039; Legenda</div>
      <div style="display:flex;flex-direction:column;gap:4px;font-family:'DM Mono';font-size:.55rem;opacity:.7;">
        <div style="display:flex;align-items:center;gap:6px;"><div style="width:10px;height:10px;border-radius:50%;background:#4CAF50;"></div><span>&lt; 20°C</span></div>
        <div style="display:flex;align-items:center;gap:6px;"><div style="width:10px;height:10px;border-radius:50%;background:#FF9800;"></div><span>20–30°C</span></div>
        <div style="display:flex;align-items:center;gap:6px;"><div style="width:10px;height:10px;border-radius:50%;background:#f44336;"></div><span>&gt; 30°C</span></div>
      </div>
    </div>

  </div>
</div>

<!-- JAVASCRIPT -->
<script>
// ============ DATA ============
const STATES=[
  {code:'AC',name:'Acre',lat:-9.97,lon:-67.81},{code:'AL',name:'Alagoas',lat:-9.57,lon:-36.78},
  {code:'AM',name:'Amazonas',lat:-3.07,lon:-60.03},{code:'AP',name:'Amapá',lat:0.9,lon:-52.0},
  {code:'BA',name:'Bahia',lat:-12.35,lon:-41.7},{code:'CE',name:'Ceará',lat:-3.72,lon:-38.54},
  {code:'DF',name:'Dist. Federal',lat:-15.78,lon:-47.93},{code:'ES',name:'Esp. Santo',lat:-19.83,lon:-40.32},
  {code:'GO',name:'Goiás',lat:-15.83,lon:-49.61},{code:'MA',name:'Maranhão',lat:-4.97,lon:-45.3},
  {code:'MG',name:'Minas Gerais',lat:-18.1,lon:-44.38},{code:'MS',name:'Mato G. Sul',lat:-20.44,lon:-54.65},
  {code:'MT',name:'Mato Grosso',lat:-12.64,lon:-55.42},{code:'PA',name:'Pará',lat:-3.79,lon:-52.48},
  {code:'PB',name:'Paraíba',lat:-7.24,lon:-36.78},{code:'PE',name:'Pernambuco',lat:-8.38,lon:-38.0},
  {code:'PI',name:'Piauí',lat:-6.6,lon:-42.73},{code:'PR',name:'Paraná',lat:-24.89,lon:-51.55},
  {code:'RJ',name:'Rio de Janeiro',lat:-22.84,lon:-43.15},{code:'RN',name:'R. G. Norte',lat:-5.74,lon:-36.67},
  {code:'RO',name:'Rondônia',lat:-10.83,lon:-63.34},{code:'RR',name:'Roraima',lat:2.0,lon:-61.37},
  {code:'RS',name:'R. G. Sul',lat:-30.03,lon:-51.22},{code:'SC',name:'Santa Cat.',lat:-27.59,lon:-48.55},
  {code:'SE',name:'Sergipe',lat:-10.57,lon:-37.38},{code:'SP',name:'São Paulo',lat:-23.55,lon:-46.63},
  {code:'TO',name:'Tocantins',lat:-10.17,lon:-48.33},
];

const SPOTS=[
  {name:'Jericoacoara',lat:-2.79,lon:-40.51,type:'kite'},{name:'Cumbuco',lat:-3.63,lon:-38.73,type:'kite'},
  {name:'Preá',lat:-2.92,lon:-40.42,type:'kite'},{name:'São M. Gostoso',lat:-5.12,lon:-35.63,type:'wind'},
  {name:'Atins',lat:-2.58,lon:-42.73,type:'kite'},{name:'Florianópolis',lat:-27.59,lon:-48.55,type:'surf'},
  {name:'Ilhabela',lat:-23.78,lon:-45.36,type:'sail'},{name:'Búzios',lat:-22.75,lon:-41.88,type:'surf'},
  {name:'Arraial do Cabo',lat:-22.97,lon:-42.03,type:'surf'},{name:'Saquarema',lat:-22.92,lon:-42.51,type:'surf'},
  {name:'Itacaré',lat:-14.28,lon:-38.99,type:'surf'},{name:'Torres',lat:-29.35,lon:-49.73,type:'surf'},
  {name:'Garopaba',lat:-28.02,lon:-48.62,type:'surf'},{name:'Ubatuba',lat:-23.43,lon:-45.07,type:'surf'},
  {name:'Maresias',lat:-23.79,lon:-45.56,type:'surf'},{name:'Guarujá',lat:-23.99,lon:-46.26,type:'surf'},
  {name:'Itamambuca',lat:-23.40,lon:-44.98,type:'surf'},{name:'Pipa',lat:-6.23,lon:-35.06,type:'surf'},
  {name:'Fernando Noronha',lat:-3.85,lon:-32.43,type:'surf'},{name:'Morro de SP',lat:-13.38,lon:-38.91,type:'surf'},
  {name:'Porto de Galinhas',lat:-8.50,lon:-35.00,type:'surf'},{name:'Praia do Forte',lat:-12.58,lon:-38.00,type:'surf'},
  {name:'Balneário Camboriú',lat:-26.99,lon:-48.63,type:'surf'},{name:'Imbituba',lat:-28.24,lon:-48.67,type:'surf'},
  {name:'Cabo Frio',lat:-22.88,lon:-42.03,type:'wind'},{name:'Barra Grande PI',lat:-2.90,lon:-41.40,type:'kite'},
];

// ============ STATE ============
let cache={},celsius=true,knots=false,curTheme='rain',curSport='surf',themeIdx=0,autoMode=true,autoTimer;
const THEMES=['rain','sun','cloudy'];
let uLat=null,uLon=null,map=null,userMarker=null,stateMarkers=[],spotMarkers=[];

// ============ PARTICLES ============
const cv=document.getElementById('fx'),cx=cv.getContext('2d');
let pts=[];
function rcv(){cv.width=innerWidth;cv.height=innerHeight;}
window.addEventListener('resize',rcv);rcv();
class Pt{
  constructor(){this.init();}
  init(){
    this.x=Math.random()*cv.width;this.y=Math.random()*cv.height;this.t=curTheme;
    if(this.t==='rain'){this.vx=-1.5-Math.random();this.vy=9+Math.random()*7;this.sz=.8+Math.random()*1.5;this.len=9+Math.random()*12;this.a=.13+Math.random()*.32;}
    else if(this.t==='sun'){this.vx=(Math.random()-.5)*.4;this.vy=-.2-Math.random()*.38;this.sz=1.2+Math.random()*3.2;this.a=.1+Math.random()*.22;}
    else{this.vx=.2+Math.random()*.38;this.vy=(Math.random()-.5)*.12;this.sz=28+Math.random()*65;this.a=.02+Math.random()*.035;}
  }
}
function ipts(){const n=curTheme==='rain'?110:curTheme==='sun'?45:8;pts=Array.from({length:n},()=>new Pt());}
function loop(){
  cx.clearRect(0,0,cv.width,cv.height);
  for(const p of pts){
    if(p.t!==curTheme){p.t=curTheme;p.init();}
    cx.save();
    if(curTheme==='rain'){cx.strokeStyle=`rgba(79,195,247,${p.a})`;cx.lineWidth=p.sz;cx.beginPath();cx.moveTo(p.x,p.y);cx.lineTo(p.x+p.vx*2,p.y+p.len);cx.stroke();}
    else if(curTheme==='sun'){cx.fillStyle=`rgba(255,232,90,${p.a})`;cx.beginPath();cx.arc(p.x,p.y,p.sz,0,Math.PI*2);cx.fill();}
    else{cx.fillStyle=`rgba(155,185,215,${p.a})`;cx.beginPath();cx.ellipse(p.x,p.y,p.sz*2.2,p.sz,0,0,Math.PI*2);cx.fill();}
    cx.restore();
    p.x+=p.vx;p.y+=p.vy;
    if(p.y>cv.height+20){p.y=-20;p.x=Math.random()*cv.width;}
    if(p.x>cv.width+120){p.x=-120;}
    if(p.y<-20){p.y=cv.height+20;}
  }
  requestAnimationFrame(loop);
}
ipts();loop();

// ============ THEME ============
function setTheme(t,manual=false){
  curTheme=t;
  if(manual){autoMode=false;clearInterval(autoTimer);}
  document.getElementById('flash').classList.add('flashing');
  setTimeout(()=>document.getElementById('flash').classList.remove('flashing'),380);
  document.body.className='theme-'+t+' mode-'+curSport;
  document.querySelectorAll('.theme-pill').forEach(p=>p.classList.toggle('on',p.dataset.t===t));
  const pr=document.getElementById('tbar-prog');pr.style.animation='none';pr.offsetHeight;pr.style.animation='';
  ipts();
  if(map)refreshMarkers();
}
function startAuto(){
  clearInterval(autoTimer);
  autoTimer=setInterval(()=>{if(!autoMode)return;themeIdx=(themeIdx+1)%THEMES.length;setTheme(THEMES[themeIdx]);},8000);
}
document.querySelectorAll('.theme-pill').forEach(b=>{
  b.addEventListener('click',()=>{autoMode=false;clearInterval(autoTimer);setTheme(b.dataset.t,true);setTimeout(()=>{autoMode=true;startAuto();},24000);});
});
startAuto();

// ============ SPORT MODE ============
document.querySelectorAll('.sport-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    curSport=b.dataset.sport;
    document.querySelectorAll('.sport-btn').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.body.className='theme-'+curTheme+' mode-'+curSport;
    if(map)refreshMarkers();
  });
});

// ============ CLOCK ============
function tick(){
  const brt=new Date(new Date().toLocaleString('en',{timeZone:'America/Sao_Paulo'}));
  document.getElementById('clk').textContent=brt.toTimeString().slice(0,5);
}
setInterval(tick,1000);tick();

// ============ UNITS ============
document.getElementById('bC').onclick=()=>{celsius=true;document.getElementById('bC').classList.add('on');document.getElementById('bF').classList.remove('on');refreshAll();};
document.getElementById('bF').onclick=()=>{celsius=false;document.getElementById('bF').classList.add('on');document.getElementById('bC').classList.remove('on');refreshAll();};
document.getElementById('bKmh').onclick=()=>{knots=false;document.getElementById('bKmh').classList.add('on');document.getElementById('bKt').classList.remove('on');refreshAll();};
document.getElementById('bKt').onclick=()=>{knots=true;document.getElementById('bKt').classList.add('on');document.getElementById('bKmh').classList.remove('on');refreshAll();};
function toC(c){return celsius?Math.round(c)+'°C':Math.round(c*9/5+32)+'°F';}
function toN(c){return celsius?Math.round(c):Math.round(c*9/5+32);}
function toW(kmh){return knots?Math.round(kmh/1.852)+' nós':Math.round(kmh)+' km/h';}
function toWn(kmh){return knots?Math.round(kmh/1.852):Math.round(kmh);}

// ============ WMO ============
function wmoIcon(c){if(c===0)return'\u2600\uFE0F';if(c<=2)return'\u26C5';if(c===3)return'\u2601\uFE0F';if(c<=49)return'\uD83C\uDF2B\uFE0F';if(c<=59)return'\uD83C\uDF26\uFE0F';if(c<=69)return'\u2744\uFE0F';if(c<=82)return'\uD83C\uDF27\uFE0F';return'\u26C8\uFE0F';}
function wmoDesc(c){if(c===0)return'Céu limpo';if(c<=2)return'Parcialmente nublado';if(c===3)return'Nublado';if(c<=49)return'Nevoeiro';if(c<=59)return'Garoa';if(c<=79)return'Neve/Granizo';if(c<=82)return'Chuva';return'Tempestade';}

// ============ CONDITION LOGIC ============
function surfCondition(wCode,windKmh){
  if(wCode>=95)return{label:'PERIGOSO',cls:'cond-poor',stars:0};
  if(wCode>=80)return{label:'RUIM',cls:'cond-poor',stars:1};
  if(windKmh<5)return{label:'SEM VENTO',cls:'cond-flat',stars:2};
  if(windKmh>=15&&windKmh<=30&&wCode<=3)return{label:'ÉPICO!',cls:'cond-epic',stars:5};
  if(windKmh>=10&&windKmh<=35&&wCode<=10)return{label:'BOM',cls:'cond-good',stars:4};
  if(windKmh>=8&&wCode<=20)return{label:'RAZOÁVEL',cls:'cond-fair',stars:3};
  return{label:'FRACO',cls:'cond-poor',stars:1};
}
function kiteRating(kmh){if(kmh<8)return 1;if(kmh<12)return 3;if(kmh<16)return 5;if(kmh<22)return 8;if(kmh<30)return 10;if(kmh<40)return 7;if(kmh<50)return 5;return 3;}
function beaufort(kmh){
  if(kmh<1)return'Calmo (0)';if(kmh<6)return'Aragem (1)';if(kmh<12)return'Brisa leve (2)';if(kmh<20)return'Brisa fraca (3)';
  if(kmh<29)return'Brisa moderada (4)';if(kmh<39)return'Brisa forte (5)';if(kmh<50)return'Vento fresco (6)';
  if(kmh<62)return'Vento forte (7)';if(kmh<75)return'Ventania (8)';if(kmh<89)return'Ventania forte (9)';
  if(kmh<103)return'Tempestade (10)';if(kmh<118)return'Tempestade violenta (11)';return'Furacão (12)';
}
function windDir16(deg){const dirs=['N','NNE','NE','ENE','L','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];return dirs[Math.round(deg/22.5)%16];}

// ============ FETCH ============
async function fw(lat,lon){
  const k=`${lat.toFixed(1)},${lon.toFixed(1)}`;
  if(cache[k])return cache[k];
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,surface_pressure,visibility,cloud_cover&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code&timezone=America%2FSao_Paulo&forecast_days=5`);
    const d=await r.json();cache[k]=d;return d;
  }catch(e){return null;}
}

// ============ MAP ============
function initMap(lat,lon){
  map=L.map('map',{center:[lat,lon],zoom:5,zoomControl:true,attributionControl:true});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; OSM &copy; CARTO',subdomains:'abcd',maxZoom:18
  }).addTo(map);
  map.on('click',async(e)=>{const{lat:lt,lng:ln}=e.latlng;await showMapPopup(lt,ln,null);});
  map.fitBounds([[-34,-74],[5,-28]]);
}
function tempColor(t){if(t===null)return'#9fb8d8';if(t<20)return'#4CAF50';if(t<30)return'#FF9800';return'#f44336';}
function makeIcon(temp,icon,highlight=false){
  const col=tempColor(temp);const sz=highlight?44:38;const t=temp!==null?Math.round(temp)+'°':'?°';
  return L.divIcon({className:'',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2],popupAnchor:[0,-(sz/2+4)],
    html:`<div style="width:${sz}px;height:${sz}px;border-radius:50%;background:${col};border:2px solid rgba(255,255,255,${highlight?.85:.5});display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 ${highlight?14:8}px ${col},0 2px 6px rgba(0,0,0,.5);font-family:'Bebas Neue',sans-serif;line-height:1;cursor:pointer;${highlight?'transform:scale(1.1);':''}"><span style="font-size:${highlight?'.9rem':'.75rem'};color:white;font-weight:700;">${t}</span><span style="font-size:${highlight?'.8rem':'.65rem'};margin-top:-2px;">${icon}</span></div>`
  });
}
function makeSpotIcon(type){
  const colors={surf:'#0097a7',kite:'#7c4dff',wind:'#00897b',sail:'#1565c0',fish:'#558b2f'};
  const icons={surf:'\uD83C\uDFC4',kite:'\uD83E\uDE81',wind:'\uD83C\uDFC4',sail:'\u26F5',fish:'\uD83C\uDFA3'};
  const col=colors[type]||'#0097a7';const ico=icons[type]||'\uD83C\uDFC4';
  return L.divIcon({className:'',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-18],
    html:`<div style="width:28px;height:28px;border-radius:50%;background:${col};border:2px solid white;display:flex;align-items:center;justify-content:center;box-shadow:0 0 10px ${col};font-size:.9rem;cursor:pointer;">${ico}</div>`
  });
}
function makeUserIcon(){return L.divIcon({className:'',iconSize:[18,18],iconAnchor:[9,9],html:`<div class="loc-dot"></div>`});}

// ============ MARKERS ============
async function placeStateMarkers(){
  const ps=STATES.map(s=>fw(s.lat,s.lon).then(d=>({s,d})));
  const res=await Promise.all(ps);
  res.forEach(({s,d})=>{
    s._t=d?d.current.temperature_2m:null;s._h=d?d.current.relative_humidity_2m:null;
    s._w=d?d.current.wind_speed_10m:null;s._wdir=d?d.current.wind_direction_10m:null;
    s._c=d?d.current.weather_code:0;s._daily=d?d.daily:null;s._hourly=d?d.hourly:null;
    s._prec=d?d.daily.precipitation_probability_max[0]:null;
    s._feel=d?d.current.apparent_temperature:null;s._gust=d?d.current.wind_gusts_10m:null;
    const icon=makeIcon(s._t,wmoIcon(s._c));
    const marker=L.marker([s.lat,s.lon],{icon}).addTo(map);
    marker.on('click',()=>{selState(s);showStatePopup(s,marker);});
    stateMarkers.push({s,marker});
  });
  buildStateGrid(res);
  placeSpotMarkers();
  setTimeout(()=>document.getElementById('loading').classList.add('hide'),400);
}
async function placeSpotMarkers(){
  SPOTS.forEach(sp=>{
    const marker=L.marker([sp.lat,sp.lon],{icon:makeSpotIcon(sp.type)}).addTo(map);
    marker.on('click',async()=>{await showMapPopup(sp.lat,sp.lon,sp.name);});
    spotMarkers.push({sp,marker});
  });
  buildSpotsGrid();
}
function refreshMarkers(){
  stateMarkers.forEach(({s,marker})=>{marker.setIcon(makeIcon(s._t,wmoIcon(s._c)));});
  if(userMarker)userMarker.setIcon(makeUserIcon());
}

// ============ POPUPS ============
function showStatePopup(s,marker){
  const html=`<div class="pop-content"><div class="pop-title">${s.name}</div><div style="display:flex;align-items:baseline;gap:6px;"><div class="pop-temp">${toN(s._t||0)}</div><div style="font-size:.8rem;opacity:.6;">${celsius?'°C':'°F'}</div><div style="font-size:1.4rem;margin-left:4px;">${wmoIcon(s._c)}</div></div><div class="pop-desc">${wmoDesc(s._c)}</div><div class="pop-meta"><div class="pop-m"><span class="pop-ml">Vento</span><span class="pop-mv">${toW(s._w||0)}</span></div><div class="pop-m"><span class="pop-ml">Rajadas</span><span class="pop-mv">${toW(s._gust||0)}</span></div><div class="pop-m"><span class="pop-ml">Umidade</span><span class="pop-mv">${s._h||'--'}%</span></div><div class="pop-m"><span class="pop-ml">Chuva</span><span class="pop-mv">${s._prec!==null?s._prec+'%':'--'}</span></div></div></div>`;
  marker.bindPopup(html,{maxWidth:220}).openPopup();
}
async function showMapPopup(lat,lon,name){
  const d=await fw(lat,lon);if(!d)return;const c=d.current;
  const tmpMk=L.marker([lat,lon],{icon:makeIcon(c.temperature_2m,wmoIcon(c.weather_code),true)}).addTo(map);
  const html=`<div class="pop-content"><div class="pop-title">${name||'\uD83D\uDCCD '+lat.toFixed(2)+', '+lon.toFixed(2)}</div><div style="display:flex;align-items:baseline;gap:6px;"><div class="pop-temp">${toN(c.temperature_2m)}</div><div style="font-size:.8rem;opacity:.6;">${celsius?'°C':'°F'}</div><div style="font-size:1.4rem;margin-left:4px;">${wmoIcon(c.weather_code)}</div></div><div class="pop-desc">${wmoDesc(c.weather_code)}</div><div class="pop-meta"><div class="pop-m"><span class="pop-ml">Vento</span><span class="pop-mv">${toW(c.wind_speed_10m)}</span></div><div class="pop-m"><span class="pop-ml">Rajadas</span><span class="pop-mv">${toW(c.wind_gusts_10m)}</span></div><div class="pop-m"><span class="pop-ml">Umidade</span><span class="pop-mv">${c.relative_humidity_2m}%</span></div><div class="pop-m"><span class="pop-ml">Pressão</span><span class="pop-mv">${Math.round(c.surface_pressure)} hPa</span></div></div></div>`;
  tmpMk.bindPopup(html,{maxWidth:220}).openPopup();
  tmpMk.on('popupclose',()=>map.removeLayer(tmpMk));
}

// ============ LOAD MAIN ============
async function loadMain(lat,lon,city){
  const d=await fw(lat,lon);if(!d)return;const c=d.current;
  document.getElementById('mcity').textContent=city;
  document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'°C':'°F')+'</sup>';
  document.getElementById('mdesc').textContent=wmoDesc(c.weather_code);
  document.getElementById('micon').textContent=wmoIcon(c.weather_code);
  document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
  document.getElementById('mhum').textContent=c.relative_humidity_2m+'%';
  document.getElementById('mgust').textContent=toW(c.wind_gusts_10m);
  document.getElementById('mpress').textContent=Math.round(c.surface_pressure)+' hPa';
  document.getElementById('mvis').textContent=c.visibility?(c.visibility/1000).toFixed(1)+' km':'--';
  document.getElementById('mclouds').textContent=c.cloud_cover+'%';
  // Wind Rose
  document.getElementById('wrNeedle').style.setProperty('--wd',c.wind_direction_10m+'deg');
  document.getElementById('wrSpeed').textContent=toW(c.wind_speed_10m);
  document.getElementById('wrDir').textContent=windDir16(c.wind_direction_10m)+' ('+Math.round(c.wind_direction_10m)+'°)';
  document.getElementById('wrBeaufort').textContent=beaufort(c.wind_speed_10m);
  // Kite Bar
  const kr=kiteRating(c.wind_speed_10m);
  document.getElementById('kiteFill').style.width=(kr*10)+'%';
  document.getElementById('kiteVal').textContent=kr+'/10';
  // Condition Badge
  const cond=surfCondition(c.weather_code,c.wind_speed_10m);
  const badge=document.getElementById('condBadge');
  badge.className='cond-badge '+cond.cls;
  badge.innerHTML=cond.label+' <span class="stars">'+'&#9733;'.repeat(cond.stars)+'&#9734;'.repeat(5-cond.stars)+'</span>';
  // Hourly
  buildHours(d.hourly);
  // Wind Table
  buildWindTable(d.daily);
  // User marker
  if(userMarker)map.removeLayer(userMarker);
  userMarker=L.marker([lat,lon],{icon:makeUserIcon(),zIndexOffset:1000}).addTo(map);
}

// ============ BUILD HOURS ============
function buildHours(hourly){
  const now=new Date();const baseHour=now.getHours();
  const strip=document.getElementById('hourStrip');strip.innerHTML='';
  let peakWind=0,peakIdx=0;
  for(let i=0;i<12;i++){
    const idx=baseHour+i;if(idx>=hourly.time.length)break;
    if(hourly.wind_speed_10m[idx]>peakWind){peakWind=hourly.wind_speed_10m[idx];peakIdx=i;}
  }
  for(let i=0;i<12;i++){
    const idx=baseHour+i;if(idx>=hourly.time.length)break;
    const el=document.createElement('div');
    el.className='hour-item'+(i===peakIdx?' peak':'');
    const hr=(baseHour+i)%24;
    el.innerHTML=`<div class="htime">${String(hr).padStart(2,'0')}h</div><div class="hicon">${wmoIcon(hourly.weather_code[idx])}</div><div class="htemp">${toN(hourly.temperature_2m[idx])}°</div><div class="hwind">${toWn(hourly.wind_speed_10m[idx])}${knots?' kt':''}</div>`;
    strip.appendChild(el);
  }
}

// ============ BUILD WIND TABLE ============
function buildWindTable(daily){
  const D=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  const tbody=document.querySelector('#windTable tbody');tbody.innerHTML='';
  for(let i=0;i<5;i++){
    const dt=new Date(daily.time[i]);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i===0?'Hoje':D[dt.getDay()]}</td><td class="wt-icon">${wmoIcon(daily.weather_code[i])}</td><td class="wt-temp">${toN(daily.temperature_2m_max[i])}°</td><td class="wt-wind">${toWn(daily.wind_speed_10m_max[i])}</td><td class="wt-gust">(${toWn(daily.wind_gusts_10m_max[i])})</td><td class="wt-precip">${daily.precipitation_probability_max[i]}%</td>`;
    tbody.appendChild(tr);
  }
}

// ============ STATE GRID ============
function buildStateGrid(res){
  const g=document.getElementById('stgrid');g.innerHTML='';
  res.forEach(({s})=>{
    const btn=document.createElement('button');
    btn.className='stbtn';btn.id='sb-'+s.code;
    btn.innerHTML=wmoIcon(s._c)+'<br><b>'+s.code+'</b><br>'+(s._t!==null?toN(s._t)+'°':'?');
    btn.title=s.name;
    btn.onclick=()=>{selState(s);const m=stateMarkers.find(x=>x.s.code===s.code);if(m){map.setView([s.lat,s.lon],7,{animate:true});showStatePopup(s,m.marker);}};
    g.appendChild(btn);
  });
}
function selState(s){
  document.querySelectorAll('.stbtn').forEach(b=>b.classList.remove('on'));
  const btn=document.getElementById('sb-'+s.code);if(btn)btn.classList.add('on');
  loadMain(s.lat,s.lon,s.name);
}

// ============ SPOTS GRID ============
function buildSpotsGrid(){
  const g=document.getElementById('spotsGrid');g.innerHTML='';
  const icons={surf:'\uD83C\uDFC4',kite:'\uD83E\uDE81',wind:'\uD83C\uDFC4',sail:'\u26F5',fish:'\uD83C\uDFA3'};
  SPOTS.forEach(sp=>{
    const btn=document.createElement('button');
    btn.className='spot-btn';
    btn.innerHTML=`<span class="spot-icon">${icons[sp.type]||'\uD83C\uDFC4'}</span><span class="spot-name">${sp.name}</span>`;
    btn.onclick=async()=>{map.setView([sp.lat,sp.lon],10,{animate:true});await showMapPopup(sp.lat,sp.lon,sp.name);await loadMain(sp.lat,sp.lon,sp.name);};
    g.appendChild(btn);
  });
}

// ============ TABS ============
document.querySelectorAll('.tbtn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tbtn').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tcont').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById('tc-'+b.dataset.tab).classList.add('on');
  };
});

// ============ SEARCH ============
const SEARCH_ITEMS=[...STATES.map(s=>({name:s.name+', '+s.code,lat:s.lat,lon:s.lon})),...SPOTS.map(sp=>({name:sp.name,lat:sp.lat,lon:sp.lon}))];
const sinput=document.getElementById('searchInput');
const sresults=document.getElementById('searchResults');
sinput.addEventListener('input',()=>{
  const q=sinput.value.toLowerCase().trim();
  if(q.length<2){sresults.classList.remove('show');return;}
  const matches=SEARCH_ITEMS.filter(c=>c.name.toLowerCase().includes(q)).slice(0,8);
  if(!matches.length){sresults.classList.remove('show');return;}
  sresults.innerHTML=matches.map(c=>`<div class="search-item" data-lat="${c.lat}" data-lon="${c.lon}" data-name="${c.name}">${c.name}</div>`).join('');
  sresults.classList.add('show');
  sresults.querySelectorAll('.search-item').forEach(el=>{
    el.addEventListener('click',async()=>{
      const lt=parseFloat(el.dataset.lat),ln=parseFloat(el.dataset.lon),nm=el.dataset.name;
      sinput.value=nm;sresults.classList.remove('show');
      map.setView([lt,ln],10,{animate:true});
      await showMapPopup(lt,ln,nm);
      await loadMain(lt,ln,nm);
    });
  });
});
document.addEventListener('click',e=>{if(!e.target.closest('.search-wrap'))sresults.classList.remove('show');});

// ============ REFRESH ALL ============
function refreshAll(){
  if(uLat){
    const k=`${uLat.toFixed(1)},${uLon.toFixed(1)}`;
    if(cache[k]){
      const c=cache[k].current;
      document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'°C':'°F')+'</sup>';
      document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
      document.getElementById('mgust').textContent=toW(c.wind_gusts_10m);
      document.getElementById('wrSpeed').textContent=toW(c.wind_speed_10m);
      buildHours(cache[k].hourly);
      buildWindTable(cache[k].daily);
    }
  }
  STATES.forEach(s=>{
    const btn=document.getElementById('sb-'+s.code);
    if(btn&&s._t!==null)btn.innerHTML=wmoIcon(s._c)+'<br><b>'+s.code+'</b><br>'+toN(s._t)+'°';
  });
  refreshMarkers();
}

// ============ INIT ============
async function init(){
  initMap(-14,-52);
  try{
    const r=await fetch('https://ipapi.co/json/');
    const d=await r.json();
    uLat=parseFloat(d.latitude);uLon=parseFloat(d.longitude);
    const city=d.city+', '+d.region_code;
    await loadMain(uLat,uLon,city);
  }catch(e){
    uLat=-23.55;uLon=-46.63;
    await loadMain(uLat,uLon,'São Paulo, SP');
  }
  await placeStateMarkers();
}
init();
</script>
</body>
</html>
