<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetBrasil ¬∑ Inteligencia Climatica para Esportes</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4fc3f7">
<meta name="description" content="Plataforma brasileira de meteorologia focada em esportes aquaticos e ao ar livre">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MetBrasil">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23020810' width='180' height='180' rx='20'/><text x='90' y='75' text-anchor='middle' fill='%234fc3f7' font-family='sans-serif' font-size='65' font-weight='bold'>M</text><text x='90' y='135' text-anchor='middle' fill='%234fc3f7' font-family='sans-serif' font-size='28'>BRASIL</text></svg>">

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ===================== RESET & ROOT ===================== */
:root{--tr:1.2s;--tr-fast:0.6s;--sport-color:#0097a7;--perspective:1200px;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{font-family:'Syne',sans-serif;perspective:var(--perspective);transition:all var(--tr);}

/* ===================== THEMES - RADICAL TRANSFORMATION ===================== */

/* === RAIN THEME === */
.theme-rain{
  --bg1:#020810;--bg2:#0a1628;--acc:#4fc3f7;--acc2:#0288d1;
  --txt:#e0f7fa;--card:rgba(2,8,20,0.88);--bdr:rgba(79,195,247,.35);
  --glow:rgba(79,195,247,.7);--shine:rgba(79,195,247,.12);
  --map-filter:hue-rotate(200deg) saturate(1.4) brightness(0.4) contrast(1.2);
  --map-overlay:rgba(2,8,16,0.55);
  --card-clip:polygon(0 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%);
  --header-bg:linear-gradient(180deg, rgba(2,8,20,0.95) 0%, rgba(10,22,40,0.85) 100%);
  --font-weight:300;
  --letter-spacing:3px;
}
.theme-rain .shell{transform:rotateX(1deg);transform-origin:center bottom;}
.theme-rain .card{clip-path:var(--card-clip);border-left:3px solid var(--acc);}
.theme-rain .logo-main{font-weight:400;letter-spacing:6px;animation:glitch 4s infinite;}
.theme-rain header{background:var(--header-bg);border-bottom:2px solid var(--acc);box-shadow:0 4px 30px rgba(79,195,247,0.3);}

/* === SUN THEME === */
.theme-sun{
  --bg1:#1a0800;--bg2:#3d1500;--acc:#ffd54f;--acc2:#ff8f00;
  --txt:#fff8e1;--card:rgba(60,30,5,0.85);--bdr:rgba(255,200,50,.45);
  --glow:rgba(255,213,79,.85);--shine:rgba(255,255,200,.18);
  --map-filter:sepia(0.3) saturate(1.6) brightness(0.85) hue-rotate(-10deg);
  --map-overlay:rgba(40,15,0,0.35);
  --card-clip:polygon(8px 0, 100% 0, 100% 100%, 0 100%, 0 8px);
  --header-bg:linear-gradient(180deg, rgba(60,25,0,0.95) 0%, rgba(80,35,0,0.85) 100%);
  --font-weight:700;
  --letter-spacing:4px;
}
.theme-sun .shell{transform:rotateX(-0.5deg) scale(1.01);transform-origin:center top;}
.theme-sun .card{clip-path:var(--card-clip);border-top:3px solid var(--acc);box-shadow:0 8px 40px rgba(255,150,0,0.4),inset 0 1px 0 var(--shine);}
.theme-sun .logo-main{font-weight:700;letter-spacing:8px;text-transform:uppercase;}
.theme-sun header{background:var(--header-bg);border-bottom:3px solid var(--acc);box-shadow:0 8px 50px rgba(255,150,0,0.5);}
.theme-sun .big-temp{font-size:5.5rem;text-shadow:0 0 50px var(--glow),0 0 100px var(--acc2);}

/* === CLOUDY THEME === */
.theme-cloudy{
  --bg1:#0d1117;--bg2:#161b22;--acc:#8b9dc3;--acc2:#5a6f94;
  --txt:#c9d1d9;--card:rgba(13,17,23,0.75);--bdr:rgba(139,157,195,.25);
  --glow:rgba(139,157,195,.5);--shine:rgba(255,255,255,.06);
  --map-filter:grayscale(0.6) brightness(0.45) saturate(0.6) blur(1px);
  --map-overlay:rgba(13,17,23,0.5);
  --card-clip:polygon(0 8px, 8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px));
  --header-bg:linear-gradient(180deg, rgba(13,17,23,0.9) 0%, rgba(22,27,34,0.8) 100%);
  --font-weight:400;
  --letter-spacing:5px;
}
.theme-cloudy .shell{transform:rotateX(0deg) rotateY(0.3deg);transform-origin:center center;}
.theme-cloudy .card{clip-path:var(--card-clip);backdrop-filter:blur(30px);border:1px solid var(--bdr);}
.theme-cloudy .logo-main{font-weight:400;letter-spacing:10px;opacity:0.85;}
.theme-cloudy header{background:var(--header-bg);backdrop-filter:blur(40px);border-bottom:1px solid var(--bdr);}
.theme-cloudy .left-panel,.theme-cloudy .right-panel{backdrop-filter:blur(20px);}

body{background:linear-gradient(145deg,var(--bg1),var(--bg2));color:var(--txt);}

/* ===================== NIGHT MODE ===================== */
.night-mode #map{filter:var(--map-filter) brightness(0.6)!important;}
.night-mode .map-overlay{background:rgba(0,0,20,0.4)!important;}
.night-mode .map-vignette{box-shadow:inset 0 0 200px rgba(0,0,30,0.8)!important;}
.night-mode .shell{filter:brightness(0.92);}
.night-mode #fx-overlay{opacity:1;background:linear-gradient(180deg, rgba(0,0,30,0.25) 0%, transparent 30%, transparent 70%, rgba(0,0,40,0.3) 100%)!important;}
.night-indicator{
  display:flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:15px;
  background:rgba(0,0,0,0.3);border:1px solid var(--bdr);
  font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;
  transition:all .3s;cursor:pointer;
}
.night-indicator:hover{background:rgba(255,255,255,0.1);border-color:var(--acc);}
.night-indicator .ni-icon{font-size:1rem;transition:transform .5s;}
.night-indicator.is-night .ni-icon{transform:rotate(360deg);}
.night-indicator .ni-text{opacity:.7;}

/* ===================== WEATHER ALERTS ===================== */
.alert-banner{
  position:fixed;top:0;left:0;right:0;z-index:8000;
  transform:translateY(-100%);transition:transform .4s cubic-bezier(0.4,0,0.2,1);
  pointer-events:none;
}
.alert-banner.show{transform:translateY(0);pointer-events:auto;}
.alert-content{
  display:flex;align-items:center;justify-content:center;gap:12px;
  padding:10px 20px;
  font-family:'Orbitron';font-size:.6rem;letter-spacing:2px;
  text-transform:uppercase;
}
.alert-rain{background:linear-gradient(90deg,#1565c0,#0d47a1);color:#fff;box-shadow:0 4px 20px rgba(21,101,192,0.5);}
.alert-storm{background:linear-gradient(90deg,#d32f2f,#b71c1c);color:#fff;box-shadow:0 4px 20px rgba(211,47,47,0.5);animation:alertPulse 2s infinite;}
.alert-wind{background:linear-gradient(90deg,#f57c00,#e65100);color:#fff;box-shadow:0 4px 20px rgba(245,124,0,0.5);}
.alert-heat{background:linear-gradient(90deg,#ff5722,#e64a19);color:#fff;box-shadow:0 4px 20px rgba(255,87,34,0.5);}
.alert-icon{font-size:1.2rem;animation:alertBounce 1s infinite;}
.alert-text{flex:1;}
.alert-close{
  background:rgba(255,255,255,0.2);border:none;color:#fff;
  width:24px;height:24px;border-radius:50%;cursor:pointer;
  font-size:.8rem;transition:all .2s;
}
.alert-close:hover{background:rgba(255,255,255,0.4);transform:scale(1.1);}
@keyframes alertPulse{0%,100%{opacity:1;}50%{opacity:0.85;}}
@keyframes alertBounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}

.alert-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 8px;border-radius:10px;
  font-family:'Orbitron';font-size:.4rem;letter-spacing:1px;
  animation:alertPulse 2s infinite;
}
.alert-badge-rain{background:#1565c0;color:#fff;}
.alert-badge-storm{background:#d32f2f;color:#fff;}
.alert-badge-wind{background:#f57c00;color:#fff;}

/* ===================== SPOT MODAL ===================== */
.spot-modal{
  position:fixed;inset:0;z-index:8500;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);
  opacity:0;pointer-events:none;transition:opacity .4s;
}
.spot-modal.show{opacity:1;pointer-events:auto;}
.spot-modal-content{
  width:90%;max-width:700px;max-height:85vh;
  background:var(--card);border:2px solid var(--acc);border-radius:20px;
  overflow:hidden;transform:scale(0.9) translateY(30px);
  transition:transform .4s cubic-bezier(0.4,0,0.2,1);
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.spot-modal.show .spot-modal-content{transform:scale(1) translateY(0);}
.spot-modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;background:rgba(0,0,0,0.3);border-bottom:1px solid var(--bdr);
}
.spot-modal-title{
  font-family:'Bebas Neue';font-size:1.8rem;letter-spacing:4px;color:var(--acc);
  display:flex;align-items:center;gap:10px;
}
.spot-modal-title .smt-icon{font-size:1.5rem;}
.spot-modal-close{
  background:rgba(255,255,255,0.1);border:1px solid var(--bdr);color:var(--txt);
  width:36px;height:36px;border-radius:50%;cursor:pointer;
  font-size:1.2rem;transition:all .2s;
}
.spot-modal-close:hover{background:var(--acc);color:var(--bg1);border-color:var(--acc);}
.spot-modal-body{padding:20px;overflow-y:auto;max-height:calc(85vh - 80px);}
.spot-current{
  display:flex;align-items:center;gap:20px;padding:16px;
  background:rgba(0,0,0,0.2);border-radius:12px;margin-bottom:16px;
}
.spot-current-icon{font-size:3.5rem;filter:drop-shadow(0 0 15px var(--glow));}
.spot-current-data{flex:1;}
.spot-current-temp{font-family:'Bebas Neue';font-size:3.5rem;color:var(--acc);line-height:1;}
.spot-current-desc{font-family:'Orbitron';font-size:.6rem;opacity:.7;letter-spacing:2px;margin-top:4px;}
.spot-current-meta{display:flex;gap:16px;margin-top:8px;font-family:'Orbitron';font-size:.5rem;}
.spot-current-meta span{display:flex;align-items:center;gap:4px;opacity:.8;}
.spot-forecast-title{
  font-family:'Orbitron';font-size:.6rem;letter-spacing:3px;
  color:var(--acc);margin-bottom:12px;opacity:.8;
}
.spot-forecast-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.spot-day{
  padding:12px 6px;border-radius:12px;border:1px solid var(--bdr);
  text-align:center;background:rgba(0,0,0,0.2);transition:all .2s;
}
.spot-day:hover{background:rgba(255,255,255,0.08);transform:translateY(-3px);border-color:var(--acc);}
.spot-day-name{font-family:'Orbitron';font-size:.5rem;opacity:.6;letter-spacing:1px;margin-bottom:6px;}
.spot-day-icon{font-size:1.5rem;margin:6px 0;}
.spot-day-temps{display:flex;flex-direction:column;gap:2px;}
.spot-day-max{font-family:'Bebas Neue';font-size:1.3rem;color:var(--acc);}
.spot-day-min{font-family:'Orbitron';font-size:.5rem;opacity:.5;}
.spot-day-wind{font-family:'Orbitron';font-size:.45rem;opacity:.6;margin-top:6px;}
.spot-day-precip{font-family:'Orbitron';font-size:.4rem;color:#4fc3f7;margin-top:2px;}
@media(max-width:600px){
  .spot-forecast-grid{grid-template-columns:repeat(4,1fr);}
  .spot-day:nth-child(n+5){display:none;}
  .spot-current{flex-direction:column;text-align:center;}
}

/* ===================== SPORT MODES ===================== */
.mode-surf{--sport-color:#0097a7;}
.mode-kite{--sport-color:#7c4dff;}
.mode-wind{--sport-color:#00897b;}
.mode-para{--sport-color:#f57c00;}
.mode-sail{--sport-color:#1565c0;}
.mode-fish{--sport-color:#558b2f;}

/* ===================== IMMERSIVE FX LAYERS ===================== */
#fx{position:fixed;inset:0;pointer-events:none;z-index:1;}
#fx-overlay{position:fixed;inset:0;pointer-events:none;z-index:2;opacity:0;transition:opacity var(--tr);}
#lightning{position:fixed;inset:0;pointer-events:none;z-index:3;background:white;opacity:0;mix-blend-mode:overlay;}
#sunrays{position:fixed;inset:0;pointer-events:none;z-index:2;opacity:0;background:radial-gradient(ellipse at 80% -20%, rgba(255,200,50,0.4) 0%, transparent 50%);transition:opacity var(--tr);}
#fog{position:fixed;inset:0;pointer-events:none;z-index:2;opacity:0;transition:opacity var(--tr);}

.theme-rain #fx-overlay{opacity:1;background:linear-gradient(180deg, rgba(0,20,40,0.3) 0%, transparent 30%, transparent 70%, rgba(0,10,20,0.4) 100%);}
.theme-sun #sunrays{opacity:1;animation:sunpulse 8s ease-in-out infinite;}
.theme-cloudy #fog{opacity:1;background:linear-gradient(180deg, rgba(100,120,140,0.15) 0%, transparent 40%, transparent 60%, rgba(80,100,120,0.2) 100%);}

@keyframes sunpulse{0%,100%{opacity:0.6;transform:scale(1);}50%{opacity:1;transform:scale(1.1);}}
@keyframes glitch{0%,90%,100%{text-shadow:0 0 18px var(--glow);}92%{text-shadow:-2px 0 var(--acc),2px 0 var(--acc2);}94%{text-shadow:2px 0 var(--acc),-2px 0 var(--acc2);}96%{text-shadow:0 0 18px var(--glow);}}

/* ===================== CINEMATIC TRANSITION ===================== */
#wipe{position:fixed;inset:0;z-index:9000;pointer-events:none;background:var(--bg1);transform:translateY(-100%);transition:transform 0.8s cubic-bezier(0.7,0,0.3,1);}
#wipe.active{transform:translateY(0);}
#wipe.exit{transform:translateY(100%);}

/* ===================== LAYOUT SHELL - 3D TRANSFORMED ===================== */
.shell{
  position:relative;z-index:4;
  width:100vw;height:100vh;
  display:grid;
  grid-template-rows:60px 44px 1fr;
  grid-template-columns:340px 1fr 290px;
  grid-template-areas:
    "hdr hdr hdr"
    "sport sport sport"
    "left map right";
  transition:transform var(--tr),filter var(--tr);
  transform-style:preserve-3d;
}

/* ===================== HEADER - FLOATING 3D ===================== */
header{
  grid-area:hdr;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;
  background:var(--header-bg);
  backdrop-filter:blur(30px);
  transition:all var(--tr);
  z-index:50;
  transform:translateZ(20px);
}
.logo{display:flex;align-items:baseline;gap:10px;}
.logo-main{
  font-family:'Bebas Neue';font-size:2rem;letter-spacing:var(--letter-spacing);
  color:var(--acc);text-shadow:0 0 25px var(--glow);
  transition:all var(--tr);
}
.logo-dot{color:var(--acc2);transition:color var(--tr);font-size:1.5rem;}
.logo-sub{font-family:'Orbitron';font-size:.45rem;letter-spacing:4px;opacity:.5;text-transform:uppercase;}
.hdr-center{display:flex;align-items:center;gap:8px;}
.theme-pill{
  padding:6px 14px;border-radius:20px;border:2px solid var(--bdr);
  background:rgba(0,0,0,0.3);color:var(--txt);font-family:'Orbitron';font-size:.55rem;
  cursor:pointer;opacity:.5;transition:all .3s;letter-spacing:1px;
  transform:translateZ(10px);
}
.theme-pill.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);opacity:1;font-weight:700;box-shadow:0 0 20px var(--glow);}
.theme-pill:hover:not(.on){opacity:.85;border-color:var(--acc);transform:translateZ(15px) scale(1.05);}
.hdr-right{display:flex;align-items:center;gap:10px;}
.utog{display:flex;border:2px solid var(--bdr);border-radius:8px;overflow:hidden;transition:border-color var(--tr);background:rgba(0,0,0,0.2);}
.ubtn{padding:5px 10px;background:transparent;border:none;color:var(--txt);font-family:'Orbitron';font-size:.55rem;cursor:pointer;opacity:.5;transition:all .25s;}
.ubtn.on{background:var(--acc);color:var(--bg1);opacity:1;font-weight:700;}
.live-clk{font-family:'Orbitron';font-size:.75rem;opacity:.6;letter-spacing:3px;color:var(--acc);}

/* ===================== SPORT BAR - MORPHING ===================== */
.sport-bar{
  grid-area:sport;
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:0 24px;
  background:rgba(0,0,0,.35);
  border-bottom:1px solid var(--bdr);
  transition:all var(--tr);
  backdrop-filter:blur(20px);
}
.sport-btn{
  display:flex;align-items:center;gap:6px;
  padding:8px 18px;border-radius:25px;border:2px solid transparent;
  background:rgba(255,255,255,0.05);color:var(--txt);font-family:'Orbitron';font-size:.55rem;
  cursor:pointer;opacity:.6;transition:all .3s;text-transform:uppercase;letter-spacing:2px;
}
.sport-btn:hover{opacity:.9;border-color:var(--bdr);transform:translateY(-2px);}
.sport-btn.on{
  background:var(--sport-color);color:#fff;opacity:1;
  border-color:var(--sport-color);box-shadow:0 4px 25px var(--sport-color);
  transform:translateY(-3px) scale(1.05);
}
.sport-btn .sicon{font-size:1.1rem;}

/* ===================== LEFT PANEL - FLOATING CARDS ===================== */
.left-panel{
  grid-area:left;
  display:flex;flex-direction:column;gap:10px;
  padding:12px 10px 12px 14px;
  overflow-y:auto;
  background:linear-gradient(90deg, rgba(0,0,0,0.2) 0%, transparent 100%);
  transition:all var(--tr);
}
.left-panel::-webkit-scrollbar{width:4px;}
.left-panel::-webkit-scrollbar-thumb{background:var(--acc);border-radius:4px;}

/* ===================== RIGHT PANEL ===================== */
.right-panel{
  grid-area:right;
  display:flex;flex-direction:column;gap:10px;
  padding:12px 14px 12px 10px;
  overflow-y:auto;
  background:linear-gradient(270deg, rgba(0,0,0,0.2) 0%, transparent 100%);
  transition:all var(--tr);
}
.right-panel::-webkit-scrollbar{width:4px;}
.right-panel::-webkit-scrollbar-thumb{background:var(--acc);border-radius:4px;}

/* ===================== MAP AREA - CINEMATIC ===================== */
.map-wrap{
  grid-area:map;
  position:relative;
  overflow:hidden;
  border-radius:0;
  box-shadow:inset 0 0 100px rgba(0,0,0,0.5);
}
#map{width:100%;height:100%;filter:var(--map-filter);transition:filter var(--tr);}
.map-overlay{position:absolute;inset:0;background:var(--map-overlay);pointer-events:none;z-index:400;transition:all var(--tr);}
.map-vignette{position:absolute;inset:0;pointer-events:none;z-index:401;box-shadow:inset 0 0 150px rgba(0,0,0,0.7);transition:all var(--tr);}
.map-badge{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--card);border:2px solid var(--acc);border-radius:25px;
  padding:6px 18px;font-family:'Orbitron';font-size:.5rem;letter-spacing:3px;
  z-index:500;pointer-events:none;backdrop-filter:blur(15px);
  box-shadow:0 4px 30px rgba(0,0,0,0.5);transition:all var(--tr);color:var(--acc);
}
.map-hint{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--bdr);border-radius:20px;
  padding:6px 16px;font-family:'Orbitron';font-size:.48rem;letter-spacing:2px;opacity:.7;
  z-index:500;pointer-events:none;backdrop-filter:blur(15px);white-space:nowrap;transition:all var(--tr);
}

/* ===================== CARDS - 3D FLOATING ===================== */
.card{
  background:var(--card);
  border:1px solid var(--bdr);
  border-radius:16px;
  padding:14px;
  backdrop-filter:blur(25px);
  transition:all var(--tr),transform .3s,box-shadow .3s;
  box-shadow:0 8px 32px rgba(0,0,0,.5),inset 0 1px 0 var(--shine);
  flex-shrink:0;
  transform:translateZ(0);
  clip-path:var(--card-clip);
}
.card:hover{transform:translateZ(10px) translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,.6),0 0 0 1px var(--acc),inset 0 1px 0 var(--shine);}
.clabel{
  font-family:'Orbitron';font-size:.5rem;letter-spacing:3px;text-transform:uppercase;
  color:var(--acc);margin-bottom:8px;opacity:.8;transition:color var(--tr);
}

/* ===================== CONDITION CARD ===================== */
.cond-badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 16px;border-radius:25px;
  font-family:'Bebas Neue';font-size:1.2rem;letter-spacing:3px;
  color:#fff;margin-bottom:10px;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
.cond-epic{background:linear-gradient(135deg,#00c853,#00e676);box-shadow:0 4px 30px rgba(0,200,83,0.5);}
.cond-good{background:linear-gradient(135deg,#2196f3,#03a9f4);box-shadow:0 4px 30px rgba(33,150,243,0.5);}
.cond-fair{background:linear-gradient(135deg,#ff9800,#ffc107);box-shadow:0 4px 30px rgba(255,152,0,0.5);}
.cond-poor{background:linear-gradient(135deg,#f44336,#e91e63);box-shadow:0 4px 30px rgba(244,67,54,0.5);}
.cond-flat{background:linear-gradient(135deg,#607d8b,#90a4ae);box-shadow:0 4px 30px rgba(96,125,139,0.5);}
.stars{font-size:1rem;letter-spacing:2px;}

/* ===================== WEATHER DISPLAY ===================== */
.main-icon{text-align:center;font-size:56px;padding:8px 0;filter:drop-shadow(0 0 20px var(--glow));transition:filter var(--tr);}
.main-icon span{display:inline-block;animation:float 4s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0) rotate(-3deg);}50%{transform:translateY(-12px) rotate(3deg);}}
.big-temp{
  font-family:'Bebas Neue';font-size:5rem;line-height:1;
  color:var(--acc);text-shadow:0 0 40px var(--glow);
  transition:all var(--tr);
  letter-spacing:2px;
}
.big-temp sup{font-size:1.8rem;vertical-align:top;margin-top:10px;display:inline-block;}
.city-name{font-size:1rem;font-weight:700;margin-top:4px;letter-spacing:1px;}
.city-desc{font-family:'Orbitron';font-size:.6rem;opacity:.6;margin-top:4px;letter-spacing:2px;}

/* ===================== WIND ROSE - ENHANCED ===================== */
.wind-rose{
  width:100px;height:100px;border-radius:50%;
  border:3px solid var(--bdr);
  position:relative;margin:10px auto;
  transition:all var(--tr);
  background:radial-gradient(circle, rgba(0,0,0,0.3) 0%, transparent 70%);
  box-shadow:0 0 30px rgba(0,0,0,0.5),inset 0 0 20px rgba(0,0,0,0.3);
}
.wr-labels{position:absolute;inset:0;font-family:'Orbitron';font-size:.4rem;opacity:.6;}
.wr-labels span{position:absolute;line-height:1;}
.wr-n{top:6px;left:50%;transform:translateX(-50%);}
.wr-s{bottom:6px;left:50%;transform:translateX(-50%);}
.wr-e{right:6px;top:50%;transform:translateY(-50%);}
.wr-w{left:6px;top:50%;transform:translateY(-50%);}
.wr-ne{top:14px;right:14px;}.wr-nw{top:14px;left:14px;}
.wr-se{bottom:14px;right:14px;}.wr-sw{bottom:14px;left:14px;}
.wr-needle{
  position:absolute;width:5px;height:40px;
  background:linear-gradient(to bottom,var(--sport-color) 60%,transparent);
  left:50%;top:10px;transform:translateX(-50%) rotate(var(--wd,0deg));
  transform-origin:bottom center;border-radius:3px;
  transition:transform 1.5s cubic-bezier(0.4,0,0.2,1),background var(--tr);
  box-shadow:0 0 10px var(--sport-color);
}
.wr-center{
  position:absolute;width:14px;height:14px;border-radius:50%;
  background:var(--sport-color);left:50%;top:50%;transform:translate(-50%,-50%);
  transition:background var(--tr);
  box-shadow:0 0 15px var(--sport-color);
}
.wr-info{text-align:center;margin-top:8px;}
.wr-speed{font-family:'Bebas Neue';font-size:1.8rem;color:var(--acc);transition:color var(--tr);}
.wr-dir{font-family:'Orbitron';font-size:.55rem;opacity:.65;letter-spacing:1px;}
.wr-beaufort{font-family:'Orbitron';font-size:.45rem;opacity:.5;margin-top:3px;letter-spacing:1px;}

/* ===================== KITE RATING BAR ===================== */
.kite-bar{margin-top:10px;}
.kite-track{height:10px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);}
.kite-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,#4CAF50,#8BC34A,#FFEB3B,#FF9800,#f44336);transition:width .6s cubic-bezier(0.4,0,0.2,1);box-shadow:0 0 10px currentColor;}
.kite-label{display:flex;justify-content:space-between;margin-top:4px;font-family:'Orbitron';font-size:.45rem;opacity:.6;letter-spacing:1px;}

/* ===================== WAVE CARD ===================== */
.wave-display{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.wave-icon{font-size:2.5rem;filter:drop-shadow(0 0 10px var(--acc));}
.wave-data{flex:1;}
.wave-height{font-family:'Bebas Neue';font-size:2.2rem;color:var(--acc);line-height:1;transition:color var(--tr);}
.wave-height sup{font-size:0.9rem;}
.wave-period{font-family:'Orbitron';font-size:.55rem;opacity:.7;margin-top:2px;letter-spacing:1px;}
.wave-dir{font-family:'Orbitron';font-size:.5rem;opacity:.5;letter-spacing:1px;}
.swell-strip{display:flex;gap:4px;overflow-x:auto;padding:6px 0;margin-top:8px;}
.swell-strip::-webkit-scrollbar{height:3px;}
.swell-strip::-webkit-scrollbar-thumb{background:var(--acc);border-radius:3px;}
.swell-item{
  flex-shrink:0;width:52px;padding:8px 4px;
  border-radius:10px;border:1px solid var(--bdr);
  text-align:center;font-family:'Orbitron';font-size:.42rem;
  transition:all .2s;background:rgba(0,0,0,0.2);
}
.swell-item:hover{background:rgba(255,255,255,.08);transform:translateY(-2px);}
.swell-item .sw-day{opacity:.5;margin-bottom:3px;letter-spacing:1px;}
.swell-item .sw-icon{font-size:.9rem;}
.swell-item .sw-height{font-weight:700;color:var(--acc);font-size:.6rem;margin-top:2px;}
.swell-item .sw-period{opacity:.5;font-size:.4rem;}
.wave-quality{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:12px;font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;margin-top:6px;}
.wq-epic{background:linear-gradient(135deg,#00c853,#00e676);color:#fff;}
.wq-good{background:linear-gradient(135deg,#2196f3,#03a9f4);color:#fff;}
.wq-fair{background:linear-gradient(135deg,#ff9800,#ffc107);color:#000;}
.wq-poor{background:linear-gradient(135deg,#607d8b,#90a4ae);color:#fff;}
.wq-flat{background:linear-gradient(135deg,#37474f,#546e7a);color:#fff;}
.no-wave-data{font-family:'Orbitron';font-size:.5rem;opacity:.4;text-align:center;padding:20px;letter-spacing:1px;}

/* ===================== HOURLY STRIP ===================== */
.hour-strip{display:flex;gap:4px;overflow-x:auto;padding:6px 0;}
.hour-strip::-webkit-scrollbar{height:3px;}
.hour-strip::-webkit-scrollbar-thumb{background:var(--acc);border-radius:3px;}
.hour-item{
  flex-shrink:0;width:48px;padding:8px 3px;
  border-radius:10px;border:1px solid var(--bdr);
  text-align:center;font-family:'Orbitron';font-size:.45rem;
  transition:all .2s;cursor:pointer;
  background:rgba(0,0,0,0.2);
}
.hour-item:hover{background:rgba(255,255,255,.08);transform:translateY(-2px);}
.hour-item.peak{border-color:var(--sport-color);background:rgba(var(--sport-color),.15);box-shadow:0 0 15px var(--sport-color);}
.hour-item .htime{opacity:.5;margin-bottom:3px;letter-spacing:1px;}
.hour-item .hicon{font-size:.9rem;}
.hour-item .htemp{font-weight:700;color:var(--acc);transition:color var(--tr);font-size:.55rem;}
.hour-item .hwind{opacity:.6;font-size:.4rem;margin-top:2px;}

/* ===================== WIND TABLE (Windguru style) ===================== */
.wind-table{width:100%;border-collapse:collapse;font-family:'Orbitron';font-size:.45rem;}
.wind-table th,.wind-table td{padding:6px 3px;text-align:center;border:1px solid var(--bdr);transition:border-color var(--tr);}
.wind-table th{background:rgba(0,0,0,.3);font-weight:500;opacity:.7;text-transform:uppercase;letter-spacing:1px;}
.wind-table .wt-icon{font-size:.85rem;}
.wind-table .wt-temp{color:var(--acc);font-weight:700;transition:color var(--tr);}
.wind-table .wt-wind{font-weight:600;}
.wind-table .wt-gust{opacity:.6;font-size:.4rem;}
.wind-table .wt-precip{color:#4fc3f7;}

/* ===================== STATE GRID ===================== */
.stgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;max-height:170px;overflow-y:auto;padding-right:3px;}
.stgrid::-webkit-scrollbar{width:3px;}
.stgrid::-webkit-scrollbar-thumb{background:var(--acc);border-radius:3px;}
.stbtn{padding:6px 3px;border-radius:8px;border:1px solid var(--bdr);background:rgba(0,0,0,0.2);color:var(--txt);font-family:'Orbitron';font-size:.45rem;cursor:pointer;text-align:center;opacity:.6;transition:all .2s;}
.stbtn:hover{background:rgba(255,255,255,.1);border-color:var(--acc);opacity:1;transform:scale(1.05);}
.stbtn.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);opacity:1;font-weight:700;box-shadow:0 0 15px var(--glow);}

/* ===================== SPOTS GRID ===================== */
.spots-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;max-height:130px;overflow-y:auto;}
.spot-btn{
  padding:8px 6px;border-radius:8px;border:1px solid var(--bdr);
  background:rgba(0,0,0,0.2);color:var(--txt);font-family:'Orbitron';font-size:.42rem;
  cursor:pointer;text-align:left;opacity:.65;transition:all .2s;
  display:flex;align-items:center;gap:5px;
}
.spot-btn:hover{background:rgba(255,255,255,.08);opacity:1;border-color:var(--sport-color);transform:translateX(3px);}
.spot-btn .spot-icon{font-size:.75rem;}
.spot-btn .spot-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ===================== TABS ===================== */
.tabs{display:flex;gap:3px;padding:3px;background:rgba(0,0,0,.3);border-radius:10px;margin-bottom:10px;}
.tbtn{flex:1;padding:6px;border:none;background:transparent;color:var(--txt);font-family:'Orbitron';font-size:.45rem;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:8px;opacity:.5;transition:all .2s;}
.tbtn.on{background:var(--card);border:1px solid var(--bdr);opacity:1;color:var(--acc);}
.tcont{display:none;}
.tcont.on{display:block;}

/* ===================== METAS GRID ===================== */
.metas{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--bdr);transition:border-color var(--tr);}
.meta{display:flex;flex-direction:column;gap:2px;}
.mlabel{font-family:'Orbitron';font-size:.4rem;letter-spacing:2px;text-transform:uppercase;opacity:.4;}
.mval{font-size:.85rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== SEARCH ===================== */
.search-wrap{position:relative;}
.search-input{
  width:100%;padding:10px 14px 10px 36px;
  background:rgba(0,0,0,0.3);border:2px solid var(--bdr);border-radius:12px;
  color:var(--txt);font-family:'Orbitron';font-size:.6rem;letter-spacing:1px;
  outline:none;transition:all .3s;
}
.search-input:focus{border-color:var(--acc);box-shadow:0 0 20px var(--glow);background:rgba(0,0,0,0.5);}
.search-input::placeholder{opacity:.4;}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.4;font-size:.8rem;pointer-events:none;}
.search-results{
  position:absolute;top:calc(100% + 6px);left:0;right:0;z-index:600;
  background:var(--card);border:2px solid var(--bdr);border-radius:12px;
  backdrop-filter:blur(25px);overflow:hidden;display:none;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.search-results.show{display:block;}
.search-item{padding:8px 12px;font-family:'Orbitron';font-size:.55rem;cursor:pointer;opacity:.75;transition:all .15s;letter-spacing:1px;}
.search-item:hover{background:rgba(255,255,255,.1);opacity:1;padding-left:18px;}

/* ===================== MAP POPUP ===================== */
.leaflet-popup-content-wrapper{
  background:var(--card)!important;border:2px solid var(--acc)!important;
  border-radius:16px!important;backdrop-filter:blur(25px);
  box-shadow:0 12px 48px rgba(0,0,0,.6)!important;
  color:var(--txt)!important;font-family:'Syne',sans-serif!important;
}
.leaflet-popup-tip{background:var(--card)!important;border:2px solid var(--acc)!important;}
.leaflet-popup-close-button{color:var(--acc)!important;font-size:1.2rem!important;}
.pop-content{min-width:180px;padding:6px;}
.pop-title{font-family:'Bebas Neue';font-size:1.4rem;letter-spacing:3px;color:var(--acc);transition:color var(--tr);}
.pop-temp{font-family:'Bebas Neue';font-size:2.8rem;line-height:1;color:var(--acc);transition:color var(--tr);}
.pop-desc{font-family:'Orbitron';font-size:.55rem;opacity:.6;margin-top:3px;letter-spacing:1px;}
.pop-meta{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--bdr);}
.pop-m{display:flex;flex-direction:column;}
.pop-ml{font-family:'Orbitron';font-size:.4rem;letter-spacing:1px;opacity:.4;text-transform:uppercase;}
.pop-mv{font-size:.8rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== SPINNER & LOADING ===================== */
.spin{display:inline-block;width:14px;height:14px;border:2px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle;margin-right:5px;}
@keyframes sp{to{transform:rotate(360deg)}}
@keyframes locpulse{0%{box-shadow:0 0 0 0 var(--glow);}70%{box-shadow:0 0 0 15px rgba(0,0,0,0);}100%{box-shadow:0 0 0 0 rgba(0,0,0,0);}}
.loc-dot{width:16px;height:16px;border-radius:50%;background:var(--acc);border:3px solid white;animation:locpulse 2s infinite;box-shadow:0 0 20px var(--acc);}
#loading{
  position:fixed;inset:0;z-index:9999;background:var(--bg1);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .6s;
}
#loading.hide{opacity:0;pointer-events:none;}
.load-logo{font-family:'Bebas Neue';font-size:4rem;letter-spacing:10px;color:var(--acc);text-shadow:0 0 40px var(--glow);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.8;transform:scale(1.02);}}
.load-sub{font-family:'Orbitron';font-size:.55rem;letter-spacing:5px;opacity:.5;text-transform:uppercase;}
.load-bar{width:220px;height:4px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;margin-top:8px;}
.load-prog{height:100%;background:linear-gradient(90deg,var(--acc2),var(--acc));border-radius:3px;animation:loadprog 2.5s ease forwards;box-shadow:0 0 15px var(--acc);}
@keyframes loadprog{from{width:0%}to{width:100%}}

/* ===================== SCROLLBAR ===================== */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:var(--acc);border-radius:4px;}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);}

/* ===================== RESPONSIVE ===================== */
@media(max-width:1100px){
  .shell{grid-template-columns:300px 1fr 0px;grid-template-areas:"hdr hdr hdr" "sport sport sport" "left map map";}
  .right-panel{display:none;}
}
@media(max-width:680px){
  .shell{grid-template-columns:0px 1fr 0px;grid-template-areas:"hdr hdr hdr" "sport sport sport" "map map map";transform:none!important;}
  .left-panel{display:none;}
  .sport-bar{overflow-x:auto;justify-content:flex-start;}
  header{padding:0 12px;}
  .logo-main{font-size:1.4rem;}
  .hdr-center{display:none;}
}
</style>
</head>
<body class="theme-rain mode-surf">

<!-- LOADING -->
<div id="loading">
  <div class="load-logo">MetBrasil</div>
  <div class="load-sub">Inteligencia Climatica</div>
  <div class="load-bar"><div class="load-prog"></div></div>
</div>

<!-- WEATHER ALERT BANNER -->
<div class="alert-banner" id="alertBanner">
  <div class="alert-content" id="alertContent">
    <span class="alert-icon" id="alertIcon">‚ö†Ô∏è</span>
    <span class="alert-text" id="alertText">ALERTA</span>
    <button class="alert-close" id="alertClose">&times;</button>
  </div>
</div>

<!-- SPOT MODAL -->
<div class="spot-modal" id="spotModal">
  <div class="spot-modal-content">
    <div class="spot-modal-header">
      <div class="spot-modal-title">
        <span class="smt-icon" id="smtIcon">üèñÔ∏è</span>
        <span id="smtName">SPOT</span>
      </div>
      <button class="spot-modal-close" id="spotModalClose">&times;</button>
    </div>
    <div class="spot-modal-body">
      <div class="spot-current" id="spotCurrent">
        <div class="spot-current-icon" id="scIcon">‚õÖ</div>
        <div class="spot-current-data">
          <div class="spot-current-temp" id="scTemp">--¬∞</div>
          <div class="spot-current-desc" id="scDesc">CARREGANDO...</div>
          <div class="spot-current-meta">
            <span>üí® <span id="scWind">--</span></span>
            <span>üíß <span id="scHum">--%</span></span>
            <span>üåä <span id="scWave">--</span></span>
          </div>
        </div>
      </div>
      <div class="spot-forecast-title">üìÖ PREVISAO 7 DIAS</div>
      <div class="spot-forecast-grid" id="spotForecast"></div>
    </div>
  </div>
</div>

<!-- CINEMATIC WIPE -->
<div id="wipe"></div>

<!-- IMMERSIVE FX LAYERS -->
<canvas id="fx"></canvas>
<div id="fx-overlay"></div>
<div id="lightning"></div>
<div id="sunrays"></div>
<div id="fog"></div>

<!-- SHELL -->
<div class="shell">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <span class="logo-main">Met<span class="logo-dot">:</span>Brasil</span>
      <span class="logo-sub">metbrasil.com.br</span>
    </div>
    <div class="hdr-center">
      <button class="theme-pill on" data-t="rain">&#9729; CHUVA</button>
      <button class="theme-pill" data-t="sun">&#9728; SOL</button>
      <button class="theme-pill" data-t="cloudy">&#9730; NUBLADO</button>
    </div>
    <div class="hdr-right">
      <div class="utog">
        <button class="ubtn on" id="bC">C</button>
        <button class="ubtn" id="bF">F</button>
      </div>
      <div class="utog">
        <button class="ubtn on" id="bKmh">KM/H</button>
        <button class="ubtn" id="bKt">NOS</button>
      </div>
      <div class="night-indicator" id="nightIndicator" title="Modo dia/noite automatico">
        <span class="ni-icon" id="niIcon">&#9728;&#65039;</span>
        <span class="ni-text" id="niText">DIA</span>
      </div>
      <span class="live-clk" id="clk">--:--</span>
    </div>
  </header>

  <!-- SPORT BAR -->
  <div class="sport-bar">
    <button class="sport-btn on" data-sport="surf"><span class="sicon">&#127940;</span>SURF</button>
    <button class="sport-btn" data-sport="kite"><span class="sicon">&#129667;</span>KITE</button>
    <button class="sport-btn" data-sport="wind"><span class="sicon">&#127940;</span>WINDSURF</button>
    <button class="sport-btn" data-sport="para"><span class="sicon">&#129666;</span>PARAPENTE</button>
    <button class="sport-btn" data-sport="sail"><span class="sicon">&#9973;</span>VELA</button>
    <button class="sport-btn" data-sport="fish"><span class="sicon">&#127907;</span>PESCA</button>
  </div>

  <!-- LEFT PANEL -->
  <div class="left-panel">

    <!-- SEARCH -->
    <div class="card" style="padding:12px;">
      <div class="search-wrap">
        <span class="search-icon">&#128269;</span>
        <input class="search-input" id="searchInput" type="text" placeholder="BUSCAR LOCAL...">
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <!-- CONDITION -->
    <div class="card">
      <div class="clabel">&#127919; CONDICAO ATUAL</div>
      <div id="condBadge" class="cond-badge cond-good">BOM <span class="stars">&#9733;&#9733;&#9733;&#9733;&#9734;</span></div>
      <div class="main-icon"><span id="micon">&#9928;&#65039;</span></div>
      <div class="big-temp" id="mtemp">--<sup>C</sup></div>
      <div class="city-name" id="mcity"><span class="spin"></span>Detectando...</div>
      <div class="city-desc" id="mdesc">Aguardando dados...</div>
    </div>

    <!-- WIND ROSE -->
    <div class="card">
      <div class="clabel">&#127744; VENTO</div>
      <div class="wind-rose">
        <div class="wr-labels">
          <span class="wr-n">N</span><span class="wr-s">S</span>
          <span class="wr-e">L</span><span class="wr-w">O</span>
          <span class="wr-ne">NE</span><span class="wr-nw">NO</span>
          <span class="wr-se">SE</span><span class="wr-sw">SO</span>
        </div>
        <div class="wr-needle" id="wrNeedle"></div>
        <div class="wr-center"></div>
      </div>
      <div class="wr-info">
        <div class="wr-speed" id="wrSpeed">-- km/h</div>
        <div class="wr-dir" id="wrDir">--</div>
        <div class="wr-beaufort" id="wrBeaufort">--</div>
      </div>
      <div class="kite-bar">
        <div class="clabel" style="margin-bottom:4px;">&#129667; RATING KITE</div>
        <div class="kite-track"><div class="kite-fill" id="kiteFill" style="width:0%"></div></div>
        <div class="kite-label"><span>FRACO</span><span id="kiteVal">0/10</span><span>FORTE</span></div>
      </div>
    </div>

    <!-- HOURLY -->
    <div class="card">
      <div class="clabel">&#128337; PREVISAO 12H</div>
      <div class="hour-strip" id="hourStrip"></div>
    </div>

    <!-- WAVES -->
    <div class="card" id="waveCard">
      <div class="clabel">&#127754; ONDAS</div>
      <div id="waveContent">
        <div class="no-wave-data">CARREGANDO DADOS DE ONDAS...</div>
      </div>
    </div>

    <!-- METAS -->
    <div class="card">
      <div class="clabel">&#128202; DADOS</div>
      <div class="metas">
        <div class="meta"><span class="mlabel">SENSACAO</span><span class="mval" id="mfeel">--</span></div>
        <div class="meta"><span class="mlabel">UMIDADE</span><span class="mval" id="mhum">--%</span></div>
        <div class="meta"><span class="mlabel">RAJADAS</span><span class="mval" id="mgust">--</span></div>
        <div class="meta"><span class="mlabel">PRESSAO</span><span class="mval" id="mpress">--</span></div>
        <div class="meta"><span class="mlabel">VISIB.</span><span class="mval" id="mvis">--</span></div>
        <div class="meta"><span class="mlabel">NUVENS</span><span class="mval" id="mclouds">--%</span></div>
      </div>
    </div>

  </div>

  <!-- MAP -->
  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-overlay"></div>
    <div class="map-vignette"></div>
    <div class="map-hint">&#128433;&#65039; CLIQUE NO MAPA</div>
    <div class="map-badge">MET:BRASIL</div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <!-- WIND TABLE -->
    <div class="card">
      <div class="clabel">&#128168; VENTO 5 DIAS</div>
      <table class="wind-table" id="windTable">
        <thead><tr><th>DIA</th><th></th><th>TEMP</th><th>VENTO</th><th>RAJ</th><th>&#128167;</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TABS: STATES / SPOTS -->
    <div class="card" style="flex:1;min-height:0;">
      <div class="tabs">
        <button class="tbtn on" data-tab="states">ESTADOS</button>
        <button class="tbtn" data-tab="spots">SPOTS</button>
      </div>
      <div class="tcont on" id="tc-states">
        <div class="stgrid" id="stgrid"></div>
      </div>
      <div class="tcont" id="tc-spots">
        <div class="spots-grid" id="spotsGrid"></div>
      </div>
    </div>

    <!-- LEGEND -->
    <div class="card">
      <div class="clabel">&#127777;&#65039; LEGENDA</div>
      <div style="display:flex;flex-direction:column;gap:5px;font-family:'Orbitron';font-size:.5rem;opacity:.7;letter-spacing:1px;">
        <div style="display:flex;align-items:center;gap:8px;"><div style="width:12px;height:12px;border-radius:50%;background:#4CAF50;box-shadow:0 0 8px #4CAF50;"></div><span>&lt; 20C</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><div style="width:12px;height:12px;border-radius:50%;background:#FF9800;box-shadow:0 0 8px #FF9800;"></div><span>20-30C</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><div style="width:12px;height:12px;border-radius:50%;background:#f44336;box-shadow:0 0 8px #f44336;"></div><span>&gt; 30C</span></div>
      </div>
    </div>

  </div>
</div>

<!-- JAVASCRIPT -->
<script>
// ============ DATA ============
const STATES=[
  {code:'AC',name:'Acre',lat:-9.97,lon:-67.81},{code:'AL',name:'Alagoas',lat:-9.57,lon:-36.78},
  {code:'AM',name:'Amazonas',lat:-3.07,lon:-60.03},{code:'AP',name:'Amapa',lat:0.9,lon:-52.0},
  {code:'BA',name:'Bahia',lat:-12.35,lon:-41.7},{code:'CE',name:'Ceara',lat:-3.72,lon:-38.54},
  {code:'DF',name:'Dist. Federal',lat:-15.78,lon:-47.93},{code:'ES',name:'Esp. Santo',lat:-19.83,lon:-40.32},
  {code:'GO',name:'Goias',lat:-15.83,lon:-49.61},{code:'MA',name:'Maranhao',lat:-4.97,lon:-45.3},
  {code:'MG',name:'Minas Gerais',lat:-18.1,lon:-44.38},{code:'MS',name:'Mato G. Sul',lat:-20.44,lon:-54.65},
  {code:'MT',name:'Mato Grosso',lat:-12.64,lon:-55.42},{code:'PA',name:'Para',lat:-3.79,lon:-52.48},
  {code:'PB',name:'Paraiba',lat:-7.24,lon:-36.78},{code:'PE',name:'Pernambuco',lat:-8.38,lon:-38.0},
  {code:'PI',name:'Piaui',lat:-6.6,lon:-42.73},{code:'PR',name:'Parana',lat:-24.89,lon:-51.55},
  {code:'RJ',name:'Rio de Janeiro',lat:-22.84,lon:-43.15},{code:'RN',name:'R. G. Norte',lat:-5.74,lon:-36.67},
  {code:'RO',name:'Rondonia',lat:-10.83,lon:-63.34},{code:'RR',name:'Roraima',lat:2.0,lon:-61.37},
  {code:'RS',name:'R. G. Sul',lat:-30.03,lon:-51.22},{code:'SC',name:'Santa Cat.',lat:-27.59,lon:-48.55},
  {code:'SE',name:'Sergipe',lat:-10.57,lon:-37.38},{code:'SP',name:'Sao Paulo',lat:-23.55,lon:-46.63},
  {code:'TO',name:'Tocantins',lat:-10.17,lon:-48.33},
];

const SPOTS=[
  {name:'Jericoacoara',lat:-2.79,lon:-40.51,type:'kite'},{name:'Cumbuco',lat:-3.63,lon:-38.73,type:'kite'},
  {name:'Prea',lat:-2.92,lon:-40.42,type:'kite'},{name:'Sao M. Gostoso',lat:-5.12,lon:-35.63,type:'wind'},
  {name:'Atins',lat:-2.58,lon:-42.73,type:'kite'},{name:'Florianopolis',lat:-27.59,lon:-48.55,type:'surf'},
  {name:'Ilhabela',lat:-23.78,lon:-45.36,type:'sail'},{name:'Buzios',lat:-22.75,lon:-41.88,type:'surf'},
  {name:'Arraial do Cabo',lat:-22.97,lon:-42.03,type:'surf'},{name:'Saquarema',lat:-22.92,lon:-42.51,type:'surf'},
  {name:'Itacare',lat:-14.28,lon:-38.99,type:'surf'},{name:'Torres',lat:-29.35,lon:-49.73,type:'surf'},
  {name:'Garopaba',lat:-28.02,lon:-48.62,type:'surf'},{name:'Ubatuba',lat:-23.43,lon:-45.07,type:'surf'},
  {name:'Maresias',lat:-23.79,lon:-45.56,type:'surf'},{name:'Guaruja',lat:-23.99,lon:-46.26,type:'surf'},
  {name:'Itamambuca',lat:-23.40,lon:-44.98,type:'surf'},{name:'Pipa',lat:-6.23,lon:-35.06,type:'surf'},
  {name:'Fernando Noronha',lat:-3.85,lon:-32.43,type:'surf'},{name:'Morro de SP',lat:-13.38,lon:-38.91,type:'surf'},
  {name:'Porto de Galinhas',lat:-8.50,lon:-35.00,type:'surf'},{name:'Praia do Forte',lat:-12.58,lon:-38.00,type:'surf'},
  {name:'Balneario Camboriu',lat:-26.99,lon:-48.63,type:'surf'},{name:'Imbituba',lat:-28.24,lon:-48.67,type:'surf'},
  {name:'Cabo Frio',lat:-22.88,lon:-42.03,type:'wind'},{name:'Barra Grande PI',lat:-2.90,lon:-41.40,type:'kite'},
];

// Map tiles per theme
const TILES={
  rain:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  sun:'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
  cloudy:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
};

// ============ STATE ============
let cache={},celsius=true,knots=false,curTheme='rain',curSport='surf',autoMode=true;
let uLat=null,uLon=null,map=null,tileLayer=null,userMarker=null,stateMarkers=[],spotMarkers=[];
let autoThemeTimer=null,lightningInterval=null;

// ============ IMMERSIVE PARTICLES ============
const cv=document.getElementById('fx'),cx=cv.getContext('2d');
let pts=[];
function rcv(){cv.width=innerWidth;cv.height=innerHeight;}
window.addEventListener('resize',rcv);rcv();

class Particle{
  constructor(){this.reset();}
  reset(){
    this.x=Math.random()*cv.width;
    this.y=Math.random()*cv.height;
    this.theme=curTheme;
    if(this.theme==='rain'){
      // Heavy rain drops
      this.vx=-3-Math.random()*2;
      this.vy=15+Math.random()*10;
      this.sz=1+Math.random()*2;
      this.len=15+Math.random()*20;
      this.a=0.2+Math.random()*0.4;
    }else if(this.theme==='sun'){
      // Floating golden particles
      this.vx=(Math.random()-0.5)*0.8;
      this.vy=-0.3-Math.random()*0.5;
      this.sz=2+Math.random()*5;
      this.a=0.15+Math.random()*0.25;
      this.pulse=Math.random()*Math.PI*2;
    }else{
      // Slow drifting fog/clouds
      this.vx=0.3+Math.random()*0.5;
      this.vy=(Math.random()-0.5)*0.15;
      this.sz=50+Math.random()*100;
      this.a=0.03+Math.random()*0.05;
    }
  }
}

function initParticles(){
  const count=curTheme==='rain'?200:curTheme==='sun'?80:12;
  pts=Array.from({length:count},()=>new Particle());
}

function renderParticles(){
  cx.clearRect(0,0,cv.width,cv.height);
  for(const p of pts){
    if(p.theme!==curTheme){p.theme=curTheme;p.reset();}
    cx.save();
    if(curTheme==='rain'){
      // Diagonal rain streaks
      const gradient=cx.createLinearGradient(p.x,p.y,p.x+p.vx*3,p.y+p.len);
      gradient.addColorStop(0,'rgba(79,195,247,0)');
      gradient.addColorStop(0.5,`rgba(79,195,247,${p.a})`);
      gradient.addColorStop(1,'rgba(79,195,247,0)');
      cx.strokeStyle=gradient;
      cx.lineWidth=p.sz;
      cx.lineCap='round';
      cx.beginPath();
      cx.moveTo(p.x,p.y);
      cx.lineTo(p.x+p.vx*3,p.y+p.len);
      cx.stroke();
    }else if(curTheme==='sun'){
      // Glowing orbs with pulse
      p.pulse+=0.02;
      const pulseA=p.a*(0.7+0.3*Math.sin(p.pulse));
      const gradient=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.sz*2);
      gradient.addColorStop(0,`rgba(255,213,79,${pulseA})`);
      gradient.addColorStop(0.5,`rgba(255,150,0,${pulseA*0.5})`);
      gradient.addColorStop(1,'rgba(255,100,0,0)');
      cx.fillStyle=gradient;
      cx.beginPath();
      cx.arc(p.x,p.y,p.sz*2,0,Math.PI*2);
      cx.fill();
    }else{
      // Soft cloud ellipses
      const gradient=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.sz);
      gradient.addColorStop(0,`rgba(139,157,195,${p.a})`);
      gradient.addColorStop(1,'rgba(139,157,195,0)');
      cx.fillStyle=gradient;
      cx.beginPath();
      cx.ellipse(p.x,p.y,p.sz*2.5,p.sz,0,0,Math.PI*2);
      cx.fill();
    }
    cx.restore();
    // Move
    p.x+=p.vx;p.y+=p.vy;
    // Wrap
    if(p.y>cv.height+50){p.y=-50;p.x=Math.random()*cv.width;}
    if(p.x>cv.width+200){p.x=-200;}
    if(p.y<-50){p.y=cv.height+50;}
    if(p.x<-200){p.x=cv.width+200;}
  }
  requestAnimationFrame(renderParticles);
}
initParticles();renderParticles();

// ============ LIGHTNING EFFECT ============
function triggerLightning(){
  if(curTheme!=='rain')return;
  const lightning=document.getElementById('lightning');
  lightning.style.opacity='0.7';
  setTimeout(()=>{lightning.style.opacity='0';},80);
  setTimeout(()=>{lightning.style.opacity='0.4';},150);
  setTimeout(()=>{lightning.style.opacity='0';},200);
}
function startLightning(){
  stopLightning();
  lightningInterval=setInterval(()=>{
    if(Math.random()<0.3)triggerLightning();
  },4000);
}
function stopLightning(){
  if(lightningInterval){clearInterval(lightningInterval);lightningInterval=null;}
  document.getElementById('lightning').style.opacity='0';
}

// ============ THEME SYSTEM (CINEMATIC) ============
function wmoToTheme(wCode){
  if(wCode<=2)return'sun';
  if(wCode<=49)return'cloudy';
  return'rain';
}

function setTheme(t,manual=false){
  if(curTheme===t&&!manual)return;

  // Cinematic wipe transition
  const wipe=document.getElementById('wipe');
  wipe.style.background=getComputedStyle(document.body).getPropertyValue('--bg1');
  wipe.classList.add('active');

  setTimeout(()=>{
    curTheme=t;
    document.body.className='theme-'+t+' mode-'+curSport;
    document.querySelectorAll('.theme-pill').forEach(p=>p.classList.toggle('on',p.dataset.t===t));

    // Change map tiles
    if(map&&tileLayer){
      map.removeLayer(tileLayer);
      tileLayer=L.tileLayer(TILES[t],{attribution:'&copy; OSM &copy; CARTO',subdomains:'abcd',maxZoom:18}).addTo(map);
    }

    // Reinit particles with fade
    setTimeout(()=>initParticles(),200);

    // Lightning only for rain
    if(t==='rain'){startLightning();}else{stopLightning();}

    // Refresh markers
    if(map)refreshMarkers();

    wipe.classList.remove('active');
    wipe.classList.add('exit');
    setTimeout(()=>{wipe.classList.remove('exit');},800);
  },400);

  if(manual){
    autoMode=false;
    clearTimeout(autoThemeTimer);
    autoThemeTimer=setTimeout(()=>{autoMode=true;},30000);
  }
}

function setThemeByWeather(wCode){
  if(!autoMode)return;
  setTheme(wmoToTheme(wCode));
}

document.querySelectorAll('.theme-pill').forEach(b=>{
  b.addEventListener('click',()=>setTheme(b.dataset.t,true));
});

// ============ SPORT MODE ============
document.querySelectorAll('.sport-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    curSport=b.dataset.sport;
    document.querySelectorAll('.sport-btn').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.body.className='theme-'+curTheme+' mode-'+curSport;
    if(map)refreshMarkers();
  });
});

// ============ CLOCK & NIGHT MODE ============
let isNight=false,nightModeAuto=true;
function isNightTime(hour){return hour>=18||hour<6;}
function updateNightMode(forceNight=null){
  const brt=new Date(new Date().toLocaleString('en',{timeZone:'America/Sao_Paulo'}));
  const hour=brt.getHours();
  const shouldBeNight=forceNight!==null?forceNight:(nightModeAuto?isNightTime(hour):isNight);
  if(shouldBeNight!==isNight){
    isNight=shouldBeNight;
    document.body.classList.toggle('night-mode',isNight);
    document.getElementById('niIcon').textContent=isNight?'\uD83C\uDF19':'\u2600\uFE0F';
    document.getElementById('niText').textContent=isNight?'NOITE':'DIA';
    document.getElementById('nightIndicator').classList.toggle('is-night',isNight);
  }
}
function tick(){
  const brt=new Date(new Date().toLocaleString('en',{timeZone:'America/Sao_Paulo'}));
  document.getElementById('clk').textContent=brt.toTimeString().slice(0,5);
  updateNightMode();
}
setInterval(tick,1000);tick();
// Night mode toggle (click to override, returns to auto after 60s)
document.getElementById('nightIndicator').onclick=()=>{
  nightModeAuto=false;
  updateNightMode(!isNight);
  setTimeout(()=>{nightModeAuto=true;},60000);
};

// ============ UNITS ============
document.getElementById('bC').onclick=()=>{celsius=true;document.getElementById('bC').classList.add('on');document.getElementById('bF').classList.remove('on');refreshAll();};
document.getElementById('bF').onclick=()=>{celsius=false;document.getElementById('bF').classList.add('on');document.getElementById('bC').classList.remove('on');refreshAll();};
document.getElementById('bKmh').onclick=()=>{knots=false;document.getElementById('bKmh').classList.add('on');document.getElementById('bKt').classList.remove('on');refreshAll();};
document.getElementById('bKt').onclick=()=>{knots=true;document.getElementById('bKt').classList.add('on');document.getElementById('bKmh').classList.remove('on');refreshAll();};
function toC(c){return celsius?Math.round(c)+'C':Math.round(c*9/5+32)+'F';}
function toN(c){return celsius?Math.round(c):Math.round(c*9/5+32);}
function toW(kmh){return knots?Math.round(kmh/1.852)+' nos':Math.round(kmh)+' km/h';}
function toWn(kmh){return knots?Math.round(kmh/1.852):Math.round(kmh);}

// ============ WMO ============
function wmoIcon(c){if(c===0)return'\u2600\uFE0F';if(c<=2)return'\u26C5';if(c===3)return'\u2601\uFE0F';if(c<=49)return'\uD83C\uDF2B\uFE0F';if(c<=59)return'\uD83C\uDF26\uFE0F';if(c<=69)return'\u2744\uFE0F';if(c<=82)return'\uD83C\uDF27\uFE0F';return'\u26C8\uFE0F';}
function wmoDesc(c){if(c===0)return'CEU LIMPO';if(c<=2)return'PARCIALMENTE NUBLADO';if(c===3)return'NUBLADO';if(c<=49)return'NEVOEIRO';if(c<=59)return'GAROA';if(c<=79)return'NEVE/GRANIZO';if(c<=82)return'CHUVA';return'TEMPESTADE';}

// ============ CONDITION LOGIC ============
function surfCondition(wCode,windKmh){
  if(wCode>=95)return{label:'PERIGOSO',cls:'cond-poor',stars:0};
  if(wCode>=80)return{label:'RUIM',cls:'cond-poor',stars:1};
  if(windKmh<5)return{label:'SEM VENTO',cls:'cond-flat',stars:2};
  if(windKmh>=15&&windKmh<=30&&wCode<=3)return{label:'EPICO!',cls:'cond-epic',stars:5};
  if(windKmh>=10&&windKmh<=35&&wCode<=10)return{label:'BOM',cls:'cond-good',stars:4};
  if(windKmh>=8&&wCode<=20)return{label:'RAZOAVEL',cls:'cond-fair',stars:3};
  return{label:'FRACO',cls:'cond-poor',stars:1};
}
function kiteRating(kmh){if(kmh<8)return 1;if(kmh<12)return 3;if(kmh<16)return 5;if(kmh<22)return 8;if(kmh<30)return 10;if(kmh<40)return 7;if(kmh<50)return 5;return 3;}
function beaufort(kmh){
  if(kmh<1)return'CALMO (0)';if(kmh<6)return'ARAGEM (1)';if(kmh<12)return'BRISA LEVE (2)';if(kmh<20)return'BRISA FRACA (3)';
  if(kmh<29)return'BRISA MODERADA (4)';if(kmh<39)return'BRISA FORTE (5)';if(kmh<50)return'VENTO FRESCO (6)';
  if(kmh<62)return'VENTO FORTE (7)';if(kmh<75)return'VENTANIA (8)';if(kmh<89)return'VENTANIA FORTE (9)';
  if(kmh<103)return'TEMPESTADE (10)';if(kmh<118)return'TEMPESTADE VIOLENTA (11)';return'FURACAO (12)';
}
function windDir16(deg){const dirs=['N','NNE','NE','ENE','L','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];return dirs[Math.round(deg/22.5)%16];}

// ============ WEATHER ALERTS ============
let alertDismissed=false;
function checkAlerts(current,daily){
  if(alertDismissed)return null;
  const precip=daily?.precipitation_probability_max?.[0];
  const wCode=current?.weather_code;
  const wind=current?.wind_speed_10m;
  const gust=current?.wind_gusts_10m;
  const temp=current?.temperature_2m;

  // Priority: Storm > Heavy Rain > Strong Wind > Heat
  if(wCode>=95)return{type:'storm',icon:'‚õàÔ∏è',text:'ALERTA DE TEMPESTADE ¬∑ EVITE ATIVIDADES AO AR LIVRE',cls:'alert-storm'};
  if(precip>=80)return{type:'rain',icon:'üåßÔ∏è',text:`ALTA PROBABILIDADE DE CHUVA (${precip}%) ¬∑ LEVE GUARDA-CHUVA`,cls:'alert-rain'};
  if(gust>=60||wind>=50)return{type:'wind',icon:'üí®',text:`VENTOS FORTES (${Math.round(gust||wind)} KM/H) ¬∑ CUIDADO EM AREAS ABERTAS`,cls:'alert-wind'};
  if(temp>=38)return{type:'heat',icon:'üå°Ô∏è',text:`CALOR EXTREMO (${Math.round(temp)}¬∞C) ¬∑ MANTENHA-SE HIDRATADO`,cls:'alert-heat'};
  return null;
}
function showAlert(alert){
  if(!alert){hideAlert();return;}
  const banner=document.getElementById('alertBanner');
  const content=document.getElementById('alertContent');
  document.getElementById('alertIcon').textContent=alert.icon;
  document.getElementById('alertText').textContent=alert.text;
  content.className='alert-content '+alert.cls;
  banner.classList.add('show');
}
function hideAlert(){
  document.getElementById('alertBanner').classList.remove('show');
}
document.getElementById('alertClose').onclick=()=>{
  alertDismissed=true;
  hideAlert();
  setTimeout(()=>{alertDismissed=false;},300000); // Reset after 5 min
};

// ============ SPOT MODAL ============
const spotModal=document.getElementById('spotModal');
document.getElementById('spotModalClose').onclick=()=>spotModal.classList.remove('show');
spotModal.onclick=(e)=>{if(e.target===spotModal)spotModal.classList.remove('show');};
document.addEventListener('keydown',(e)=>{if(e.key==='Escape')spotModal.classList.remove('show');});

async function openSpotModal(name,lat,lon,type){
  const icons={surf:'üèÑ',kite:'ü™Å',wind:'üèÑ',sail:'‚õµ',fish:'üé£',state:'üìç'};
  document.getElementById('smtIcon').textContent=icons[type]||'üèñÔ∏è';
  document.getElementById('smtName').textContent=name.toUpperCase();
  spotModal.classList.add('show');

  // Show loading state
  document.getElementById('scIcon').textContent='‚è≥';
  document.getElementById('scTemp').textContent='--¬∞';
  document.getElementById('scDesc').textContent='CARREGANDO...';
  document.getElementById('spotForecast').innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;opacity:.5;">CARREGANDO PREVISAO...</div>';

  // Fetch 7-day forecast
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,wind_speed_10m_max&timezone=America%2FSao_Paulo&forecast_days=7`);
    const d=await r.json();
    const c=d.current;

    // Update current conditions
    document.getElementById('scIcon').textContent=wmoIcon(c.weather_code);
    document.getElementById('scTemp').textContent=toN(c.temperature_2m)+'¬∞';
    document.getElementById('scDesc').textContent=wmoDesc(c.weather_code);
    document.getElementById('scWind').textContent=toW(c.wind_speed_10m);
    document.getElementById('scHum').textContent=c.relative_humidity_2m+'%';

    // Try to get wave data
    const marine=await fwMarine(lat,lon);
    if(marine?.current?.wave_height){
      document.getElementById('scWave').textContent=marine.current.wave_height.toFixed(1)+'m';
    }else{
      document.getElementById('scWave').textContent='--';
    }

    // Build 7-day forecast
    const D=['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
    const fg=document.getElementById('spotForecast');
    fg.innerHTML='';
    for(let i=0;i<7;i++){
      const dt=new Date(d.daily.time[i]);
      const div=document.createElement('div');
      div.className='spot-day';
      div.innerHTML=`
        <div class="spot-day-name">${i===0?'HOJE':D[dt.getDay()]}</div>
        <div class="spot-day-icon">${wmoIcon(d.daily.weather_code[i])}</div>
        <div class="spot-day-temps">
          <div class="spot-day-max">${toN(d.daily.temperature_2m_max[i])}¬∞</div>
          <div class="spot-day-min">${toN(d.daily.temperature_2m_min[i])}¬∞</div>
        </div>
        <div class="spot-day-wind">üí® ${toWn(d.daily.wind_speed_10m_max[i])}</div>
        <div class="spot-day-precip">üíß ${d.daily.precipitation_probability_max[i]}%</div>
      `;
      fg.appendChild(div);
    }
  }catch(e){
    document.getElementById('scDesc').textContent='ERRO AO CARREGAR';
    document.getElementById('spotForecast').innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;color:#f44336;">ERRO AO CARREGAR DADOS</div>';
  }
}

// ============ WAVE HELPERS ============
function waveQuality(height){
  if(height===null||height===undefined)return{label:'SEM DADOS',cls:'wq-flat'};
  if(height<0.3)return{label:'FLAT',cls:'wq-flat'};
  if(height<0.8)return{label:'FRACO',cls:'wq-poor'};
  if(height<1.5)return{label:'BOM',cls:'wq-good'};
  if(height<2.5)return{label:'EPICO',cls:'wq-epic'};
  return{label:'GRANDE',cls:'wq-fair'};
}
function waveDir(deg){
  if(deg===null||deg===undefined)return'--';
  const dirs=['N','NE','L','SE','S','SO','O','NO'];
  return dirs[Math.round(deg/45)%8];
}

// ============ FETCH MARINE ============
let marineCache={};
async function fwMarine(lat,lon){
  const k=`m${lat.toFixed(1)},${lon.toFixed(1)}`;
  if(marineCache[k])return marineCache[k];
  try{
    const r=await fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&current=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period&daily=wave_height_max,wave_direction_dominant,wave_period_max,swell_wave_height_max&timezone=America%2FSao_Paulo&forecast_days=5`);
    const d=await r.json();
    marineCache[k]=d;
    return d;
  }catch(e){return null;}
}

// ============ FETCH ============
async function fw(lat,lon){
  const k=`${lat.toFixed(1)},${lon.toFixed(1)}`;
  if(cache[k])return cache[k];
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,surface_pressure,visibility,cloud_cover&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code&timezone=America%2FSao_Paulo&forecast_days=5`);
    const d=await r.json();cache[k]=d;return d;
  }catch(e){return null;}
}

// ============ MAP ============
function initMap(lat,lon){
  map=L.map('map',{center:[lat,lon],zoom:5,zoomControl:true,attributionControl:true});
  tileLayer=L.tileLayer(TILES[curTheme],{attribution:'&copy; OSM &copy; CARTO',subdomains:'abcd',maxZoom:18}).addTo(map);
  map.on('click',async(e)=>{const{lat:lt,lng:ln}=e.latlng;await showMapPopup(lt,ln,null);});
  map.fitBounds([[-34,-74],[5,-28]]);
}
function tempColor(t){if(t===null)return'#8b9dc3';if(t<20)return'#4CAF50';if(t<30)return'#FF9800';return'#f44336';}
function makeIcon(temp,icon,highlight=false){
  const col=tempColor(temp);const sz=highlight?48:40;const t=temp!==null?Math.round(temp)+'':'?';
  return L.divIcon({className:'',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2],popupAnchor:[0,-(sz/2+4)],
    html:`<div style="width:${sz}px;height:${sz}px;border-radius:50%;background:${col};border:3px solid rgba(255,255,255,${highlight?.95:.6});display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 ${highlight?25:15}px ${col},0 4px 12px rgba(0,0,0,.5);font-family:'Bebas Neue',sans-serif;line-height:1;cursor:pointer;${highlight?'transform:scale(1.15);':''}"><span style="font-size:${highlight?'1rem':'.85rem'};color:white;font-weight:700;">${t}</span><span style="font-size:${highlight?'.85rem':'.7rem'};margin-top:-2px;">${icon}</span></div>`
  });
}
function makeSpotIcon(type){
  const colors={surf:'#0097a7',kite:'#7c4dff',wind:'#00897b',sail:'#1565c0',fish:'#558b2f'};
  const icons={surf:'\uD83C\uDFC4',kite:'\uD83E\uDE81',wind:'\uD83C\uDFC4',sail:'\u26F5',fish:'\uD83C\uDFA3'};
  const col=colors[type]||'#0097a7';const ico=icons[type]||'\uD83C\uDFC4';
  return L.divIcon({className:'',iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-20],
    html:`<div style="width:32px;height:32px;border-radius:50%;background:${col};border:3px solid white;display:flex;align-items:center;justify-content:center;box-shadow:0 0 15px ${col};font-size:1rem;cursor:pointer;">${ico}</div>`
  });
}
function makeUserIcon(){return L.divIcon({className:'',iconSize:[20,20],iconAnchor:[10,10],html:`<div class="loc-dot"></div>`});}

// ============ MARKERS ============
async function placeStateMarkers(){
  const ps=STATES.map(s=>fw(s.lat,s.lon).then(d=>({s,d})));
  const res=await Promise.all(ps);
  res.forEach(({s,d})=>{
    s._t=d?d.current.temperature_2m:null;s._h=d?d.current.relative_humidity_2m:null;
    s._w=d?d.current.wind_speed_10m:null;s._wdir=d?d.current.wind_direction_10m:null;
    s._c=d?d.current.weather_code:0;s._daily=d?d.daily:null;s._hourly=d?d.hourly:null;
    s._prec=d?d.daily.precipitation_probability_max[0]:null;
    s._feel=d?d.current.apparent_temperature:null;s._gust=d?d.current.wind_gusts_10m:null;
    const icon=makeIcon(s._t,wmoIcon(s._c));
    const marker=L.marker([s.lat,s.lon],{icon}).addTo(map);
    marker.on('click',()=>{selState(s);showStatePopup(s,marker);});
    stateMarkers.push({s,marker});
  });
  buildStateGrid(res);
  placeSpotMarkers();
  setTimeout(()=>document.getElementById('loading').classList.add('hide'),500);
}
async function placeSpotMarkers(){
  SPOTS.forEach(sp=>{
    const marker=L.marker([sp.lat,sp.lon],{icon:makeSpotIcon(sp.type)}).addTo(map);
    marker.on('click',()=>{openSpotModal(sp.name,sp.lat,sp.lon,sp.type);});
    spotMarkers.push({sp,marker});
  });
  buildSpotsGrid();
}
function refreshMarkers(){
  stateMarkers.forEach(({s,marker})=>{marker.setIcon(makeIcon(s._t,wmoIcon(s._c)));});
  if(userMarker)userMarker.setIcon(makeUserIcon());
}

// ============ POPUPS ============
function showStatePopup(s,marker){
  const html=`<div class="pop-content"><div class="pop-title">${s.name.toUpperCase()}</div><div style="display:flex;align-items:baseline;gap:8px;"><div class="pop-temp">${toN(s._t||0)}</div><div style="font-size:.9rem;opacity:.6;">${celsius?'C':'F'}</div><div style="font-size:1.6rem;margin-left:6px;">${wmoIcon(s._c)}</div></div><div class="pop-desc">${wmoDesc(s._c)}</div><div class="pop-meta"><div class="pop-m"><span class="pop-ml">VENTO</span><span class="pop-mv">${toW(s._w||0)}</span></div><div class="pop-m"><span class="pop-ml">RAJADAS</span><span class="pop-mv">${toW(s._gust||0)}</span></div><div class="pop-m"><span class="pop-ml">UMIDADE</span><span class="pop-mv">${s._h||'--'}%</span></div><div class="pop-m"><span class="pop-ml">CHUVA</span><span class="pop-mv">${s._prec!==null?s._prec+'%':'--'}</span></div></div></div>`;
  marker.bindPopup(html,{maxWidth:240}).openPopup();
}
async function showMapPopup(lat,lon,name){
  const d=await fw(lat,lon);if(!d)return;const c=d.current;
  const tmpMk=L.marker([lat,lon],{icon:makeIcon(c.temperature_2m,wmoIcon(c.weather_code),true)}).addTo(map);
  const html=`<div class="pop-content"><div class="pop-title">${name?name.toUpperCase():'\uD83D\uDCCD '+lat.toFixed(2)+', '+lon.toFixed(2)}</div><div style="display:flex;align-items:baseline;gap:8px;"><div class="pop-temp">${toN(c.temperature_2m)}</div><div style="font-size:.9rem;opacity:.6;">${celsius?'C':'F'}</div><div style="font-size:1.6rem;margin-left:6px;">${wmoIcon(c.weather_code)}</div></div><div class="pop-desc">${wmoDesc(c.weather_code)}</div><div class="pop-meta"><div class="pop-m"><span class="pop-ml">VENTO</span><span class="pop-mv">${toW(c.wind_speed_10m)}</span></div><div class="pop-m"><span class="pop-ml">RAJADAS</span><span class="pop-mv">${toW(c.wind_gusts_10m)}</span></div><div class="pop-m"><span class="pop-ml">UMIDADE</span><span class="pop-mv">${c.relative_humidity_2m}%</span></div><div class="pop-m"><span class="pop-ml">PRESSAO</span><span class="pop-mv">${Math.round(c.surface_pressure)} hPa</span></div></div></div>`;
  tmpMk.bindPopup(html,{maxWidth:240}).openPopup();
  tmpMk.on('popupclose',()=>map.removeLayer(tmpMk));
}

// ============ LOAD MAIN ============
async function loadMain(lat,lon,city){
  const d=await fw(lat,lon);if(!d)return;const c=d.current;
  setThemeByWeather(c.weather_code);
  document.getElementById('mcity').textContent=city.toUpperCase();
  document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'C':'F')+'</sup>';
  document.getElementById('mdesc').textContent=wmoDesc(c.weather_code);
  document.getElementById('micon').textContent=wmoIcon(c.weather_code);
  document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
  document.getElementById('mhum').textContent=c.relative_humidity_2m+'%';
  document.getElementById('mgust').textContent=toW(c.wind_gusts_10m);
  document.getElementById('mpress').textContent=Math.round(c.surface_pressure)+' hPa';
  document.getElementById('mvis').textContent=c.visibility?(c.visibility/1000).toFixed(1)+' km':'--';
  document.getElementById('mclouds').textContent=c.cloud_cover+'%';
  document.getElementById('wrNeedle').style.setProperty('--wd',c.wind_direction_10m+'deg');
  document.getElementById('wrSpeed').textContent=toW(c.wind_speed_10m);
  document.getElementById('wrDir').textContent=windDir16(c.wind_direction_10m)+' ('+Math.round(c.wind_direction_10m)+')';
  document.getElementById('wrBeaufort').textContent=beaufort(c.wind_speed_10m);
  const kr=kiteRating(c.wind_speed_10m);
  document.getElementById('kiteFill').style.width=(kr*10)+'%';
  document.getElementById('kiteVal').textContent=kr+'/10';
  const cond=surfCondition(c.weather_code,c.wind_speed_10m);
  const badge=document.getElementById('condBadge');
  badge.className='cond-badge '+cond.cls;
  badge.innerHTML=cond.label+' <span class="stars">'+'&#9733;'.repeat(cond.stars)+'&#9734;'.repeat(5-cond.stars)+'</span>';
  buildHours(d.hourly);
  buildWindTable(d.daily);
  // Check for weather alerts
  const alert=checkAlerts(c,d.daily);
  showAlert(alert);
  // Load marine/wave data
  fwMarine(lat,lon).then(marine=>buildWaves(marine));
  if(userMarker)map.removeLayer(userMarker);
  userMarker=L.marker([lat,lon],{icon:makeUserIcon(),zIndexOffset:1000}).addTo(map);
}

// ============ BUILD HOURS ============
function buildHours(hourly){
  const now=new Date();const baseHour=now.getHours();
  const strip=document.getElementById('hourStrip');strip.innerHTML='';
  let peakWind=0,peakIdx=0;
  for(let i=0;i<12;i++){
    const idx=baseHour+i;if(idx>=hourly.time.length)break;
    if(hourly.wind_speed_10m[idx]>peakWind){peakWind=hourly.wind_speed_10m[idx];peakIdx=i;}
  }
  for(let i=0;i<12;i++){
    const idx=baseHour+i;if(idx>=hourly.time.length)break;
    const el=document.createElement('div');
    el.className='hour-item'+(i===peakIdx?' peak':'');
    const hr=(baseHour+i)%24;
    el.innerHTML=`<div class="htime">${String(hr).padStart(2,'0')}H</div><div class="hicon">${wmoIcon(hourly.weather_code[idx])}</div><div class="htemp">${toN(hourly.temperature_2m[idx])}</div><div class="hwind">${toWn(hourly.wind_speed_10m[idx])}${knots?' KT':''}</div>`;
    strip.appendChild(el);
  }
}

// ============ BUILD WIND TABLE ============
function buildWindTable(daily){
  const D=['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
  const tbody=document.querySelector('#windTable tbody');tbody.innerHTML='';
  for(let i=0;i<5;i++){
    const dt=new Date(daily.time[i]);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i===0?'HOJE':D[dt.getDay()]}</td><td class="wt-icon">${wmoIcon(daily.weather_code[i])}</td><td class="wt-temp">${toN(daily.temperature_2m_max[i])}</td><td class="wt-wind">${toWn(daily.wind_speed_10m_max[i])}</td><td class="wt-gust">(${toWn(daily.wind_gusts_10m_max[i])})</td><td class="wt-precip">${daily.precipitation_probability_max[i]}%</td>`;
    tbody.appendChild(tr);
  }
}

// ============ BUILD WAVES ============
function buildWaves(marine){
  const container=document.getElementById('waveContent');
  if(!marine||!marine.current){
    container.innerHTML='<div class="no-wave-data">SEM DADOS DE ONDAS PARA ESTA LOCALIZACAO</div>';
    return;
  }
  const cur=marine.current;
  const daily=marine.daily;
  const wh=cur.wave_height;
  const swh=cur.swell_wave_height;
  const wd=cur.wave_direction;
  const wp=cur.wave_period;
  const q=waveQuality(wh);

  // Current wave display
  let html=`<div class="wave-display">
    <div class="wave-icon">üåä</div>
    <div class="wave-data">
      <div class="wave-height">${wh!==null?wh.toFixed(1):'--'}<sup>m</sup></div>
      <div class="wave-period">${wp!==null?wp.toFixed(0)+'s':'--'} PERIODO</div>
      <div class="wave-dir">${waveDir(wd)} (${wd!==null?Math.round(wd)+'¬∞':'--'})</div>
    </div>
  </div>`;

  // Wave quality badge
  html+=`<div class="wave-quality ${q.cls}">${q.label}</div>`;

  // Swell info if available
  if(swh!==null&&swh>0){
    html+=`<div style="margin-top:8px;font-family:'Orbitron';font-size:.5rem;opacity:.7;letter-spacing:1px;">SWELL: ${swh.toFixed(1)}m</div>`;
  }

  // 5-day swell strip
  if(daily&&daily.wave_height_max){
    const D=['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
    html+=`<div class="swell-strip">`;
    for(let i=0;i<5;i++){
      const dt=new Date(daily.time[i]);
      const dayH=daily.wave_height_max[i];
      const dayQ=waveQuality(dayH);
      html+=`<div class="swell-item">
        <div class="sw-day">${i===0?'HOJE':D[dt.getDay()]}</div>
        <div class="sw-icon">üåä</div>
        <div class="sw-height">${dayH!==null?dayH.toFixed(1):'--'}m</div>
        <div class="sw-period">${daily.wave_period_max[i]!==null?daily.wave_period_max[i].toFixed(0)+'s':'--'}</div>
      </div>`;
    }
    html+=`</div>`;
  }

  container.innerHTML=html;
}

// ============ STATE GRID ============
function buildStateGrid(res){
  const g=document.getElementById('stgrid');g.innerHTML='';
  res.forEach(({s})=>{
    const btn=document.createElement('button');
    btn.className='stbtn';btn.id='sb-'+s.code;
    btn.innerHTML=wmoIcon(s._c)+'<br><b>'+s.code+'</b><br>'+(s._t!==null?toN(s._t):'?');
    btn.title=s.name;
    btn.onclick=()=>{selState(s);const m=stateMarkers.find(x=>x.s.code===s.code);if(m){map.setView([s.lat,s.lon],7,{animate:true});showStatePopup(s,m.marker);}};
    g.appendChild(btn);
  });
}
function selState(s){
  document.querySelectorAll('.stbtn').forEach(b=>b.classList.remove('on'));
  const btn=document.getElementById('sb-'+s.code);if(btn)btn.classList.add('on');
  loadMain(s.lat,s.lon,s.name);
}

// ============ SPOTS GRID ============
function buildSpotsGrid(){
  const g=document.getElementById('spotsGrid');g.innerHTML='';
  const icons={surf:'\uD83C\uDFC4',kite:'\uD83E\uDE81',wind:'\uD83C\uDFC4',sail:'\u26F5',fish:'\uD83C\uDFA3'};
  SPOTS.forEach(sp=>{
    const btn=document.createElement('button');
    btn.className='spot-btn';
    btn.innerHTML=`<span class="spot-icon">${icons[sp.type]||'\uD83C\uDFC4'}</span><span class="spot-name">${sp.name.toUpperCase()}</span>`;
    btn.onclick=()=>{map.setView([sp.lat,sp.lon],10,{animate:true});openSpotModal(sp.name,sp.lat,sp.lon,sp.type);};
    g.appendChild(btn);
  });
}

// ============ TABS ============
document.querySelectorAll('.tbtn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tbtn').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tcont').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById('tc-'+b.dataset.tab).classList.add('on');
  };
});

// ============ SEARCH ============
const SEARCH_ITEMS=[...STATES.map(s=>({name:s.name+', '+s.code,lat:s.lat,lon:s.lon})),...SPOTS.map(sp=>({name:sp.name,lat:sp.lat,lon:sp.lon}))];
const sinput=document.getElementById('searchInput');
const sresults=document.getElementById('searchResults');
sinput.addEventListener('input',()=>{
  const q=sinput.value.toLowerCase().trim();
  if(q.length<2){sresults.classList.remove('show');return;}
  const matches=SEARCH_ITEMS.filter(c=>c.name.toLowerCase().includes(q)).slice(0,8);
  if(!matches.length){sresults.classList.remove('show');return;}
  sresults.innerHTML=matches.map(c=>`<div class="search-item" data-lat="${c.lat}" data-lon="${c.lon}" data-name="${c.name}">${c.name.toUpperCase()}</div>`).join('');
  sresults.classList.add('show');
  sresults.querySelectorAll('.search-item').forEach(el=>{
    el.addEventListener('click',async()=>{
      const lt=parseFloat(el.dataset.lat),ln=parseFloat(el.dataset.lon),nm=el.dataset.name;
      sinput.value=nm.toUpperCase();sresults.classList.remove('show');
      map.setView([lt,ln],10,{animate:true});
      await showMapPopup(lt,ln,nm);
      await loadMain(lt,ln,nm);
    });
  });
});
document.addEventListener('click',e=>{if(!e.target.closest('.search-wrap'))sresults.classList.remove('show');});

// ============ REFRESH ALL ============
function refreshAll(){
  if(uLat){
    const k=`${uLat.toFixed(1)},${uLon.toFixed(1)}`;
    if(cache[k]){
      const c=cache[k].current;
      document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'C':'F')+'</sup>';
      document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
      document.getElementById('mgust').textContent=toW(c.wind_gusts_10m);
      document.getElementById('wrSpeed').textContent=toW(c.wind_speed_10m);
      buildHours(cache[k].hourly);
      buildWindTable(cache[k].daily);
    }
  }
  STATES.forEach(s=>{
    const btn=document.getElementById('sb-'+s.code);
    if(btn&&s._t!==null)btn.innerHTML=wmoIcon(s._c)+'<br><b>'+s.code+'</b><br>'+toN(s._t);
  });
  refreshMarkers();
}

// ============ INIT ============
async function init(){
  initMap(-14,-52);
  startLightning();
  try{
    const r=await fetch('https://ipapi.co/json/');
    const d=await r.json();
    uLat=parseFloat(d.latitude);uLon=parseFloat(d.longitude);
    const city=d.city+', '+d.region_code;
    await loadMain(uLat,uLon,city);
  }catch(e){
    uLat=-23.55;uLon=-46.63;
    await loadMain(uLat,uLon,'Sao Paulo, SP');
  }
  await placeStateMarkers();
}
init();

// ============ SERVICE WORKER ============
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').then(reg=>{
      console.log('MetBrasil SW registrado:',reg.scope);
    }).catch(err=>{
      console.log('MetBrasil SW erro:',err);
    });
  });
}
</script>
</body>
</html>
