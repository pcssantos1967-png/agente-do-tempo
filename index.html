<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: https://*.basemaps.cartocdn.com https://*.tile.openstreetmap.org; connect-src 'self' https://api.open-meteo.com https://marine-api.open-meteo.com https://ipapi.co;">
<title>MetBrasil - Inteligencia Climatica para Esportes</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4fc3f7">
<meta name="description" content="Plataforma brasileira de meteorologia focada em esportes aquaticos e ao ar livre. Previsao de ondas, ventos e mares.">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MetBrasil">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23020810' width='180' height='180' rx='20'/><text x='90' y='75' text-anchor='middle' fill='%234fc3f7' font-family='sans-serif' font-size='65' font-weight='bold'>M</text><text x='90' y='135' text-anchor='middle' fill='%234fc3f7' font-family='sans-serif' font-size='28'>BRASIL</text></svg>">

<!-- Preconnect for faster loading -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://api.open-meteo.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="dns-prefetch" href="https://a.basemaps.cartocdn.com">

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Fonts (display=swap for faster text rendering) -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ===================== RESET & ROOT ===================== */
:root{--tr:1.2s;--tr-fast:0.6s;--sport-color:#0097a7;--perspective:1200px;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{font-family:'Syne',sans-serif;perspective:var(--perspective);transition:all var(--tr);}

/* ===================== THEMES - RADICAL TRANSFORMATION ===================== */

/* === RAIN THEME === */
.theme-rain{
  --bg1:#020810;--bg2:#0a1628;--acc:#4fc3f7;--acc2:#0288d1;
  --txt:#e0f7fa;--card:rgba(2,8,20,0.88);--bdr:rgba(79,195,247,.35);
  --glow:rgba(79,195,247,.7);--shine:rgba(79,195,247,.12);
  --map-filter:hue-rotate(200deg) saturate(1.4) brightness(0.4) contrast(1.2);
  --map-overlay:rgba(2,8,16,0.55);
  --card-clip:polygon(0 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%);
  --header-bg:linear-gradient(180deg, rgba(2,8,20,0.95) 0%, rgba(10,22,40,0.85) 100%);
  --font-weight:300;
  --letter-spacing:3px;
}
.theme-rain .shell{transform:rotateX(1deg);transform-origin:center bottom;}
.theme-rain .card{clip-path:var(--card-clip);border-left:3px solid var(--acc);}
.theme-rain .logo-main{font-weight:400;letter-spacing:6px;animation:glitch 4s infinite;}
.theme-rain header{background:var(--header-bg);border-bottom:2px solid var(--acc);box-shadow:0 4px 30px rgba(79,195,247,0.3);}

/* === SUN THEME === */
.theme-sun{
  --bg1:#1a0800;--bg2:#3d1500;--acc:#ffd54f;--acc2:#ff8f00;
  --txt:#fff8e1;--card:rgba(60,30,5,0.85);--bdr:rgba(255,200,50,.45);
  --glow:rgba(255,213,79,.85);--shine:rgba(255,255,200,.18);
  --map-filter:sepia(0.3) saturate(1.6) brightness(0.85) hue-rotate(-10deg);
  --map-overlay:rgba(40,15,0,0.35);
  --card-clip:polygon(8px 0, 100% 0, 100% 100%, 0 100%, 0 8px);
  --header-bg:linear-gradient(180deg, rgba(60,25,0,0.95) 0%, rgba(80,35,0,0.85) 100%);
  --font-weight:700;
  --letter-spacing:4px;
}
.theme-sun .shell{transform:rotateX(-0.5deg) scale(1.01);transform-origin:center top;}
.theme-sun .card{clip-path:var(--card-clip);border-top:3px solid var(--acc);box-shadow:0 8px 40px rgba(255,150,0,0.4),inset 0 1px 0 var(--shine);}
.theme-sun .logo-main{font-weight:700;letter-spacing:8px;text-transform:uppercase;}
.theme-sun header{background:var(--header-bg);border-bottom:3px solid var(--acc);box-shadow:0 8px 50px rgba(255,150,0,0.5);}
.theme-sun .big-temp{font-size:5.5rem;text-shadow:0 0 50px var(--glow),0 0 100px var(--acc2);}

/* === CLOUDY THEME === */
.theme-cloudy{
  --bg1:#0d1117;--bg2:#161b22;--acc:#8b9dc3;--acc2:#5a6f94;
  --txt:#c9d1d9;--card:rgba(13,17,23,0.75);--bdr:rgba(139,157,195,.25);
  --glow:rgba(139,157,195,.5);--shine:rgba(255,255,255,.06);
  --map-filter:grayscale(0.6) brightness(0.45) saturate(0.6) blur(1px);
  --map-overlay:rgba(13,17,23,0.5);
  --card-clip:polygon(0 8px, 8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px));
  --header-bg:linear-gradient(180deg, rgba(13,17,23,0.9) 0%, rgba(22,27,34,0.8) 100%);
  --font-weight:400;
  --letter-spacing:5px;
}
.theme-cloudy .shell{transform:rotateX(0deg) rotateY(0.3deg);transform-origin:center center;}
.theme-cloudy .card{clip-path:var(--card-clip);backdrop-filter:blur(30px);border:1px solid var(--bdr);}
.theme-cloudy .logo-main{font-weight:400;letter-spacing:10px;opacity:0.85;}
.theme-cloudy header{background:var(--header-bg);backdrop-filter:blur(40px);border-bottom:1px solid var(--bdr);}
.theme-cloudy .left-panel,.theme-cloudy .right-panel{backdrop-filter:blur(20px);}

body{background:linear-gradient(145deg,var(--bg1),var(--bg2));color:var(--txt);}

/* ===================== NIGHT MODE ===================== */
.night-mode #map{filter:var(--map-filter) brightness(0.6)!important;}
.night-mode .map-overlay{background:rgba(0,0,20,0.4)!important;}
.night-mode .map-vignette{box-shadow:inset 0 0 200px rgba(0,0,30,0.8)!important;}
.night-mode .shell{filter:brightness(0.92);}
.night-mode #fx-overlay{opacity:1;background:linear-gradient(180deg, rgba(0,0,30,0.25) 0%, transparent 30%, transparent 70%, rgba(0,0,40,0.3) 100%)!important;}
.night-indicator{
  display:flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:15px;
  background:rgba(0,0,0,0.3);border:1px solid var(--bdr);
  font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;
  transition:all .3s;cursor:pointer;
}
.night-indicator:hover{background:rgba(255,255,255,0.1);border-color:var(--acc);}
.night-indicator .ni-icon{font-size:1rem;transition:transform .5s;}
.night-indicator.is-night .ni-icon{transform:rotate(360deg);}
.night-indicator .ni-text{opacity:.7;}

/* ===================== LANGUAGE TOGGLE ===================== */
.lang-toggle{
  display:flex;align-items:center;gap:2px;
  padding:3px;border-radius:15px;
  background:rgba(0,0,0,0.3);border:1px solid var(--bdr);
  font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;
}
.lang-btn{
  padding:4px 8px;border-radius:12px;border:none;
  background:transparent;color:var(--txt);cursor:pointer;
  font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;
  transition:all .3s;opacity:.5;
}
.lang-btn:hover{opacity:.8;}
.lang-btn.on{
  background:var(--acc);color:#000;opacity:1;
  box-shadow:0 0 10px var(--glow);
}

/* ===================== WEATHER ALERTS ===================== */
.alert-banner{
  position:fixed;top:0;left:0;right:0;z-index:8000;
  transform:translateY(-100%);transition:transform .4s cubic-bezier(0.4,0,0.2,1);
  pointer-events:none;
}
.alert-banner.show{transform:translateY(0);pointer-events:auto;}
.alert-content{
  display:flex;align-items:center;justify-content:center;gap:12px;
  padding:10px 20px;
  font-family:'Orbitron';font-size:.6rem;letter-spacing:2px;
  text-transform:uppercase;
}
.alert-rain{background:linear-gradient(90deg,#1565c0,#0d47a1);color:#fff;box-shadow:0 4px 20px rgba(21,101,192,0.5);}
.alert-storm{background:linear-gradient(90deg,#d32f2f,#b71c1c);color:#fff;box-shadow:0 4px 20px rgba(211,47,47,0.5);animation:alertPulse 2s infinite;}
.alert-wind{background:linear-gradient(90deg,#f57c00,#e65100);color:#fff;box-shadow:0 4px 20px rgba(245,124,0,0.5);}
.alert-heat{background:linear-gradient(90deg,#ff5722,#e64a19);color:#fff;box-shadow:0 4px 20px rgba(255,87,34,0.5);}
.alert-icon{font-size:1.2rem;animation:alertBounce 1s infinite;}
.alert-text{flex:1;}
.alert-close{
  background:rgba(255,255,255,0.2);border:none;color:#fff;
  width:24px;height:24px;border-radius:50%;cursor:pointer;
  font-size:.8rem;transition:all .2s;
}
.alert-close:hover{background:rgba(255,255,255,0.4);transform:scale(1.1);}
@keyframes alertPulse{0%,100%{opacity:1;}50%{opacity:0.85;}}
@keyframes alertBounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}

.alert-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 8px;border-radius:10px;
  font-family:'Orbitron';font-size:.4rem;letter-spacing:1px;
  animation:alertPulse 2s infinite;
}
.alert-badge-rain{background:#1565c0;color:#fff;}
.alert-badge-storm{background:#d32f2f;color:#fff;}
.alert-badge-wind{background:#f57c00;color:#fff;}

/* ===================== INMET OFFICIAL ALERTS ===================== */
.inmet-banner{
  position:fixed;top:0;left:0;right:0;z-index:7999;
  transform:translateY(-100%);transition:transform .4s cubic-bezier(0.4,0,0.2,1);
  pointer-events:none;
}
.inmet-banner.show{transform:translateY(0);pointer-events:auto;}
.inmet-content{
  display:flex;align-items:center;gap:10px;
  padding:10px 16px;
  font-family:'Orbitron';font-size:.55rem;letter-spacing:1px;
}
.inmet-badge{
  background:rgba(0,0,0,0.3);padding:4px 8px;border-radius:4px;
  font-weight:700;letter-spacing:2px;white-space:nowrap;
}
.inmet-evento{flex:1;font-family:'Syne';font-size:.7rem;letter-spacing:0;}
.inmet-severidade{
  padding:4px 10px;border-radius:12px;
  background:rgba(255,255,255,0.2);font-weight:700;
  text-transform:uppercase;font-size:.5rem;
}
.inmet-details{
  background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);
  color:inherit;padding:5px 12px;border-radius:12px;cursor:pointer;
  font-family:'Orbitron';font-size:.45rem;letter-spacing:1px;
  transition:all .2s;
}
.inmet-details:hover{background:rgba(255,255,255,0.3);}
.inmet-close{
  background:rgba(255,255,255,0.2);border:none;color:#fff;
  width:24px;height:24px;border-radius:50%;cursor:pointer;
  font-size:.8rem;transition:all .2s;
}
.inmet-close:hover{background:rgba(255,255,255,0.4);}

/* INMET Severity Colors */
.inmet-yellow{background:linear-gradient(90deg,#f9a825,#fbc02d);color:#000;box-shadow:0 4px 20px rgba(249,168,37,0.4);}
.inmet-orange{background:linear-gradient(90deg,#ef6c00,#ff9800);color:#fff;box-shadow:0 4px 20px rgba(239,108,0,0.4);}
.inmet-red{background:linear-gradient(90deg,#c62828,#e53935);color:#fff;box-shadow:0 4px 20px rgba(198,40,40,0.5);}

/* INMET State Indicator */
.inmet-indicator{
  position:absolute;top:-4px;right:-4px;
  width:14px;height:14px;border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 8px currentColor;
  z-index:100;
}
.inmet-indicator-yellow{background:#fbc02d;color:#fbc02d;}
.inmet-indicator-orange{background:#ff9800;color:#ff9800;}
.inmet-indicator-red{background:#e53935;color:#e53935;}

/* INMET Modal */
.inmet-modal{
  position:fixed;inset:0;z-index:9000;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.inmet-modal.show{opacity:1;pointer-events:auto;}
.inmet-modal-content{
  width:90%;max-width:500px;max-height:80vh;overflow-y:auto;
  background:var(--card);border:2px solid var(--acc);border-radius:16px;
  transform:scale(0.9);transition:transform .3s;
}
.inmet-modal.show .inmet-modal-content{transform:scale(1);}
.inmet-modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px;background:rgba(0,0,0,0.3);border-bottom:1px solid var(--bdr);
}
.inmet-modal-title{
  display:flex;align-items:center;gap:10px;
  font-family:'Bebas Neue';font-size:1.4rem;letter-spacing:3px;color:var(--acc);
}
.inmet-modal-body{padding:16px;}
.inmet-field{margin-bottom:12px;}
.inmet-field-label{
  font-family:'Orbitron';font-size:.45rem;letter-spacing:2px;
  color:var(--acc);opacity:.7;margin-bottom:4px;
}
.inmet-field-value{font-family:'Syne';font-size:.8rem;line-height:1.4;}
.inmet-link{
  display:inline-block;margin-top:12px;padding:8px 16px;
  background:var(--acc);color:var(--bg1);border-radius:8px;
  text-decoration:none;font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;
  transition:opacity .2s;
}
.inmet-link:hover{opacity:.8;}

/* ===================== SPOT MODAL ===================== */
.spot-modal{
  position:fixed;inset:0;z-index:8500;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);
  opacity:0;pointer-events:none;transition:opacity .4s;
}
.spot-modal.show{opacity:1;pointer-events:auto;}
.spot-modal-content{
  width:90%;max-width:700px;max-height:85vh;
  background:var(--card);border:2px solid var(--acc);border-radius:20px;
  overflow:hidden;transform:scale(0.9) translateY(30px);
  transition:transform .4s cubic-bezier(0.4,0,0.2,1);
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.spot-modal.show .spot-modal-content{transform:scale(1) translateY(0);}
.spot-modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;background:rgba(0,0,0,0.3);border-bottom:1px solid var(--bdr);
}
.spot-modal-title{
  font-family:'Bebas Neue';font-size:1.8rem;letter-spacing:4px;color:var(--acc);
  display:flex;align-items:center;gap:10px;
}
.spot-modal-title .smt-icon{font-size:1.5rem;}
.spot-modal-close{
  background:rgba(255,255,255,0.1);border:1px solid var(--bdr);color:var(--txt);
  width:36px;height:36px;border-radius:50%;cursor:pointer;
  font-size:1.2rem;transition:all .2s;
}
.spot-modal-close:hover{background:var(--acc);color:var(--bg1);border-color:var(--acc);}
.spot-modal-body{padding:20px;overflow-y:auto;max-height:calc(85vh - 80px);}
.spot-current{
  display:flex;align-items:center;gap:20px;padding:16px;
  background:rgba(0,0,0,0.2);border-radius:12px;margin-bottom:16px;
}
.spot-current-icon{font-size:3.5rem;filter:drop-shadow(0 0 15px var(--glow));}
.spot-current-data{flex:1;}
.spot-current-temp{font-family:'Bebas Neue';font-size:3.5rem;color:var(--acc);line-height:1;}
.spot-current-desc{font-family:'Orbitron';font-size:.6rem;opacity:.7;letter-spacing:2px;margin-top:4px;}
.spot-current-meta{display:flex;gap:16px;margin-top:8px;font-family:'Orbitron';font-size:.5rem;}
.spot-current-meta span{display:flex;align-items:center;gap:4px;opacity:.8;}
.spot-forecast-title{
  font-family:'Orbitron';font-size:.6rem;letter-spacing:3px;
  color:var(--acc);margin-bottom:12px;opacity:.8;
}
.spot-forecast-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.spot-day{
  padding:12px 6px;border-radius:12px;border:1px solid var(--bdr);
  text-align:center;background:rgba(0,0,0,0.2);transition:all .2s;
}
.spot-day:hover{background:rgba(255,255,255,0.08);transform:translateY(-3px);border-color:var(--acc);}
.spot-day-name{font-family:'Orbitron';font-size:.5rem;opacity:.6;letter-spacing:1px;margin-bottom:6px;}
.spot-day-icon{font-size:1.5rem;margin:6px 0;}
.spot-day-temps{display:flex;flex-direction:column;gap:2px;}
.spot-day-max{font-family:'Bebas Neue';font-size:1.3rem;color:var(--acc);}
.spot-day-min{font-family:'Orbitron';font-size:.5rem;opacity:.5;}
.spot-day-wind{font-family:'Orbitron';font-size:.45rem;opacity:.6;margin-top:6px;}
.spot-day-precip{font-family:'Orbitron';font-size:.4rem;color:#4fc3f7;margin-top:2px;}
@media(max-width:600px){
  .spot-forecast-grid{grid-template-columns:repeat(4,1fr);}
  .spot-day:nth-child(n+5){display:none;}
  .spot-current{flex-direction:column;text-align:center;}
}

/* ===================== SHARE BUTTON ===================== */
.share-btn{
  display:flex;align-items:center;gap:6px;
  padding:8px 14px;border-radius:20px;
  background:rgba(255,255,255,0.1);border:1px solid var(--bdr);
  color:var(--txt);font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;
  cursor:pointer;transition:all .2s;
}
.share-btn:hover{background:var(--acc);color:var(--bg1);border-color:var(--acc);}
.share-btn .share-icon{font-size:1rem;}
.share-toast{
  position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);
  background:var(--acc);color:var(--bg1);
  padding:12px 24px;border-radius:25px;
  font-family:'Orbitron';font-size:.6rem;letter-spacing:2px;
  box-shadow:0 8px 30px rgba(0,0,0,0.4);
  opacity:0;transition:all .4s cubic-bezier(0.4,0,0.2,1);
  z-index:9999;pointer-events:none;
}
.share-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ===================== SPORT MODES ===================== */
.mode-surf{--sport-color:#0097a7;}
.mode-kite{--sport-color:#7c4dff;}
.mode-wind{--sport-color:#00897b;}
.mode-para{--sport-color:#f57c00;}
.mode-sail{--sport-color:#1565c0;}
.mode-fish{--sport-color:#558b2f;}

/* ===================== IMMERSIVE FX LAYERS ===================== */
#fx{position:fixed;inset:0;pointer-events:none;z-index:1;}
#fx-overlay{position:fixed;inset:0;pointer-events:none;z-index:2;opacity:0;transition:opacity var(--tr);}
#lightning{position:fixed;inset:0;pointer-events:none;z-index:3;background:white;opacity:0;mix-blend-mode:overlay;}
#sunrays{position:fixed;inset:0;pointer-events:none;z-index:2;opacity:0;background:radial-gradient(ellipse at 80% -20%, rgba(255,200,50,0.4) 0%, transparent 50%);transition:opacity var(--tr);}
#fog{position:fixed;inset:0;pointer-events:none;z-index:2;opacity:0;transition:opacity var(--tr);}

.theme-rain #fx-overlay{opacity:1;background:linear-gradient(180deg, rgba(0,20,40,0.3) 0%, transparent 30%, transparent 70%, rgba(0,10,20,0.4) 100%);}
.theme-sun #sunrays{opacity:1;animation:sunpulse 8s ease-in-out infinite;}
.theme-cloudy #fog{opacity:1;background:linear-gradient(180deg, rgba(100,120,140,0.15) 0%, transparent 40%, transparent 60%, rgba(80,100,120,0.2) 100%);}

@keyframes sunpulse{0%,100%{opacity:0.6;transform:scale(1);}50%{opacity:1;transform:scale(1.1);}}
@keyframes glitch{0%,90%,100%{text-shadow:0 0 18px var(--glow);}92%{text-shadow:-2px 0 var(--acc),2px 0 var(--acc2);}94%{text-shadow:2px 0 var(--acc),-2px 0 var(--acc2);}96%{text-shadow:0 0 18px var(--glow);}}

/* ===================== CINEMATIC TRANSITION ===================== */
#wipe{position:fixed;inset:0;z-index:9000;pointer-events:none;background:var(--bg1);transform:translateY(-100%);transition:transform 0.8s cubic-bezier(0.7,0,0.3,1);}
#wipe.active{transform:translateY(0);}
#wipe.exit{transform:translateY(100%);}

/* ===================== LAYOUT SHELL - 3D TRANSFORMED ===================== */
.shell{
  position:relative;z-index:4;
  width:100vw;height:100vh;
  display:grid;
  grid-template-rows:60px 44px 1fr;
  grid-template-columns:340px 1fr 290px;
  grid-template-areas:
    "hdr hdr hdr"
    "sport sport sport"
    "left map right";
  transition:transform var(--tr),filter var(--tr);
  transform-style:preserve-3d;
}

/* ===================== HEADER - FLOATING 3D ===================== */
header{
  grid-area:hdr;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;
  background:var(--header-bg);
  backdrop-filter:blur(30px);
  transition:all var(--tr);
  z-index:50;
  transform:translateZ(20px);
}
.logo{display:flex;align-items:baseline;gap:10px;}
.logo-main{
  font-family:'Bebas Neue';font-size:2rem;letter-spacing:var(--letter-spacing);
  color:var(--acc);text-shadow:0 0 25px var(--glow);
  transition:all var(--tr);
}
.logo-dot{color:var(--acc2);transition:color var(--tr);font-size:1.5rem;}
.logo-sub{font-family:'Orbitron';font-size:.45rem;letter-spacing:4px;opacity:.5;text-transform:uppercase;}
.hdr-center{display:flex;align-items:center;gap:8px;}
.weather-status{
  display:flex;align-items:center;gap:10px;
  padding:8px 16px;border-radius:25px;
  background:rgba(0,0,0,0.4);border:2px solid var(--bdr);
  transition:all .3s;
}
.ws-icon{font-size:1.4rem;filter:drop-shadow(0 0 8px var(--glow));}
.ws-temp{font-family:'Bebas Neue';font-size:1.3rem;color:var(--acc);letter-spacing:2px;}
.ws-desc{font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;opacity:.8;text-transform:uppercase;}
.ws-loc{font-size:.7rem;opacity:.6;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:'Syne';}
.hdr-right{display:flex;align-items:center;gap:10px;}
.utog{display:flex;border:2px solid var(--bdr);border-radius:8px;overflow:hidden;transition:border-color var(--tr);background:rgba(0,0,0,0.2);}
.ubtn{padding:5px 10px;background:transparent;border:none;color:var(--txt);font-family:'Orbitron';font-size:.55rem;cursor:pointer;opacity:.5;transition:all .25s;}
.ubtn.on{background:var(--acc);color:var(--bg1);opacity:1;font-weight:700;}
.live-clk{font-family:'Orbitron';font-size:.75rem;opacity:.6;letter-spacing:3px;color:var(--acc);}

/* ===================== SPORT BAR - MORPHING ===================== */
.sport-bar{
  grid-area:sport;
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:0 24px;
  background:rgba(0,0,0,.35);
  border-bottom:1px solid var(--bdr);
  transition:all var(--tr);
  backdrop-filter:blur(20px);
}
.sport-btn{
  display:flex;align-items:center;gap:6px;
  padding:8px 18px;border-radius:25px;border:2px solid transparent;
  background:rgba(255,255,255,0.05);color:var(--txt);font-family:'Orbitron';font-size:.55rem;
  cursor:pointer;opacity:.6;transition:all .3s;text-transform:uppercase;letter-spacing:2px;
}
.sport-btn:hover{opacity:.9;border-color:var(--bdr);transform:translateY(-2px);}
.sport-btn.on{
  background:var(--sport-color);color:#fff;opacity:1;
  border-color:var(--sport-color);box-shadow:0 4px 25px var(--sport-color);
  transform:translateY(-3px) scale(1.05);
}
.sport-btn .sicon{font-size:1.1rem;}

/* ===================== LEFT PANEL - FLOATING CARDS ===================== */
.left-panel{
  grid-area:left;
  display:flex;flex-direction:column;gap:10px;
  padding:12px 10px 12px 14px;
  overflow-y:auto;
  background:linear-gradient(90deg, rgba(0,0,0,0.2) 0%, transparent 100%);
  transition:all var(--tr);
}
.left-panel::-webkit-scrollbar{width:4px;}
.left-panel::-webkit-scrollbar-thumb{background:var(--acc);border-radius:4px;}

/* ===================== RIGHT PANEL ===================== */
.right-panel{
  grid-area:right;
  display:flex;flex-direction:column;gap:10px;
  padding:12px 14px 12px 10px;
  overflow-y:auto;
  background:linear-gradient(270deg, rgba(0,0,0,0.2) 0%, transparent 100%);
  transition:all var(--tr);
}
.right-panel::-webkit-scrollbar{width:4px;}
.right-panel::-webkit-scrollbar-thumb{background:var(--acc);border-radius:4px;}

/* ===================== MAP AREA - CINEMATIC ===================== */
.map-wrap{
  grid-area:map;
  position:relative;
  overflow:hidden;
  border-radius:0;
  box-shadow:inset 0 0 100px rgba(0,0,0,0.5);
}
#map{width:100%;height:100%;filter:var(--map-filter);transition:filter var(--tr);}
.map-overlay{position:absolute;inset:0;background:var(--map-overlay);pointer-events:none;z-index:400;transition:all var(--tr);}
.map-vignette{position:absolute;inset:0;pointer-events:none;z-index:401;box-shadow:inset 0 0 150px rgba(0,0,0,0.7);transition:all var(--tr);}
.map-badge{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--card);border:2px solid var(--acc);border-radius:25px;
  padding:6px 18px;font-family:'Orbitron';font-size:.5rem;letter-spacing:3px;
  z-index:500;pointer-events:none;backdrop-filter:blur(15px);
  box-shadow:0 4px 30px rgba(0,0,0,0.5);transition:all var(--tr);color:var(--acc);
}
.map-hint{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--bdr);border-radius:20px;
  padding:6px 16px;font-family:'Orbitron';font-size:.48rem;letter-spacing:2px;opacity:.7;
  z-index:500;pointer-events:none;backdrop-filter:blur(15px);white-space:nowrap;transition:all var(--tr);
}

/* ===================== WIND ANIMATION LAYER ===================== */
#windCanvas{
  position:absolute;inset:0;z-index:402;pointer-events:none;
  opacity:0.7;mix-blend-mode:screen;transition:opacity .5s;
}
.wind-toggle{
  position:absolute;bottom:20px;right:20px;z-index:550;
  display:flex;align-items:center;gap:6px;
  padding:8px 14px;border-radius:20px;
  background:var(--card);border:1px solid var(--bdr);
  font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;
  cursor:pointer;transition:all .2s;backdrop-filter:blur(15px);
}
.wind-toggle:hover{border-color:var(--acc);background:rgba(255,255,255,0.1);}
.wind-toggle.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);}
.wind-toggle .wt-icon{font-size:1rem;}

/* ===================== CARDS - 3D FLOATING ===================== */
.card{
  background:var(--card);
  border:1px solid var(--bdr);
  border-radius:16px;
  padding:14px;
  backdrop-filter:blur(25px);
  transition:all var(--tr),transform .3s,box-shadow .3s;
  box-shadow:0 8px 32px rgba(0,0,0,.5),inset 0 1px 0 var(--shine);
  flex-shrink:0;
  transform:translateZ(0);
  clip-path:var(--card-clip);
}
.card:hover{transform:translateZ(10px) translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,.6),0 0 0 1px var(--acc),inset 0 1px 0 var(--shine);}
.clabel{
  font-family:'Orbitron';font-size:.5rem;letter-spacing:3px;text-transform:uppercase;
  color:var(--acc);margin-bottom:8px;opacity:.8;transition:color var(--tr);
}

/* ===================== CONDITION CARD ===================== */
.cond-badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 16px;border-radius:25px;
  font-family:'Bebas Neue';font-size:1.2rem;letter-spacing:3px;
  color:#fff;margin-bottom:10px;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
.cond-epic{background:linear-gradient(135deg,#00c853,#00e676);box-shadow:0 4px 30px rgba(0,200,83,0.5);}
.cond-good{background:linear-gradient(135deg,#2196f3,#03a9f4);box-shadow:0 4px 30px rgba(33,150,243,0.5);}
.cond-fair{background:linear-gradient(135deg,#ff9800,#ffc107);box-shadow:0 4px 30px rgba(255,152,0,0.5);}
.cond-poor{background:linear-gradient(135deg,#f44336,#e91e63);box-shadow:0 4px 30px rgba(244,67,54,0.5);}
.cond-flat{background:linear-gradient(135deg,#607d8b,#90a4ae);box-shadow:0 4px 30px rgba(96,125,139,0.5);}
.stars{font-size:1rem;letter-spacing:2px;}

/* ===================== WEATHER DISPLAY ===================== */
.main-icon{text-align:center;font-size:56px;padding:8px 0;filter:drop-shadow(0 0 20px var(--glow));transition:filter var(--tr);}
.main-icon span{display:inline-block;animation:float 4s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0) rotate(-3deg);}50%{transform:translateY(-12px) rotate(3deg);}}
.big-temp{
  font-family:'Bebas Neue';font-size:5rem;line-height:1;
  color:var(--acc);text-shadow:0 0 40px var(--glow);
  transition:all var(--tr);
  letter-spacing:2px;
}
.big-temp sup{font-size:1.8rem;vertical-align:top;margin-top:10px;display:inline-block;}
.city-name{font-size:1rem;font-weight:700;margin-top:4px;letter-spacing:1px;}
.city-desc{font-family:'Orbitron';font-size:.6rem;opacity:.6;margin-top:4px;letter-spacing:2px;}

/* ===================== WIND ROSE - ENHANCED ===================== */
.wind-rose{
  width:100px;height:100px;border-radius:50%;
  border:3px solid var(--bdr);
  position:relative;margin:10px auto;
  transition:all var(--tr);
  background:radial-gradient(circle, rgba(0,0,0,0.3) 0%, transparent 70%);
  box-shadow:0 0 30px rgba(0,0,0,0.5),inset 0 0 20px rgba(0,0,0,0.3);
}
.wr-labels{position:absolute;inset:0;font-family:'Orbitron';font-size:.4rem;opacity:.6;}
.wr-labels span{position:absolute;line-height:1;}
.wr-n{top:6px;left:50%;transform:translateX(-50%);}
.wr-s{bottom:6px;left:50%;transform:translateX(-50%);}
.wr-e{right:6px;top:50%;transform:translateY(-50%);}
.wr-w{left:6px;top:50%;transform:translateY(-50%);}
.wr-ne{top:14px;right:14px;}.wr-nw{top:14px;left:14px;}
.wr-se{bottom:14px;right:14px;}.wr-sw{bottom:14px;left:14px;}
.wr-needle{
  position:absolute;width:5px;height:40px;
  background:linear-gradient(to bottom,var(--sport-color) 60%,transparent);
  left:50%;top:10px;transform:translateX(-50%) rotate(var(--wd,0deg));
  transform-origin:bottom center;border-radius:3px;
  transition:transform 1.5s cubic-bezier(0.4,0,0.2,1),background var(--tr);
  box-shadow:0 0 10px var(--sport-color);
}
.wr-center{
  position:absolute;width:14px;height:14px;border-radius:50%;
  background:var(--sport-color);left:50%;top:50%;transform:translate(-50%,-50%);
  transition:background var(--tr);
  box-shadow:0 0 15px var(--sport-color);
}
.wr-info{text-align:center;margin-top:8px;}
.wr-speed{font-family:'Bebas Neue';font-size:1.8rem;color:var(--acc);transition:color var(--tr);}
.wr-dir{font-family:'Orbitron';font-size:.55rem;opacity:.65;letter-spacing:1px;}
.wr-beaufort{font-family:'Orbitron';font-size:.45rem;opacity:.5;margin-top:3px;letter-spacing:1px;}

/* ===================== KITE RATING BAR ===================== */
.kite-bar{margin-top:10px;}
.kite-track{height:10px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);}
.kite-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,#4CAF50,#8BC34A,#FFEB3B,#FF9800,#f44336);transition:width .6s cubic-bezier(0.4,0,0.2,1);box-shadow:0 0 10px currentColor;}
.kite-label{display:flex;justify-content:space-between;margin-top:4px;font-family:'Orbitron';font-size:.45rem;opacity:.6;letter-spacing:1px;}

/* ===================== WAVE CARD ===================== */
.wave-display{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.wave-icon{font-size:2.5rem;filter:drop-shadow(0 0 10px var(--acc));}
.wave-data{flex:1;}
.wave-height{font-family:'Bebas Neue';font-size:2.2rem;color:var(--acc);line-height:1;transition:color var(--tr);}
.wave-height sup{font-size:0.9rem;}
.wave-period{font-family:'Orbitron';font-size:.55rem;opacity:.7;margin-top:2px;letter-spacing:1px;}
.wave-dir{font-family:'Orbitron';font-size:.5rem;opacity:.5;letter-spacing:1px;}
.swell-strip{display:flex;gap:4px;overflow-x:auto;padding:6px 0;margin-top:8px;}
.swell-strip::-webkit-scrollbar{height:3px;}
.swell-strip::-webkit-scrollbar-thumb{background:var(--acc);border-radius:3px;}
.swell-item{
  flex-shrink:0;width:52px;padding:8px 4px;
  border-radius:10px;border:1px solid var(--bdr);
  text-align:center;font-family:'Orbitron';font-size:.42rem;
  transition:all .2s;background:rgba(0,0,0,0.2);
}
.swell-item:hover{background:rgba(255,255,255,.08);transform:translateY(-2px);}
.swell-item .sw-day{opacity:.5;margin-bottom:3px;letter-spacing:1px;}
.swell-item .sw-icon{font-size:.9rem;}
.swell-item .sw-height{font-weight:700;color:var(--acc);font-size:.6rem;margin-top:2px;}
.swell-item .sw-period{opacity:.5;font-size:.4rem;}
.wave-quality{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:12px;font-family:'Orbitron';font-size:.5rem;letter-spacing:1px;margin-top:6px;}
.wq-epic{background:linear-gradient(135deg,#00c853,#00e676);color:#fff;}
.wq-good{background:linear-gradient(135deg,#2196f3,#03a9f4);color:#fff;}
.wq-fair{background:linear-gradient(135deg,#ff9800,#ffc107);color:#000;}
.wq-poor{background:linear-gradient(135deg,#607d8b,#90a4ae);color:#fff;}
.wq-flat{background:linear-gradient(135deg,#37474f,#546e7a);color:#fff;}
.no-wave-data{font-family:'Orbitron';font-size:.5rem;opacity:.4;text-align:center;padding:20px;letter-spacing:1px;}

/* ===================== TIDE CARD ===================== */
.tide-display{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.tide-icon{font-size:2rem;filter:drop-shadow(0 0 10px var(--acc));}
.tide-data{flex:1;}
.tide-status{font-family:'Bebas Neue';font-size:1.4rem;color:var(--acc);line-height:1;}
.tide-time{font-family:'Orbitron';font-size:.5rem;opacity:.7;margin-top:4px;letter-spacing:1px;}
.tide-curve{
  position:relative;height:60px;margin:12px 0;
  background:rgba(0,0,0,0.2);border-radius:10px;overflow:hidden;
  border:1px solid var(--bdr);
}
.tide-curve-svg{width:100%;height:100%;}
.tide-curve-line{fill:none;stroke:var(--acc);stroke-width:2;opacity:0.8;}
.tide-curve-fill{fill:url(#tideGradient);opacity:0.3;}
.tide-curve-marker{fill:var(--acc);filter:drop-shadow(0 0 5px var(--acc));}
.tide-times{display:flex;justify-content:space-between;margin-top:8px;}
.tide-event{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:6px 10px;border-radius:8px;background:rgba(0,0,0,0.2);
  border:1px solid var(--bdr);flex:1;margin:0 2px;
}
.tide-event-icon{font-size:1rem;}
.tide-event-type{font-family:'Orbitron';font-size:.4rem;opacity:.6;letter-spacing:1px;}
.tide-event-time{font-family:'Bebas Neue';font-size:1rem;color:var(--acc);}
.tide-event.next{border-color:var(--acc);background:rgba(255,255,255,0.05);}
.tide-moon{display:flex;align-items:center;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--bdr);}
.tide-moon-icon{font-size:1.5rem;}
.tide-moon-info{font-family:'Orbitron';font-size:.45rem;opacity:.7;letter-spacing:1px;}
.tide-approx{font-family:'Orbitron';font-size:.4rem;opacity:.4;text-align:center;margin-top:8px;letter-spacing:1px;}

/* ===================== HOURLY STRIP ===================== */
.hour-strip{display:flex;gap:4px;overflow-x:auto;padding:6px 2px;}
.hour-strip::-webkit-scrollbar{height:3px;}
.hour-strip::-webkit-scrollbar-thumb{background:var(--acc);border-radius:3px;}
.hour-item{
  flex-shrink:0;width:48px;padding:8px 3px;
  border-radius:10px;border:1px solid var(--bdr);
  text-align:center;font-family:'Orbitron';font-size:.45rem;
  transition:all .2s;cursor:pointer;
  background:rgba(0,0,0,0.2);
}
.hour-item:hover{background:rgba(255,255,255,.08);transform:translateY(-2px);}
.hour-item.peak{border-color:var(--sport-color);background:rgba(var(--sport-color),.15);box-shadow:0 0 15px var(--sport-color);}
.hour-item .htime{opacity:.5;margin-bottom:3px;letter-spacing:1px;}
.hour-item .hicon{font-size:.9rem;}
.hour-item .htemp{font-weight:700;color:var(--acc);transition:color var(--tr);font-size:.55rem;}
.hour-item .hwind{opacity:.6;font-size:.4rem;margin-top:2px;}

/* ===================== WIND TABLE (Windguru style) ===================== */
.wind-table{width:100%;border-collapse:collapse;font-family:'Orbitron';font-size:.45rem;}
.wind-table th,.wind-table td{padding:6px 3px;text-align:center;border:1px solid var(--bdr);transition:border-color var(--tr);}
.wind-table th{background:rgba(0,0,0,.3);font-weight:500;opacity:.7;text-transform:uppercase;letter-spacing:1px;}
.wind-table .wt-icon{font-size:.85rem;}
.wind-table .wt-temp{color:var(--acc);font-weight:700;transition:color var(--tr);}
.wind-table .wt-wind{font-weight:600;}
.wind-table .wt-gust{opacity:.6;font-size:.4rem;}
.wind-table .wt-precip{color:#4fc3f7;}

/* ===================== STATE GRID ===================== */
.stgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;max-height:170px;overflow-y:auto;padding-right:3px;}
.stgrid::-webkit-scrollbar{width:3px;}
.stgrid::-webkit-scrollbar-thumb{background:var(--acc);border-radius:3px;}
.stbtn{padding:6px 3px;border-radius:8px;border:1px solid var(--bdr);background:rgba(0,0,0,0.2);color:var(--txt);font-family:'Orbitron';font-size:.45rem;cursor:pointer;text-align:center;opacity:.6;transition:all .2s;}
.stbtn:hover{background:rgba(255,255,255,.1);border-color:var(--acc);opacity:1;transform:scale(1.05);}
.stbtn.on{background:var(--acc);color:var(--bg1);border-color:var(--acc);opacity:1;font-weight:700;box-shadow:0 0 15px var(--glow);}

/* ===================== SPOTS GRID ===================== */
.spots-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;max-height:200px;overflow-y:auto;}
.spot-btn{
  padding:8px 6px;border-radius:8px;border:1px solid var(--bdr);
  background:rgba(0,0,0,0.2);color:var(--txt);font-family:'Orbitron';font-size:.42rem;
  cursor:pointer;text-align:left;opacity:.65;transition:all .2s;
  display:flex;align-items:center;gap:5px;
}
.spot-btn:hover{background:rgba(255,255,255,.08);opacity:1;border-color:var(--sport-color);transform:translateX(3px);}
.spot-btn .spot-icon{font-size:.75rem;}
.spot-btn .spot-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ===================== TABS ===================== */
.tabs{display:flex;gap:3px;padding:3px;background:rgba(0,0,0,.3);border-radius:10px;margin-bottom:10px;}
.tbtn{flex:1;padding:6px;border:none;background:transparent;color:var(--txt);font-family:'Orbitron';font-size:.45rem;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:8px;opacity:.5;transition:all .2s;}
.tbtn.on{background:var(--card);border:1px solid var(--bdr);opacity:1;color:var(--acc);}
.tcont{display:none;}
.tcont.on{display:block;}

/* ===================== METAS GRID ===================== */
.metas{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--bdr);transition:border-color var(--tr);}
.meta{display:flex;flex-direction:column;gap:2px;}
.mlabel{font-family:'Orbitron';font-size:.4rem;letter-spacing:2px;text-transform:uppercase;opacity:.4;}
.mval{font-size:.85rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== SEARCH ===================== */
.search-wrap{position:relative;}
.search-input{
  width:100%;padding:10px 14px 10px 36px;
  background:rgba(0,0,0,0.3);border:2px solid var(--bdr);border-radius:12px;
  color:var(--txt);font-family:'Orbitron';font-size:.6rem;letter-spacing:1px;
  outline:none;transition:all .3s;
}
.search-input:focus{border-color:var(--acc);box-shadow:0 0 20px var(--glow);background:rgba(0,0,0,0.5);}
.search-input::placeholder{opacity:.4;}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.4;font-size:.8rem;pointer-events:none;}
.search-results{
  position:absolute;top:calc(100% + 6px);left:0;right:0;z-index:600;
  background:var(--card);border:2px solid var(--bdr);border-radius:12px;
  backdrop-filter:blur(25px);overflow:hidden;display:none;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.search-results.show{display:block;}
.search-item{padding:8px 12px;font-family:'Orbitron';font-size:.55rem;cursor:pointer;opacity:.75;transition:all .15s;letter-spacing:1px;}
.search-item:hover{background:rgba(255,255,255,.1);opacity:1;padding-left:18px;}

/* ===================== MAP POPUP ===================== */
.leaflet-popup-content-wrapper{
  background:var(--card)!important;border:2px solid var(--acc)!important;
  border-radius:16px!important;backdrop-filter:blur(25px);
  box-shadow:0 12px 48px rgba(0,0,0,.6)!important;
  color:var(--txt)!important;font-family:'Syne',sans-serif!important;
}
.leaflet-popup-tip{background:var(--card)!important;border:2px solid var(--acc)!important;}
.leaflet-popup-close-button{color:var(--acc)!important;font-size:1.2rem!important;}
.pop-content{min-width:180px;padding:6px;}
.pop-title{font-family:'Bebas Neue';font-size:1.4rem;letter-spacing:3px;color:var(--acc);transition:color var(--tr);}
.pop-temp{font-family:'Bebas Neue';font-size:2.8rem;line-height:1;color:var(--acc);transition:color var(--tr);}
.pop-desc{font-family:'Orbitron';font-size:.55rem;opacity:.6;margin-top:3px;letter-spacing:1px;}
.pop-meta{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--bdr);}
.pop-m{display:flex;flex-direction:column;}
.pop-ml{font-family:'Orbitron';font-size:.4rem;letter-spacing:1px;opacity:.4;text-transform:uppercase;}
.pop-mv{font-size:.8rem;font-weight:600;color:var(--acc);transition:color var(--tr);}

/* ===================== SPINNER & LOADING ===================== */
.spin{display:inline-block;width:14px;height:14px;border:2px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle;margin-right:5px;}
@keyframes sp{to{transform:rotate(360deg)}}
@keyframes locpulse{0%{box-shadow:0 0 0 0 var(--glow);}70%{box-shadow:0 0 0 15px rgba(0,0,0,0);}100%{box-shadow:0 0 0 0 rgba(0,0,0,0);}}
.loc-dot{width:16px;height:16px;border-radius:50%;background:var(--acc);border:3px solid white;animation:locpulse 2s infinite;box-shadow:0 0 20px var(--acc);}
#loading{
  position:fixed;inset:0;z-index:9999;background:var(--bg1);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .6s;
}
#loading.hide{opacity:0;pointer-events:none;}
.load-logo{font-family:'Bebas Neue';font-size:4rem;letter-spacing:10px;color:var(--acc);text-shadow:0 0 40px var(--glow);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.8;transform:scale(1.02);}}
.load-sub{font-family:'Orbitron';font-size:.55rem;letter-spacing:5px;opacity:.5;text-transform:uppercase;}
.load-bar{width:220px;height:4px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;margin-top:8px;}
.load-prog{height:100%;background:linear-gradient(90deg,var(--acc2),var(--acc));border-radius:3px;animation:loadprog 2.5s ease forwards;box-shadow:0 0 15px var(--acc);}
@keyframes loadprog{from{width:0%}to{width:100%}}

/* ===================== SCROLLBAR ===================== */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:var(--acc);border-radius:4px;}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);}

/* ===================== RESPONSIVE ===================== */
@media(max-width:1100px){
  .shell{grid-template-columns:300px 1fr 0px;grid-template-areas:"hdr hdr hdr" "sport sport sport" "left map map";}
  .right-panel{display:none;}
}
@media(max-width:680px){
  .shell{grid-template-columns:0px 1fr 0px;grid-template-areas:"hdr hdr hdr" "sport sport sport" "map map map";transform:none!important;}
  .left-panel{display:none;}
  .sport-bar{overflow-x:auto;justify-content:flex-start;}
  header{padding:0 12px;}
  .logo-main{font-size:1.4rem;}
  .hdr-center{display:flex;}
  .weather-status{padding:4px 10px;gap:6px;}
  .ws-desc,.ws-loc{display:none;} /* Hide text on small screens */
  .ws-icon{font-size:1.1rem;}
  .ws-temp{font-size:1rem;}
}

/* MOBILE PERFORMANCE: disable heavy animations */
@media(max-width:768px),(prefers-reduced-motion:reduce){
  *,*::before,*::after{
    animation-duration:0.01ms!important;
    animation-iteration-count:1!important;
    transition-duration:0.01ms!important;
  }
  #fx,#windCanvas,#lightning,.wind-toggle{display:none!important;}
  .shell{transform:none!important;}
  .card,.left-panel,.right-panel,.inmet-modal-content{backdrop-filter:none!important;}
  .map-vignette{box-shadow:none!important;}
  .inmet-indicator{display:none!important;} /* Hide INMET indicators on mobile */
}
</style>
</head>
<body class="theme-rain mode-surf">

<!-- LOADING -->
<div id="loading">
  <div class="load-logo">MetBrasil</div>
  <div class="load-sub">Inteligencia Climatica</div>
  <div class="load-bar"><div class="load-prog"></div></div>
</div>

<!-- WEATHER ALERT BANNER -->
<div class="alert-banner" id="alertBanner">
  <div class="alert-content" id="alertContent">
    <span class="alert-icon" id="alertIcon">‚ö†Ô∏è</span>
    <span class="alert-text" id="alertText">ALERTA</span>
    <button class="alert-close" id="alertClose">&times;</button>
  </div>
</div>

<!-- INMET OFFICIAL ALERT BANNER -->
<div class="inmet-banner" id="inmetBanner">
  <div class="inmet-content" id="inmetContent">
    <span class="inmet-badge">INMET OFICIAL</span>
    <span class="inmet-evento" id="inmetEvento">Alerta meteorol√≥gico</span>
    <span class="inmet-severidade" id="inmetSeveridade">PERIGO</span>
    <button class="inmet-details" id="inmetDetails">Detalhes</button>
    <button class="inmet-close" id="inmetClose">&times;</button>
  </div>
</div>

<!-- INMET ALERT MODAL -->
<div class="inmet-modal" id="inmetModal">
  <div class="inmet-modal-content">
    <div class="inmet-modal-header">
      <div class="inmet-modal-title">
        <span id="inmetModalIcon">‚ö†Ô∏è</span>
        <span id="inmetModalTitle">Alerta INMET</span>
      </div>
      <button class="inmet-close" id="inmetModalClose">&times;</button>
    </div>
    <div class="inmet-modal-body" id="inmetModalBody">
      <!-- Content populated by JS -->
    </div>
  </div>
</div>

<!-- SPOT MODAL -->
<div class="spot-modal" id="spotModal">
  <div class="spot-modal-content">
    <div class="spot-modal-header">
      <div class="spot-modal-title">
        <span class="smt-icon" id="smtIcon">üèñÔ∏è</span>
        <span id="smtName">SPOT</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="share-btn" id="shareBtn"><span class="share-icon">üì§</span><span id="shareBtnText">COMPARTILHAR</span></button>
        <button class="spot-modal-close" id="spotModalClose">&times;</button>
      </div>
    </div>
    <div class="spot-modal-body">
      <div class="spot-current" id="spotCurrent">
        <div class="spot-current-icon" id="scIcon">‚õÖ</div>
        <div class="spot-current-data">
          <div class="spot-current-temp" id="scTemp">--¬∞</div>
          <div class="spot-current-desc" id="scDesc">CARREGANDO...</div>
          <div class="spot-current-meta">
            <span>üí® <span id="scWind">--</span></span>
            <span>üíß <span id="scHum">--%</span></span>
            <span>üåä <span id="scWave">--</span></span>
          </div>
        </div>
      </div>
      <div class="spot-forecast-title">üìÖ PREVISAO 7 DIAS</div>
      <div class="spot-forecast-grid" id="spotForecast"></div>
    </div>
  </div>
</div>

<!-- SHARE TOAST -->
<div class="share-toast" id="shareToast">LINK COPIADO!</div>

<!-- CINEMATIC WIPE -->
<div id="wipe"></div>

<!-- IMMERSIVE FX LAYERS -->
<canvas id="fx"></canvas>
<div id="fx-overlay"></div>
<div id="lightning"></div>
<div id="sunrays"></div>
<div id="fog"></div>

<!-- SHELL -->
<div class="shell">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <span class="logo-main">Met<span class="logo-dot">:</span>Brasil</span>
      <span class="logo-sub">metbrasil.com.br</span>
    </div>
    <div class="hdr-center">
      <div class="weather-status" id="weatherStatus">
        <span class="ws-icon" id="wsIcon">‚è≥</span>
        <span class="ws-temp" id="wsTemp">--¬∞</span>
        <span class="ws-desc" id="wsDesc">Carregando...</span>
        <span class="ws-loc" id="wsLoc">üìç</span>
      </div>
    </div>
    <div class="hdr-right">
      <div class="utog" role="group" aria-label="Unidade de temperatura">
        <button class="ubtn on" id="bC" aria-label="Celsius">C</button>
        <button class="ubtn" id="bF" aria-label="Fahrenheit">F</button>
      </div>
      <div class="utog" role="group" aria-label="Unidade de velocidade">
        <button class="ubtn on" id="bKmh" aria-label="Quilometros por hora">KM/H</button>
        <button class="ubtn" id="bKt" aria-label="Nos">NOS</button>
      </div>
      <div class="night-indicator" id="nightIndicator" title="Modo dia/noite automatico">
        <span class="ni-icon" id="niIcon">&#9728;&#65039;</span>
        <span class="ni-text" id="niText">DIA</span>
      </div>
      <div class="lang-toggle" id="langToggle">
        <button class="lang-btn on" id="langPT">PT</button>
        <button class="lang-btn" id="langEN">EN</button>
      </div>
      <span class="live-clk" id="clk">--:--</span>
    </div>
  </header>

  <!-- SPORT BAR -->
  <div class="sport-bar">
    <button class="sport-btn on" data-sport="surf"><span class="sicon">&#127940;</span>SURF</button>
    <button class="sport-btn" data-sport="kite"><span class="sicon">&#129667;</span>KITE</button>
    <button class="sport-btn" data-sport="wind"><span class="sicon">&#127940;</span>WINDSURF</button>
    <button class="sport-btn" data-sport="para"><span class="sicon">&#129666;</span>PARAPENTE</button>
    <button class="sport-btn" data-sport="sail"><span class="sicon">&#9973;</span>VELA</button>
    <button class="sport-btn" data-sport="fish"><span class="sicon">&#127907;</span>PESCA</button>
  </div>

  <!-- LEFT PANEL -->
  <div class="left-panel">

    <!-- SEARCH -->
    <div class="card" style="padding:12px;">
      <div class="search-wrap">
        <span class="search-icon">&#128269;</span>
        <input class="search-input" id="searchInput" type="text" placeholder="BUSCAR LOCAL...">
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <!-- CONDITION -->
    <div class="card">
      <div class="clabel">&#127919; CONDICAO ATUAL</div>
      <div id="condBadge" class="cond-badge cond-good">BOM <span class="stars">&#9733;&#9733;&#9733;&#9733;&#9734;</span></div>
      <div class="main-icon"><span id="micon">&#9928;&#65039;</span></div>
      <div class="big-temp" id="mtemp">--<sup>C</sup></div>
      <div class="city-name" id="mcity"><span class="spin"></span>Detectando...</div>
      <div class="city-desc" id="mdesc">Aguardando dados...</div>
    </div>

    <!-- WIND ROSE -->
    <div class="card">
      <div class="clabel">&#127744; VENTO</div>
      <div class="wind-rose">
        <div class="wr-labels">
          <span class="wr-n">N</span><span class="wr-s">S</span>
          <span class="wr-e">L</span><span class="wr-w">O</span>
          <span class="wr-ne">NE</span><span class="wr-nw">NO</span>
          <span class="wr-se">SE</span><span class="wr-sw">SO</span>
        </div>
        <div class="wr-needle" id="wrNeedle"></div>
        <div class="wr-center"></div>
      </div>
      <div class="wr-info">
        <div class="wr-speed" id="wrSpeed">-- km/h</div>
        <div class="wr-dir" id="wrDir">--</div>
        <div class="wr-beaufort" id="wrBeaufort">--</div>
      </div>
      <div class="kite-bar">
        <div class="clabel" style="margin-bottom:4px;">&#129667; RATING KITE</div>
        <div class="kite-track"><div class="kite-fill" id="kiteFill" style="width:0%"></div></div>
        <div class="kite-label"><span id="kiteLow">FRACO</span><span id="kiteVal">0/10</span><span id="kiteHigh">FORTE</span></div>
      </div>
    </div>

    <!-- HOURLY -->
    <div class="card">
      <div class="clabel">&#128337; PREVISAO 12H</div>
      <div class="hour-strip" id="hourStrip"></div>
    </div>

    <!-- WAVES -->
    <div class="card" id="waveCard">
      <div class="clabel">&#127754; ONDAS</div>
      <div id="waveContent">
        <div class="no-wave-data">CARREGANDO DADOS DE ONDAS...</div>
      </div>
    </div>

    <!-- TIDES -->
    <div class="card" id="tideCard">
      <div class="clabel">&#127754; MARES</div>
      <div id="tideContent">
        <div class="no-wave-data">CALCULANDO MARES...</div>
      </div>
    </div>

    <!-- METAS -->
    <div class="card">
      <div class="clabel">&#128202; DADOS</div>
      <div class="metas">
        <div class="meta"><span class="mlabel">SENSACAO</span><span class="mval" id="mfeel">--</span></div>
        <div class="meta"><span class="mlabel">UMIDADE</span><span class="mval" id="mhum">--%</span></div>
        <div class="meta"><span class="mlabel">RAJADAS</span><span class="mval" id="mgust">--</span></div>
        <div class="meta"><span class="mlabel">PRESSAO</span><span class="mval" id="mpress">--</span></div>
        <div class="meta"><span class="mlabel">VISIB.</span><span class="mval" id="mvis">--</span></div>
        <div class="meta"><span class="mlabel">NUVENS</span><span class="mval" id="mclouds">--%</span></div>
      </div>
    </div>

  </div>

  <!-- MAP -->
  <div class="map-wrap">
    <div id="map"></div>
    <canvas id="windCanvas"></canvas>
    <div class="map-overlay"></div>
    <div class="map-vignette"></div>
    <div class="map-hint">&#128433;&#65039; CLIQUE NO MAPA</div>
    <div class="map-badge">MET:BRASIL</div>
    <button class="wind-toggle on" id="windToggle" title="Animacao de vento">
      <span class="wt-icon">üí®</span>VENTO
    </button>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <!-- WIND TABLE -->
    <div class="card">
      <div class="clabel">&#128168; VENTO 5 DIAS</div>
      <table class="wind-table" id="windTable">
        <thead><tr><th>DIA</th><th></th><th>TEMP</th><th>VENTO</th><th>RAJ</th><th>&#128167;</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TABS: STATES / SPOTS -->
    <div class="card" style="flex:1;min-height:0;">
      <div class="tabs">
        <button class="tbtn on" data-tab="states">ESTADOS</button>
        <button class="tbtn" data-tab="spots">SPOTS</button>
      </div>
      <div class="tcont on" id="tc-states">
        <div class="stgrid" id="stgrid"></div>
      </div>
      <div class="tcont" id="tc-spots">
        <div class="spots-grid" id="spotsGrid"></div>
      </div>
    </div>

    <!-- LEGEND -->
    <div class="card">
      <div class="clabel">&#127777;&#65039; LEGENDA</div>
      <div style="display:flex;flex-direction:column;gap:5px;font-family:'Orbitron';font-size:.5rem;opacity:.7;letter-spacing:1px;">
        <div style="display:flex;align-items:center;gap:8px;"><div style="width:12px;height:12px;border-radius:50%;background:#4CAF50;box-shadow:0 0 8px #4CAF50;"></div><span>&lt; 20C</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><div style="width:12px;height:12px;border-radius:50%;background:#FF9800;box-shadow:0 0 8px #FF9800;"></div><span>20-30C</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><div style="width:12px;height:12px;border-radius:50%;background:#f44336;box-shadow:0 0 8px #f44336;"></div><span>&gt; 30C</span></div>
      </div>
    </div>

  </div>
</div>

<!-- JAVASCRIPT -->
<script>
// ============ SECURITY UTILITIES ============
// HTML entity encoder to prevent XSS
function escapeHtml(str){
  if(str===null||str===undefined)return'';
  const s=String(str);
  const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
  return s.replace(/[&<>"']/g,c=>map[c]);
}
// Validate that a value is a safe string (alphanumeric, spaces, basic punctuation)
function sanitizeLocationName(name){
  if(typeof name!=='string')return'';
  // Allow letters (including accented), numbers, spaces, commas, periods, hyphens
  return name.replace(/[^\p{L}\p{N}\s,.\-]/gu,'').substring(0,100);
}
// Validate coordinate is a valid number within range
function validateCoord(val,min,max){
  const num=parseFloat(val);
  if(isNaN(num)||num<min||num>max)return null;
  return num;
}
// Validate spot type against allowed values
function validateSpotType(type){
  const allowed=['surf','kite','wind','sail','fish','para','state'];
  return allowed.includes(type)?type:'surf';
}

// ============ DATA ============
const STATES=[
  {code:'AC',name:'Acre',lat:-9.97,lon:-67.81},{code:'AL',name:'Alagoas',lat:-9.67,lon:-35.74},
  {code:'AM',name:'Amazonas',lat:-3.07,lon:-60.03},{code:'AP',name:'Amapa',lat:0.9,lon:-52.0},
  {code:'BA',name:'Bahia',lat:-12.97,lon:-38.50},{code:'CE',name:'Ceara',lat:-3.72,lon:-38.54},
  {code:'DF',name:'Dist. Federal',lat:-15.78,lon:-47.93},{code:'ES',name:'Esp. Santo',lat:-19.83,lon:-40.32},
  {code:'GO',name:'Goias',lat:-16.68,lon:-49.25},{code:'MA',name:'Maranhao',lat:-2.53,lon:-44.27},
  {code:'MG',name:'Minas Gerais',lat:-19.92,lon:-43.94},{code:'MS',name:'Mato G. Sul',lat:-20.44,lon:-54.65},
  {code:'MT',name:'Mato Grosso',lat:-12.64,lon:-55.42},{code:'PA',name:'Para',lat:-1.46,lon:-48.50},
  {code:'PB',name:'Paraiba',lat:-7.12,lon:-34.84},{code:'PE',name:'Pernambuco',lat:-8.05,lon:-34.88},
  {code:'PI',name:'Piaui',lat:-5.09,lon:-42.80},{code:'PR',name:'Parana',lat:-24.89,lon:-51.55},
  {code:'RJ',name:'Rio de Janeiro',lat:-22.84,lon:-43.15},{code:'RN',name:'R. G. Norte',lat:-5.74,lon:-36.67},
  {code:'RO',name:'Rondonia',lat:-10.83,lon:-63.34},{code:'RR',name:'Roraima',lat:2.0,lon:-61.37},
  {code:'RS',name:'R. G. Sul',lat:-30.03,lon:-51.22},{code:'SC',name:'Santa Cat.',lat:-27.59,lon:-48.55},
  {code:'SE',name:'Sergipe',lat:-10.57,lon:-37.38},{code:'SP',name:'Sao Paulo',lat:-23.55,lon:-46.63},
  {code:'TO',name:'Tocantins',lat:-10.17,lon:-48.33},
];

const SPOTS=[
  // SURF (19)
  {name:'Florianopolis',lat:-27.59,lon:-48.55,type:'surf'},{name:'Buzios',lat:-22.75,lon:-41.88,type:'surf'},
  {name:'Arraial do Cabo',lat:-22.97,lon:-42.03,type:'surf'},{name:'Saquarema',lat:-22.92,lon:-42.51,type:'surf'},
  {name:'Itacare',lat:-14.28,lon:-38.99,type:'surf'},{name:'Torres',lat:-29.35,lon:-49.73,type:'surf'},
  {name:'Garopaba',lat:-28.02,lon:-48.62,type:'surf'},{name:'Ubatuba',lat:-23.43,lon:-45.07,type:'surf'},
  {name:'Maresias',lat:-23.79,lon:-45.56,type:'surf'},{name:'Guaruja',lat:-23.99,lon:-46.26,type:'surf'},
  {name:'Itamambuca',lat:-23.40,lon:-44.98,type:'surf'},{name:'Pipa',lat:-6.23,lon:-35.06,type:'surf'},
  {name:'Fernando Noronha',lat:-3.85,lon:-32.43,type:'surf'},{name:'Morro de SP',lat:-13.38,lon:-38.91,type:'surf'},
  {name:'Porto de Galinhas',lat:-8.50,lon:-35.00,type:'surf'},{name:'Praia do Forte',lat:-12.58,lon:-38.00,type:'surf'},
  {name:'Balneario Camboriu',lat:-26.99,lon:-48.63,type:'surf'},{name:'Imbituba',lat:-28.24,lon:-48.67,type:'surf'},
  {name:'Praia do Rosa',lat:-28.13,lon:-48.63,type:'surf'},{name:'Joaquina',lat:-27.63,lon:-48.45,type:'surf'},
  {name:'Matinhos',lat:-25.82,lon:-48.54,type:'surf'},{name:'Prainha RJ',lat:-23.04,lon:-43.50,type:'surf'},
  {name:'Stella Maris',lat:-12.94,lon:-38.34,type:'surf'},
  // KITE (10)
  {name:'Jericoacoara',lat:-2.79,lon:-40.51,type:'kite'},{name:'Cumbuco',lat:-3.63,lon:-38.73,type:'kite'},
  {name:'Prea',lat:-2.92,lon:-40.42,type:'kite'},{name:'Atins',lat:-2.58,lon:-42.73,type:'kite'},
  {name:'Barra Grande PI',lat:-2.90,lon:-41.40,type:'kite'},{name:'Icaraizinho',lat:-2.85,lon:-39.95,type:'kite'},
  {name:'Guajiru',lat:-3.18,lon:-39.27,type:'kite'},{name:'Macapa PI',lat:-2.91,lon:-41.05,type:'kite'},
  // WIND (2)
  {name:'Sao M. Gostoso',lat:-5.12,lon:-35.63,type:'wind'},{name:'Cabo Frio',lat:-22.88,lon:-42.03,type:'wind'},
  // SAIL (4)
  {name:'Ilhabela',lat:-23.78,lon:-45.36,type:'sail'},{name:'Angra dos Reis',lat:-23.01,lon:-44.32,type:'sail'},
  {name:'Paraty',lat:-23.22,lon:-44.71,type:'sail'},{name:'Lagoa da Conceicao',lat:-27.60,lon:-48.47,type:'sail'},
  // PARA (3)
  {name:'Gov. Valadares',lat:-18.85,lon:-41.95,type:'para'},{name:'Pico do Gaviao',lat:-22.68,lon:-43.28,type:'para'},
  {name:'Andradas',lat:-22.07,lon:-46.57,type:'para'},
  // FISH (3)
  {name:'Vitoria',lat:-20.32,lon:-40.29,type:'fish'},{name:'Cananeia',lat:-25.01,lon:-47.93,type:'fish'},
  {name:'Barra de S. Miguel',lat:-9.85,lon:-35.90,type:'fish'},
];

// Map tiles per theme
const TILES={
  rain:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  sun:'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
  cloudy:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
};

// ============ i18n TRANSLATIONS ============
const i18n={
  pt:{
    // Header
    rain:'CHUVA',sun:'SOL',cloudy:'NUBLADO',day:'DIA',night:'NOITE',
    // Sport bar
    surf:'SURF',kite:'KITE',windsurf:'WINDSURF',paraglide:'PARAPENTE',sail:'VELA',fish:'PESCA',
    // Labels
    currentCondition:'CONDICAO ATUAL',wind:'VENTO',kiteRating:'RATING KITE',
    forecast12h:'PREVISAO 12H',waves:'ONDAS',tides:'MARES',data:'DADOS',
    wind5days:'VENTO 5 DIAS',legend:'LEGENDA',
    // Kite labels
    kiteLow:'FRACO',kiteHigh:'FORTE',
    // Placeholders
    searchPlaceholder:'BUSCAR LOCAL...',detecting:'Detectando...',waitingData:'Aguardando dados...',
    calculatingTides:'CALCULANDO MARES...',noWaveData:'SEM DADOS DE ONDAS',
    // Conditions
    epic:'EPICO!',good:'BOM',fair:'RAZOAVEL',poor:'FRACO',flat:'SEM VENTO',dangerous:'PERIGOSO',bad:'RUIM',
    // Wind rose
    beaufortCalm:'Calmaria',beaufortLight:'Aragem',beaufortBreezeLight:'Brisa leve',
    beaufortBreeze:'Brisa fraca',beaufortBreezeMod:'Brisa mod.',beaufortBreezeFresh:'Brisa forte',
    beaufortBreezeStrong:'Vento fresco',beaufortNear:'Vento forte',beaufortGale:'Ventania',
    beaufortGaleStrong:'Vendaval',beaufortStorm:'Tempestade',beaufortViolent:'Tempest. viol.',beaufortHurricane:'Furacao',
    // Data labels
    humidity:'UMID.',feelsLike:'SENS.',gusts:'RAJADAS',pressure:'PRESSAO',visibility:'VISIB.',clouds:'NUVENS',
    // Waves
    waveHeight:'Altura',wavePeriod:'Periodo',waveDir:'Direcao',swell:'Swell',
    // Tides
    tideRising:'MARE SUBINDO',tideFalling:'MARE DESCENDO',tideHigh:'ALTA',tideLow:'BAIXA',
    nextTide:'prox. mare',lunarApprox:'Aproximacao baseada em fase lunar',
    // Moon phases
    newMoon:'LUA NOVA',waxingCres:'CRESCENTE',firstQuarter:'QUARTO CRESC.',waxingGib:'GIBOSA CRESC.',
    fullMoon:'LUA CHEIA',waningGib:'GIBOSA MING.',lastQuarter:'QUARTO MING.',waningCres:'MINGUANTE',
    springTides:'MARES VIVAS',neapTides:'MARES MORTAS',mediumTides:'MARES MEDIAS',
    // Alerts
    alertStorm:'ALERTA DE TEMPESTADE - Evite atividades ao ar livre!',
    alertRain:'ALTA PROBABILIDADE DE CHUVA',alertWind:'VENTOS FORTES',alertHeat:'CALOR EXTREMO',
    // Share
    shareTitle:'Condicoes em',linkCopied:'LINK COPIADO!',
    // Modal
    close:'Fechar',forecast7days:'Previsao 7 dias',share:'Compartilhar',
    // Legend
    cold:'Frio',warm:'Morno',hot:'Quente',
    // Days
    today:'HOJE',
  },
  en:{
    // Header
    rain:'RAIN',sun:'SUN',cloudy:'CLOUDY',day:'DAY',night:'NIGHT',
    // Sport bar
    surf:'SURF',kite:'KITE',windsurf:'WINDSURF',paraglide:'PARAGLIDING',sail:'SAILING',fish:'FISHING',
    // Labels
    currentCondition:'CURRENT CONDITION',wind:'WIND',kiteRating:'KITE RATING',
    forecast12h:'12H FORECAST',waves:'WAVES',tides:'TIDES',data:'DATA',
    wind5days:'5 DAY WIND',legend:'LEGEND',
    // Kite labels
    kiteLow:'WEAK',kiteHigh:'STRONG',
    // Placeholders
    searchPlaceholder:'SEARCH LOCATION...',detecting:'Detecting...',waitingData:'Waiting for data...',
    calculatingTides:'CALCULATING TIDES...',noWaveData:'NO WAVE DATA',
    // Conditions
    epic:'EPIC!',good:'GOOD',fair:'FAIR',poor:'POOR',flat:'NO WIND',dangerous:'DANGEROUS',bad:'BAD',
    // Wind rose
    beaufortCalm:'Calm',beaufortLight:'Light air',beaufortBreezeLight:'Light breeze',
    beaufortBreeze:'Gentle breeze',beaufortBreezeMod:'Mod. breeze',beaufortBreezeFresh:'Fresh breeze',
    beaufortBreezeStrong:'Strong breeze',beaufortNear:'Near gale',beaufortGale:'Gale',
    beaufortGaleStrong:'Strong gale',beaufortStorm:'Storm',beaufortViolent:'Violent storm',beaufortHurricane:'Hurricane',
    // Data labels
    humidity:'HUMID.',feelsLike:'FEELS',gusts:'GUSTS',pressure:'PRESS.',visibility:'VISIB.',clouds:'CLOUDS',
    // Waves
    waveHeight:'Height',wavePeriod:'Period',waveDir:'Direction',swell:'Swell',
    // Tides
    tideRising:'TIDE RISING',tideFalling:'TIDE FALLING',tideHigh:'HIGH',tideLow:'LOW',
    nextTide:'next tide',lunarApprox:'Lunar phase approximation',
    // Moon phases
    newMoon:'NEW MOON',waxingCres:'WAXING CRESCENT',firstQuarter:'FIRST QUARTER',waxingGib:'WAXING GIBBOUS',
    fullMoon:'FULL MOON',waningGib:'WANING GIBBOUS',lastQuarter:'LAST QUARTER',waningCres:'WANING CRESCENT',
    springTides:'SPRING TIDES',neapTides:'NEAP TIDES',mediumTides:'MEDIUM TIDES',
    // Alerts
    alertStorm:'STORM ALERT - Avoid outdoor activities!',
    alertRain:'HIGH RAIN PROBABILITY',alertWind:'STRONG WINDS',alertHeat:'EXTREME HEAT',
    // Share
    shareTitle:'Conditions at',linkCopied:'LINK COPIED!',
    // Modal
    close:'Close',forecast7days:'7 day forecast',share:'Share',
    // Legend
    cold:'Cold',warm:'Warm',hot:'Hot',
    // Days
    today:'TODAY',
  }
};
let curLang='pt';
function t(key){return i18n[curLang][key]||key;}

// ============ STATE ============
let cache={},celsius=true,knots=false,curTheme='rain',curSport='surf',autoMode=true;
let uLat=null,uLon=null,map=null,tileLayer=null,userMarker=null,stateMarkers=[],spotMarkers=[];
let autoThemeTimer=null,lightningInterval=null;

// ============ PERSISTENT CACHE (localStorage + TTL 10min) ============
const CACHE_KEY='metbrasil_weather_cache';
const CACHE_TTL=10*60*1000; // 10 minutes
function loadCache(){
  try{
    const stored=localStorage.getItem(CACHE_KEY);
    if(!stored)return;
    const {data,ts}=JSON.parse(stored);
    if(Date.now()-ts<CACHE_TTL){
      cache=data;
      console.log('Cache restored:',Object.keys(cache).length,'locations');
    }else{
      localStorage.removeItem(CACHE_KEY);
    }
  }catch(e){console.warn('loadCache error:',e);}
}
function saveCache(){
  try{
    localStorage.setItem(CACHE_KEY,JSON.stringify({data:cache,ts:Date.now()}));
  }catch(e){console.warn('saveCache error:',e);}
}
loadCache(); // restore on page load

// ============ IMMERSIVE PARTICLES ============
const cv=document.getElementById('fx'),cx=cv.getContext('2d');
let pts=[];
function rcv(){cv.width=innerWidth;cv.height=innerHeight;}
window.addEventListener('resize',rcv);rcv();

class Particle{
  constructor(){this.reset();}
  reset(){
    this.x=Math.random()*cv.width;
    this.y=Math.random()*cv.height;
    this.theme=curTheme;
    if(this.theme==='rain'){
      // Heavy rain drops
      this.vx=-3-Math.random()*2;
      this.vy=15+Math.random()*10;
      this.sz=1+Math.random()*2;
      this.len=15+Math.random()*20;
      this.a=0.2+Math.random()*0.4;
    }else if(this.theme==='sun'){
      // Floating golden particles
      this.vx=(Math.random()-0.5)*0.8;
      this.vy=-0.3-Math.random()*0.5;
      this.sz=2+Math.random()*5;
      this.a=0.15+Math.random()*0.25;
      this.pulse=Math.random()*Math.PI*2;
    }else{
      // Slow drifting fog/clouds
      this.vx=0.3+Math.random()*0.5;
      this.vy=(Math.random()-0.5)*0.15;
      this.sz=50+Math.random()*100;
      this.a=0.03+Math.random()*0.05;
    }
  }
}

// Detect mobile/low-power device
const isMobile=window.innerWidth<768||/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);

function initParticles(){
  // Reduce particles on mobile for better performance
  let count=curTheme==='rain'?200:curTheme==='sun'?80:12;
  if(isMobile)count=Math.floor(count*0.3); // 70% reduction on mobile
  pts=Array.from({length:count},()=>new Particle());
}

function renderParticles(){
  cx.clearRect(0,0,cv.width,cv.height);
  for(const p of pts){
    if(p.theme!==curTheme){p.theme=curTheme;p.reset();}
    cx.save();
    if(curTheme==='rain'){
      // Diagonal rain streaks
      const gradient=cx.createLinearGradient(p.x,p.y,p.x+p.vx*3,p.y+p.len);
      gradient.addColorStop(0,'rgba(79,195,247,0)');
      gradient.addColorStop(0.5,`rgba(79,195,247,${p.a})`);
      gradient.addColorStop(1,'rgba(79,195,247,0)');
      cx.strokeStyle=gradient;
      cx.lineWidth=p.sz;
      cx.lineCap='round';
      cx.beginPath();
      cx.moveTo(p.x,p.y);
      cx.lineTo(p.x+p.vx*3,p.y+p.len);
      cx.stroke();
    }else if(curTheme==='sun'){
      // Glowing orbs with pulse
      p.pulse+=0.02;
      const pulseA=p.a*(0.7+0.3*Math.sin(p.pulse));
      const gradient=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.sz*2);
      gradient.addColorStop(0,`rgba(255,213,79,${pulseA})`);
      gradient.addColorStop(0.5,`rgba(255,150,0,${pulseA*0.5})`);
      gradient.addColorStop(1,'rgba(255,100,0,0)');
      cx.fillStyle=gradient;
      cx.beginPath();
      cx.arc(p.x,p.y,p.sz*2,0,Math.PI*2);
      cx.fill();
    }else{
      // Soft cloud ellipses
      const gradient=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.sz);
      gradient.addColorStop(0,`rgba(139,157,195,${p.a})`);
      gradient.addColorStop(1,'rgba(139,157,195,0)');
      cx.fillStyle=gradient;
      cx.beginPath();
      cx.ellipse(p.x,p.y,p.sz*2.5,p.sz,0,0,Math.PI*2);
      cx.fill();
    }
    cx.restore();
    // Move
    p.x+=p.vx;p.y+=p.vy;
    // Wrap
    if(p.y>cv.height+50){p.y=-50;p.x=Math.random()*cv.width;}
    if(p.x>cv.width+200){p.x=-200;}
    if(p.y<-50){p.y=cv.height+50;}
    if(p.x<-200){p.x=cv.width+200;}
  }
  if(!isMobile)requestAnimationFrame(renderParticles);
}
if(!isMobile){initParticles();renderParticles();}

// ============ LIGHTNING EFFECT ============
function triggerLightning(){
  if(curTheme!=='rain')return;
  const lightning=document.getElementById('lightning');
  lightning.style.opacity='0.7';
  setTimeout(()=>{lightning.style.opacity='0';},80);
  setTimeout(()=>{lightning.style.opacity='0.4';},150);
  setTimeout(()=>{lightning.style.opacity='0';},200);
}
function startLightning(){
  stopLightning();
  lightningInterval=setInterval(()=>{
    if(Math.random()<0.3)triggerLightning();
  },4000);
}
function stopLightning(){
  if(lightningInterval){clearInterval(lightningInterval);lightningInterval=null;}
  document.getElementById('lightning').style.opacity='0';
}

// ============ WIND ANIMATION LAYER ============
const windCv=document.getElementById('windCanvas');
const windCx=windCv.getContext('2d');
let windParticles=[],windEnabled=true,windAnimId=null;
const WIND_PARTICLE_COUNT=isMobile?200:800; // Reduce on mobile
const WIND_FADE=0.92;

function resizeWindCanvas(){
  const wrap=document.querySelector('.map-wrap');
  if(wrap){windCv.width=wrap.clientWidth;windCv.height=wrap.clientHeight;}
}
window.addEventListener('resize',resizeWindCanvas);

class WindParticle{
  constructor(){this.reset();}
  reset(){
    this.x=Math.random()*windCv.width;
    this.y=Math.random()*windCv.height;
    this.age=0;
    this.maxAge=50+Math.random()*100;
  }
}

function initWindParticles(){
  resizeWindCanvas();
  windParticles=Array.from({length:WIND_PARTICLE_COUNT},()=>new WindParticle());
}

function getWindAtPoint(x,y){
  // Convert canvas coords to lat/lon and find nearest wind data
  if(!map||stateMarkers.length===0)return{speed:10,dir:45};
  const bounds=map.getBounds();
  const lng=bounds.getWest()+(x/windCv.width)*(bounds.getEast()-bounds.getWest());
  const lat=bounds.getNorth()-(y/windCv.height)*(bounds.getNorth()-bounds.getSouth());

  // Find nearest states and interpolate
  let totalWeight=0,avgSpeed=0,avgDirX=0,avgDirY=0;
  stateMarkers.forEach(({s})=>{
    if(s._w===null||s._wdir===null)return;
    const dist=Math.sqrt(Math.pow(s.lat-lat,2)+Math.pow(s.lon-lng,2));
    if(dist<15){
      const weight=1/(dist+0.5);
      totalWeight+=weight;
      avgSpeed+=s._w*weight;
      const rad=s._wdir*Math.PI/180;
      avgDirX+=Math.sin(rad)*weight;
      avgDirY-=Math.cos(rad)*weight;
    }
  });
  if(totalWeight>0){
    return{speed:avgSpeed/totalWeight,dir:Math.atan2(avgDirX,avgDirY)*180/Math.PI};
  }
  return{speed:10,dir:45};
}

function renderWindParticles(){
  if(!windEnabled){windAnimId=requestAnimationFrame(renderWindParticles);return;}

  // Fade trail effect
  windCx.fillStyle=`rgba(0,0,0,${1-WIND_FADE})`;
  windCx.fillRect(0,0,windCv.width,windCv.height);

  // Get theme color
  const style=getComputedStyle(document.body);
  const acc=style.getPropertyValue('--acc').trim()||'#4fc3f7';

  windParticles.forEach(p=>{
    const wind=getWindAtPoint(p.x,p.y);
    const speed=Math.min(wind.speed,50)/50;
    const rad=(wind.dir-90)*Math.PI/180;
    const vx=Math.cos(rad)*(1+speed*3);
    const vy=Math.sin(rad)*(1+speed*3);

    // Draw particle
    const alpha=Math.min(1,(1-p.age/p.maxAge)*speed*2);
    windCx.beginPath();
    // Handle both hex (#4fc3f7) and rgb() color formats
    let strokeColor;
    if(acc.startsWith('#')){
      const r=parseInt(acc.slice(1,3),16),g=parseInt(acc.slice(3,5),16),b=parseInt(acc.slice(5,7),16);
      strokeColor=`rgba(${r},${g},${b},${alpha})`;
    }else{
      strokeColor=acc.replace(')',`,${alpha})`).replace('rgb','rgba');
    }
    windCx.strokeStyle=strokeColor;
    windCx.lineWidth=1+speed;
    windCx.moveTo(p.x,p.y);
    p.x+=vx;p.y+=vy;
    windCx.lineTo(p.x,p.y);
    windCx.stroke();

    p.age++;
    if(p.age>p.maxAge||p.x<0||p.x>windCv.width||p.y<0||p.y>windCv.height){
      p.reset();
    }
  });

  windAnimId=requestAnimationFrame(renderWindParticles);
}

function toggleWind(){
  windEnabled=!windEnabled;
  document.getElementById('windToggle').classList.toggle('on',windEnabled);
  windCv.style.opacity=windEnabled?'0.7':'0';
  if(windEnabled&&!windAnimId)renderWindParticles();
}
document.getElementById('windToggle').onclick=toggleWind;

// Sync wind canvas with map movements
let windMapSynced=false;
function syncWindCanvas(){
  if(map&&!windMapSynced){
    windMapSynced=true;
    map.on('move',()=>{windParticles.forEach(p=>p.reset());});
    map.on('zoom',()=>{windParticles.forEach(p=>p.reset());});
  }
}

// ============ THEME SYSTEM (CINEMATIC) ============
function wmoToTheme(wCode){
  if(wCode<=2)return'sun';
  if(wCode<=49)return'cloudy';
  return'rain';
}

function setTheme(t,manual=false){
  if(curTheme===t&&!manual)return;

  // Cinematic wipe transition
  const wipe=document.getElementById('wipe');
  wipe.style.background=getComputedStyle(document.body).getPropertyValue('--bg1');
  wipe.classList.add('active');

  setTimeout(()=>{
    curTheme=t;
    document.body.className='theme-'+t+' mode-'+curSport;

    // Change map tiles
    if(map&&tileLayer){
      map.removeLayer(tileLayer);
      tileLayer=L.tileLayer(TILES[t],{attribution:'&copy; OSM &copy; CARTO',subdomains:'abcd',maxZoom:18}).addTo(map);
    }

    // Clear wind canvas on theme change
    if(windCx){windCx.clearRect(0,0,windCv.width,windCv.height);}

    // Reinit particles with fade
    setTimeout(()=>initParticles(),200);

    // Lightning only for rain
    if(t==='rain'){startLightning();}else{stopLightning();}

    // Refresh markers
    if(map)refreshMarkers();

    wipe.classList.remove('active');
    wipe.classList.add('exit');
    setTimeout(()=>{wipe.classList.remove('exit');},800);
  },400);

  if(manual){
    autoMode=false;
    clearTimeout(autoThemeTimer);
    autoThemeTimer=setTimeout(()=>{autoMode=true;},30000);
  }
}

function setThemeByWeather(wCode){
  if(!autoMode)return;
  setTheme(wmoToTheme(wCode));
}

// Theme is now automatic only (based on weather at user location)

// ============ SPORT MODE ============
document.querySelectorAll('.sport-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    curSport=b.dataset.sport;
    document.querySelectorAll('.sport-btn').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.body.className='theme-'+curTheme+' mode-'+curSport;
    if(map)refreshMarkers();
  });
});

// ============ CLOCK & NIGHT MODE ============
let isNight=false,nightModeAuto=true;
function isNightTime(hour){return hour>=18||hour<6;}
function updateNightMode(forceNight=null){
  const brt=new Date(new Date().toLocaleString('en',{timeZone:'America/Sao_Paulo'}));
  const hour=brt.getHours();
  const shouldBeNight=forceNight!==null?forceNight:(nightModeAuto?isNightTime(hour):isNight);
  if(shouldBeNight!==isNight){
    isNight=shouldBeNight;
    document.body.classList.toggle('night-mode',isNight);
    document.getElementById('niIcon').textContent=isNight?'\uD83C\uDF19':'\u2600\uFE0F';
    document.getElementById('niText').textContent=isNight?'NOITE':'DIA';
    document.getElementById('nightIndicator').classList.toggle('is-night',isNight);
  }
}
function tick(){
  const brt=new Date(new Date().toLocaleString('en',{timeZone:'America/Sao_Paulo'}));
  document.getElementById('clk').textContent=brt.toTimeString().slice(0,5);
  updateNightMode();
}
setInterval(tick,1000);tick();
// Night mode toggle (click to override, returns to auto after 60s)
document.getElementById('nightIndicator').onclick=()=>{
  nightModeAuto=false;
  updateNightMode(!isNight);
  setTimeout(()=>{nightModeAuto=true;},60000);
};

// ============ UNITS ============
document.getElementById('bC').onclick=()=>{celsius=true;document.getElementById('bC').classList.add('on');document.getElementById('bF').classList.remove('on');refreshAll();};
document.getElementById('bF').onclick=()=>{celsius=false;document.getElementById('bF').classList.add('on');document.getElementById('bC').classList.remove('on');refreshAll();};
document.getElementById('bKmh').onclick=()=>{knots=false;document.getElementById('bKmh').classList.add('on');document.getElementById('bKt').classList.remove('on');refreshAll();};
document.getElementById('bKt').onclick=()=>{knots=true;document.getElementById('bKt').classList.add('on');document.getElementById('bKmh').classList.remove('on');refreshAll();};
function toC(c){return celsius?Math.round(c)+'C':Math.round(c*9/5+32)+'F';}
function toN(c){return celsius?Math.round(c):Math.round(c*9/5+32);}
function toW(kmh){return knots?Math.round(kmh/1.852)+' nos':Math.round(kmh)+' km/h';}
function toWn(kmh){return knots?Math.round(kmh/1.852):Math.round(kmh);}

// ============ WMO ============
function wmoIcon(c){if(c===0)return'\u2600\uFE0F';if(c<=2)return'\u26C5';if(c===3)return'\u2601\uFE0F';if(c<=49)return'\uD83C\uDF2B\uFE0F';if(c<=59)return'\uD83C\uDF26\uFE0F';if(c<=69)return'\u2744\uFE0F';if(c<=82)return'\uD83C\uDF27\uFE0F';return'\u26C8\uFE0F';}
function wmoDesc(c){if(c===0)return'CEU LIMPO';if(c<=2)return'PARCIALMENTE NUBLADO';if(c===3)return'NUBLADO';if(c<=49)return'NEVOEIRO';if(c<=59)return'GAROA';if(c<=79)return'NEVE/GRANIZO';if(c<=82)return'CHUVA';return'TEMPESTADE';}

// ============ CONDITION LOGIC ============
function surfCondition(wCode,windKmh){
  if(wCode>=95)return{label:t('dangerous'),cls:'cond-poor',stars:0};
  if(wCode>=80)return{label:t('bad'),cls:'cond-poor',stars:1};
  if(windKmh<5)return{label:t('flat'),cls:'cond-flat',stars:2};
  if(windKmh>=15&&windKmh<=30&&wCode<=3)return{label:t('epic'),cls:'cond-epic',stars:5};
  if(windKmh>=10&&windKmh<=35&&wCode<=10)return{label:t('good'),cls:'cond-good',stars:4};
  if(windKmh>=8&&wCode<=20)return{label:t('fair'),cls:'cond-fair',stars:3};
  return{label:t('poor'),cls:'cond-poor',stars:1};
}
function kiteRating(kmh){if(kmh<8)return 1;if(kmh<12)return 3;if(kmh<16)return 5;if(kmh<22)return 8;if(kmh<30)return 10;if(kmh<40)return 7;if(kmh<50)return 4;return 2;}
function beaufort(kmh){
  if(kmh<1)return t('beaufortCalm')+' (0)';if(kmh<6)return t('beaufortLight')+' (1)';if(kmh<12)return t('beaufortBreezeLight')+' (2)';
  if(kmh<20)return t('beaufortBreeze')+' (3)';if(kmh<29)return t('beaufortBreezeMod')+' (4)';if(kmh<39)return t('beaufortBreezeFresh')+' (5)';
  if(kmh<50)return t('beaufortBreezeStrong')+' (6)';if(kmh<62)return t('beaufortNear')+' (7)';if(kmh<75)return t('beaufortGale')+' (8)';
  if(kmh<89)return t('beaufortGaleStrong')+' (9)';if(kmh<103)return t('beaufortStorm')+' (10)';if(kmh<118)return t('beaufortViolent')+' (11)';
  return t('beaufortHurricane')+' (12)';
}
function windDir16(deg){if(deg===null||deg===undefined||isNaN(deg))return'--';const dirs=['N','NNE','NE','ENE','L','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];return dirs[Math.round(deg/22.5)%16]||'N';}

// ============ WEATHER ALERTS ============
let alertDismissed=false;
function checkAlerts(current,daily){
  if(alertDismissed||!current)return null;
  const precip=daily?.precipitation_probability_max?.[0]??null;
  const wCode=current.weather_code??null;
  const wind=current.wind_speed_10m??null;
  const gust=current.wind_gusts_10m??null;
  const temp=current.temperature_2m??null;

  // Priority: Storm > Heavy Rain > Strong Wind > Heat
  if(wCode>=95)return{type:'storm',icon:'‚õàÔ∏è',text:t('alertStorm'),cls:'alert-storm'};
  if(precip>=80)return{type:'rain',icon:'üåßÔ∏è',text:`${t('alertRain')} (${precip}%)`,cls:'alert-rain'};
  if(gust>=60||wind>=50)return{type:'wind',icon:'üí®',text:`${t('alertWind')} (${Math.round(gust||wind)} KM/H)`,cls:'alert-wind'};
  if(temp>=38)return{type:'heat',icon:'üå°Ô∏è',text:`${t('alertHeat')} (${Math.round(temp)}¬∞C)`,cls:'alert-heat'};
  return null;
}
function showAlert(alert){
  if(!alert){hideAlert();return;}
  const banner=document.getElementById('alertBanner');
  const content=document.getElementById('alertContent');
  document.getElementById('alertIcon').textContent=alert.icon;
  document.getElementById('alertText').textContent=alert.text;
  content.className='alert-content '+alert.cls;
  banner.classList.add('show');
}
function hideAlert(){
  document.getElementById('alertBanner').classList.remove('show');
}
document.getElementById('alertClose').onclick=()=>{
  alertDismissed=true;
  hideAlert();
  setTimeout(()=>{alertDismissed=false;},300000); // Reset after 5 min
};

// ============ INMET OFFICIAL ALERTS ============
let inmetCache=null;
let inmetCacheTime=0;
const INMET_CACHE_TTL=15*60*1000; // 15 minutes
let inmetDismissed=false;
let currentINMETAlerts=[];

// Area mapping: States ‚Üí INMET area names
const AREA_MAP={
  'AC':['acre'],
  'AL':['alagoas'],
  'AM':['amazonas'],
  'AP':['amapa','amap√°'],
  'BA':['bahia','sul da bahia','norte da bahia','rec√¥ncavo'],
  'CE':['ceara','cear√°','fortaleza'],
  'DF':['distrito federal','brasilia','bras√≠lia'],
  'ES':['espirito santo','esp√≠rito santo'],
  'GO':['goias','goi√°s'],
  'MA':['maranhao','maranh√£o'],
  'MG':['minas gerais','sul de minas','tri√¢ngulo mineiro','zona da mata','norte de minas'],
  'MS':['mato grosso do sul'],
  'MT':['mato grosso'],
  'PA':['para','par√°','bel√©m'],
  'PB':['paraiba','para√≠ba'],
  'PE':['pernambuco','recife'],
  'PI':['piaui','piau√≠'],
  'PR':['parana','paran√°','curitiba'],
  'RJ':['rio de janeiro','regi√£o serrana','baixada fluminense','costa verde'],
  'RN':['rio grande do norte'],
  'RO':['rondonia','rond√¥nia'],
  'RR':['roraima'],
  'RS':['rio grande do sul','serra ga√∫cha','litoral ga√∫cho'],
  'SC':['santa catarina','litoral catarinense'],
  'SE':['sergipe'],
  'SP':['s√£o paulo','sao paulo','vale do para√≠ba','litoral paulista','grande s√£o paulo','litoral norte','litoral sul'],
  'TO':['tocantins']
};

// Event icons mapping
const INMET_ICONS={
  'chuvas intensas':'üåßÔ∏è',
  'acumulado de chuva':'üåßÔ∏è',
  'tempestade':'‚õàÔ∏è',
  'vendaval':'üå™Ô∏è',
  'ventos costeiros':'üí®',
  'baixa umidade':'üèúÔ∏è',
  'onda de calor':'üå°Ô∏è',
  'geada':'‚ùÑÔ∏è',
  'granizo':'üßä',
  'default':'‚ö†Ô∏è'
};

async function fetchINMETAlerts(){
  // Skip on mobile for performance
  if(isMobile)return[];

  // Use cache if valid
  if(inmetCache&&Date.now()-inmetCacheTime<INMET_CACHE_TTL){
    return inmetCache;
  }

  try{
    // Use CORS proxy for cross-origin request
    const PROXY='https://corsproxy.io/?';
    const url=PROXY+encodeURIComponent('https://apiprevmet3.inmet.gov.br/avisos/rss');
    const r=await fetch(url,{timeout:10000});
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const text=await r.text();
    const alerts=parseINMETRSS(text);

    inmetCache=alerts;
    inmetCacheTime=Date.now();
    console.log('INMET alerts loaded:',alerts.length);
    return alerts;
  }catch(e){
    console.warn('INMET fetch error:',e);
    return inmetCache||[]; // Return old cache if fetch fails
  }
}

function parseINMETRSS(xmlText){
  try{
    const parser=new DOMParser();
    const doc=parser.parseFromString(xmlText,'text/xml');
    const items=doc.querySelectorAll('item');

    return Array.from(items).map(item=>{
      const title=item.querySelector('title')?.textContent||'';
      const desc=item.querySelector('description')?.textContent||'';
      const link=item.querySelector('link')?.textContent||'';
      const guid=item.querySelector('guid')?.textContent||'';
      const pubDate=item.querySelector('pubDate')?.textContent||'';

      // Parse description HTML
      const tempDiv=document.createElement('div');
      tempDiv.innerHTML=desc;

      // Extract fields from table
      const fields={};
      const rows=tempDiv.querySelectorAll('tr');
      rows.forEach(row=>{
        const cells=row.querySelectorAll('td');
        if(cells.length>=2){
          const key=cells[0].textContent.trim().toLowerCase().replace(':','');
          const val=cells[1].textContent.trim();
          fields[key]=val;
        }
      });

      // Determine severity class
      let severityClass='inmet-yellow';
      const sev=(fields['severidade']||title).toLowerCase();
      if(sev.includes('grande perigo'))severityClass='inmet-red';
      else if(sev.includes('perigo')&&!sev.includes('potencial'))severityClass='inmet-orange';

      // Get event icon
      const evento=(fields['evento']||'').toLowerCase();
      let icon=INMET_ICONS['default'];
      for(const[key,ico]of Object.entries(INMET_ICONS)){
        if(evento.includes(key)){icon=ico;break;}
      }

      return{
        id:guid,
        title:title,
        evento:fields['evento']||'Alerta Meteorol√≥gico',
        severidade:fields['severidade']||'Perigo Potencial',
        severityClass:severityClass,
        icon:icon,
        inicio:fields['in√≠cio']||fields['inicio']||'',
        fim:fields['fim']||'',
        descricao:fields['descri√ß√£o']||fields['descricao']||'',
        area:fields['√°rea']||fields['area']||'',
        link:link,
        pubDate:pubDate
      };
    });
  }catch(e){
    console.warn('INMET parse error:',e);
    return[];
  }
}

function isINMETAlertActive(alert){
  if(!alert.fim)return true;
  try{
    // Parse Brazilian date format: DD/MM/YYYY HH:MM
    const parts=alert.fim.match(/(\d{2})\/(\d{2})\/(\d{4})\s*(\d{2})?:?(\d{2})?/);
    if(!parts)return true;
    const endDate=new Date(parts[3],parts[2]-1,parts[1],parts[4]||23,parts[5]||59);
    return Date.now()<endDate.getTime();
  }catch(e){return true;}
}

function alertAffectsState(alertArea,stateCode){
  if(!alertArea||!stateCode)return false;
  const areas=AREA_MAP[stateCode]||[];
  const areaLower=alertArea.toLowerCase();
  return areas.some(a=>areaLower.includes(a));
}

function getHighestSeverity(alerts){
  if(alerts.some(a=>a.severityClass==='inmet-red'))return'inmet-red';
  if(alerts.some(a=>a.severityClass==='inmet-orange'))return'inmet-orange';
  return'inmet-yellow';
}

async function checkINMETAlerts(){
  // Skip on mobile for performance
  if(isMobile)return;

  const alerts=await fetchINMETAlerts();
  currentINMETAlerts=alerts.filter(a=>isINMETAlertActive(a));

  if(currentINMETAlerts.length>0&&!inmetDismissed){
    showINMETBanner(currentINMETAlerts[0]);
    markAffectedStates(currentINMETAlerts);
  }
}

function showINMETBanner(alert){
  const banner=document.getElementById('inmetBanner');
  const content=document.getElementById('inmetContent');
  document.getElementById('inmetEvento').textContent=`${alert.icon} ${alert.evento} - ${alert.area.substring(0,60)}${alert.area.length>60?'...':''}`;
  document.getElementById('inmetSeveridade').textContent=alert.severidade;
  content.className='inmet-content '+alert.severityClass;
  banner.classList.add('show');
}

function hideINMETBanner(){
  document.getElementById('inmetBanner').classList.remove('show');
}

function showINMETModal(alert){
  const modal=document.getElementById('inmetModal');
  document.getElementById('inmetModalIcon').textContent=alert.icon;
  document.getElementById('inmetModalTitle').textContent=alert.evento;

  const body=document.getElementById('inmetModalBody');
  body.innerHTML=`
    <div class="inmet-field">
      <div class="inmet-field-label">SEVERIDADE</div>
      <div class="inmet-field-value"><span class="inmet-severidade ${alert.severityClass}" style="display:inline-block;">${alert.severidade}</span></div>
    </div>
    <div class="inmet-field">
      <div class="inmet-field-label">PER√çODO</div>
      <div class="inmet-field-value">${alert.inicio||'N/A'} ‚Üí ${alert.fim||'N/A'}</div>
    </div>
    <div class="inmet-field">
      <div class="inmet-field-label">DESCRI√á√ÉO</div>
      <div class="inmet-field-value">${escapeHtml(alert.descricao)||'Sem descri√ß√£o dispon√≠vel.'}</div>
    </div>
    <div class="inmet-field">
      <div class="inmet-field-label">√ÅREAS AFETADAS</div>
      <div class="inmet-field-value">${escapeHtml(alert.area)||'N√£o especificado.'}</div>
    </div>
    ${alert.link?`<a href="${escapeHtml(alert.link)}" target="_blank" rel="noopener" class="inmet-link">VER NO INMET ‚Üí</a>`:''}
  `;
  modal.classList.add('show');
}

function hideINMETModal(){
  document.getElementById('inmetModal').classList.remove('show');
}

function markAffectedStates(alerts){
  // Remove existing indicators
  document.querySelectorAll('.inmet-indicator').forEach(el=>el.remove());

  stateMarkers.forEach(({s,marker})=>{
    const stateAlerts=alerts.filter(a=>alertAffectsState(a.area,s.code));
    if(stateAlerts.length>0){
      const severity=getHighestSeverity(stateAlerts);
      const el=marker.getElement();
      if(el){
        const indicator=document.createElement('div');
        indicator.className=`inmet-indicator inmet-indicator-${severity.replace('inmet-','')}`;
        indicator.title=`${stateAlerts.length} alerta(s) INMET`;
        el.style.position='relative';
        el.appendChild(indicator);
      }
    }
  });
}

// INMET Event Listeners
document.getElementById('inmetClose').onclick=()=>{
  inmetDismissed=true;
  hideINMETBanner();
  setTimeout(()=>{inmetDismissed=false;},600000); // Reset after 10 min
};
document.getElementById('inmetDetails').onclick=()=>{
  if(currentINMETAlerts.length>0){
    showINMETModal(currentINMETAlerts[0]);
  }
};
document.getElementById('inmetModalClose').onclick=hideINMETModal;
document.getElementById('inmetModal').onclick=(e)=>{
  if(e.target.id==='inmetModal')hideINMETModal();
};

// ============ SPOT MODAL ============
const spotModal=document.getElementById('spotModal');
let currentSpot={name:'',lat:0,lon:0,type:''};
document.getElementById('spotModalClose').onclick=()=>spotModal.classList.remove('show');
spotModal.onclick=(e)=>{if(e.target===spotModal)spotModal.classList.remove('show');};
document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){spotModal.classList.remove('show');hideINMETModal();}});

async function openSpotModal(name,lat,lon,type){
  // Sanitize inputs for security
  const safeName=sanitizeLocationName(name)||'LOCATION';
  const safeLat=validateCoord(lat,-90,90);
  const safeLon=validateCoord(lon,-180,180);
  const safeType=validateSpotType(type);
  if(safeLat===null||safeLon===null)return;
  currentSpot={name:safeName,lat:safeLat,lon:safeLon,type:safeType};
  const icons={surf:'üèÑ',kite:'ü™Å',wind:'üèÑ',sail:'‚õµ',fish:'üé£',state:'üìç'};
  document.getElementById('smtIcon').textContent=icons[safeType]||'üèñÔ∏è';
  document.getElementById('smtName').textContent=safeName.toUpperCase();
  spotModal.classList.add('show');

  // Show loading state
  document.getElementById('scIcon').textContent='‚è≥';
  document.getElementById('scTemp').textContent='--¬∞';
  document.getElementById('scDesc').textContent='CARREGANDO...';
  document.getElementById('spotForecast').innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;opacity:.5;">CARREGANDO PREVISAO...</div>';

  // Fetch 7-day forecast
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,wind_speed_10m_max&timezone=America%2FSao_Paulo&forecast_days=7`);
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    const c=d.current;

    // Update current conditions
    document.getElementById('scIcon').textContent=wmoIcon(c.weather_code);
    document.getElementById('scTemp').textContent=toN(c.temperature_2m)+'¬∞';
    document.getElementById('scDesc').textContent=wmoDesc(c.weather_code);
    document.getElementById('scWind').textContent=toW(c.wind_speed_10m);
    document.getElementById('scHum').textContent=c.relative_humidity_2m+'%';

    // Try to get wave data
    const marine=await fwMarine(lat,lon);
    if(marine?.current?.wave_height){
      document.getElementById('scWave').textContent=marine.current.wave_height.toFixed(1)+'m';
    }else{
      document.getElementById('scWave').textContent='--';
    }

    // Build 7-day forecast
    const D=['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
    const fg=document.getElementById('spotForecast');
    fg.innerHTML='';
    for(let i=0;i<7;i++){
      const dt=new Date(d.daily.time[i]);
      const div=document.createElement('div');
      div.className='spot-day';
      div.innerHTML=`
        <div class="spot-day-name">${i===0?'HOJE':D[dt.getDay()]}</div>
        <div class="spot-day-icon">${wmoIcon(d.daily.weather_code[i])}</div>
        <div class="spot-day-temps">
          <div class="spot-day-max">${toN(d.daily.temperature_2m_max[i])}¬∞</div>
          <div class="spot-day-min">${toN(d.daily.temperature_2m_min[i])}¬∞</div>
        </div>
        <div class="spot-day-wind">üí® ${toWn(d.daily.wind_speed_10m_max[i])}</div>
        <div class="spot-day-precip">üíß ${d.daily.precipitation_probability_max[i]}%</div>
      `;
      fg.appendChild(div);
    }
  }catch(e){
    document.getElementById('scDesc').textContent='ERRO AO CARREGAR';
    document.getElementById('spotForecast').innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;color:#f44336;">ERRO AO CARREGAR DADOS</div>';
  }
}

// ============ SHARE FUNCTIONALITY ============
function showToast(msg){
  const toast=document.getElementById('shareToast');
  toast.textContent=msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),2500);
}
function generateShareUrl(){
  const base=window.location.origin+window.location.pathname;
  // Use sanitized values from currentSpot (already sanitized in openSpotModal)
  const params=new URLSearchParams({
    spot:encodeURIComponent(currentSpot.name||''),
    lat:currentSpot.lat.toFixed(4),
    lon:currentSpot.lon.toFixed(4),
    type:validateSpotType(currentSpot.type)
  });
  return base+'?'+params.toString();
}
async function shareSpot(){
  const url=generateShareUrl();
  const title=`MetBrasil - ${currentSpot.name}`;
  const text=`Confira as condicoes em ${currentSpot.name} no MetBrasil!`;

  if(navigator.share){
    try{
      await navigator.share({title,text,url});
    }catch(e){
      if(e.name!=='AbortError')copyToClipboard(url);
    }
  }else{
    copyToClipboard(url);
  }
}
function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=>{
    showToast('LINK COPIADO!');
  }).catch(()=>{
    // Fallback for older browsers
    const ta=document.createElement('textarea');
    ta.value=text;ta.style.position='fixed';ta.style.opacity='0';
    document.body.appendChild(ta);ta.select();
    document.execCommand('copy');document.body.removeChild(ta);
    showToast('LINK COPIADO!');
  });
}
document.getElementById('shareBtn').onclick=shareSpot;

// Parse URL parameters on load with security validation
function parseUrlParams(){
  const params=new URLSearchParams(window.location.search);
  if(params.has('spot')&&params.has('lat')&&params.has('lon')){
    // Sanitize and validate all inputs
    const name=sanitizeLocationName(params.get('spot'));
    const lat=validateCoord(params.get('lat'),-90,90);
    const lon=validateCoord(params.get('lon'),-180,180);
    const type=validateSpotType(params.get('type')||'surf');
    // Only return if all values are valid
    if(name&&name.length>0&&lat!==null&&lon!==null){
      return{name,lat,lon,type};
    }
  }
  return null;
}

// ============ WAVE HELPERS ============
function waveQuality(height){
  if(height===null||height===undefined)return{label:'SEM DADOS',cls:'wq-flat'};
  if(height<0.3)return{label:'FLAT',cls:'wq-flat'};
  if(height<0.8)return{label:'FRACO',cls:'wq-poor'};
  if(height<1.5)return{label:'BOM',cls:'wq-good'};
  if(height<2.5)return{label:'EPICO',cls:'wq-epic'};
  return{label:'GRANDE',cls:'wq-fair'};
}
function waveDir(deg){
  if(deg===null||deg===undefined||isNaN(deg))return'--';
  const dirs=['N','NE','L','SE','S','SO','O','NO'];
  const idx=((Math.round(deg/45)%8)+8)%8;// Handle negative values
  return dirs[idx];
}

// ============ TIDE CALCULATIONS (Lunar Approximation) ============
function getMoonPhase(date=new Date()){
  // Simplified lunar phase calculation
  const lp=2551443; // Lunar period in seconds
  const newMoon=new Date(1970,0,7,20,35,0).getTime()/1000;
  const phase=((date.getTime()/1000-newMoon)%lp)/lp;
  return phase;
}

function getMoonInfo(phase){
  if(phase<0.03||phase>0.97)return{icon:'üåë',name:t('newMoon'),tideStr:t('springTides')};
  if(phase<0.22)return{icon:'üåí',name:t('waxingCres'),tideStr:t('mediumTides')};
  if(phase<0.28)return{icon:'üåì',name:t('firstQuarter'),tideStr:t('neapTides')};
  if(phase<0.47)return{icon:'üåî',name:t('waxingGib'),tideStr:t('mediumTides')};
  if(phase<0.53)return{icon:'üåï',name:t('fullMoon'),tideStr:t('springTides')};
  if(phase<0.72)return{icon:'üåñ',name:t('waningGib'),tideStr:t('mediumTides')};
  if(phase<0.78)return{icon:'üåó',name:t('lastQuarter'),tideStr:t('neapTides')};
  return{icon:'üåò',name:t('waningCres'),tideStr:t('mediumTides')};
}

function getTideEvents(date=new Date()){
  // Simplified tide calculation based on lunar position
  // Average tide cycle ~12h 25min
  const tideCycle=12*60+25; // minutes
  const phase=getMoonPhase(date);

  // Base high tide at moon transit (simplified)
  const dayStart=new Date(date);
  dayStart.setHours(0,0,0,0);
  const moonTransit=(phase*24*60)%1440; // minutes from midnight

  // Calculate 4 tide events (2 high, 2 low)
  const events=[];
  const highTide1=(moonTransit)%1440;
  const lowTide1=(moonTransit+tideCycle/2)%1440;
  const highTide2=(moonTransit+tideCycle)%1440;
  const lowTide2=(moonTransit+tideCycle*1.5)%1440;

  [
    {m:highTide1,typeKey:'tideHigh',icon:'‚¨ÜÔ∏è'},
    {m:lowTide1,typeKey:'tideLow',icon:'‚¨áÔ∏è'},
    {m:highTide2,typeKey:'tideHigh',icon:'‚¨ÜÔ∏è'},
    {m:lowTide2,typeKey:'tideLow',icon:'‚¨áÔ∏è'}
  ].sort((a,b)=>a.m-b.m).forEach(e=>{
    const h=Math.floor(e.m/60);
    const m=Math.floor(e.m%60);
    events.push({...e,time:`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`});
  });

  return events;
}

function getCurrentTideStatus(events){
  const now=new Date();
  const nowMins=now.getHours()*60+now.getMinutes();

  for(let i=0;i<events.length;i++){
    const [h,m]=events[i].time.split(':').map(Number);
    const evtMins=h*60+m;
    if(evtMins>nowMins){
      const prev=events[(i-1+4)%4];
      const isRising=events[i].typeKey==='tideHigh';
      return{
        statusKey:isRising?'tideRising':'tideFalling',
        icon:isRising?'üìà':'üìâ',
        next:events[i],
        nextIdx:i
      };
    }
  }
  return{statusKey:'tideRising',icon:'üìà',next:events[0],nextIdx:0};
}

function buildTides(){
  const container=document.getElementById('tideContent');
  const phase=getMoonPhase();
  const moonInfo=getMoonInfo(phase);
  const events=getTideEvents();
  const status=getCurrentTideStatus(events);

  // Build SVG tide curve
  const curvePoints=[];
  for(let i=0;i<=100;i++){
    const t=i/100;
    const y=50-40*Math.sin(t*Math.PI*4+phase*Math.PI*2);
    curvePoints.push(`${i},${y}`);
  }

  // Current position on curve
  const now=new Date();
  const nowPct=(now.getHours()*60+now.getMinutes())/1440*100;

  let html=`
    <div class="tide-display">
      <div class="tide-icon">${status.icon}</div>
      <div class="tide-data">
        <div class="tide-status">${t(status.statusKey)}</div>
        <div class="tide-time">${t('nextTide')}: ${t(status.next.typeKey)} ${status.next.time}</div>
      </div>
    </div>
    <div class="tide-curve">
      <svg class="tide-curve-svg" viewBox="0 0 100 60" preserveAspectRatio="none">
        <defs>
          <linearGradient id="tideGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:var(--acc);stop-opacity:0.5"/>
            <stop offset="100%" style="stop-color:var(--acc);stop-opacity:0"/>
          </linearGradient>
        </defs>
        <path class="tide-curve-fill" d="M0,60 L0,${curvePoints[0].split(',')[1]} ${curvePoints.map(p=>'L'+p).join(' ')} L100,60 Z"/>
        <polyline class="tide-curve-line" points="${curvePoints.join(' ')}"/>
        <circle class="tide-curve-marker" cx="${nowPct}" cy="${50-40*Math.sin(nowPct/100*Math.PI*4+phase*Math.PI*2)}" r="3"/>
      </svg>
    </div>
    <div class="tide-times">
      ${events.map((e,i)=>`
        <div class="tide-event${i===status.nextIdx?' next':''}">
          <span class="tide-event-icon">${e.icon}</span>
          <span class="tide-event-type">${t(e.typeKey)}</span>
          <span class="tide-event-time">${e.time}</span>
        </div>
      `).join('')}
    </div>
    <div class="tide-moon">
      <span class="tide-moon-icon">${moonInfo.icon}</span>
      <span class="tide-moon-info">${moonInfo.name} ¬∑ ${moonInfo.tideStr}</span>
    </div>
    <div class="tide-approx">* ${t('lunarApprox')}</div>
  `;

  container.innerHTML=html;
}

// ============ FETCH MARINE ============
let marineCache={};
async function fwMarine(lat,lon){
  // Validate coordinates
  const safeLat=validateCoord(lat,-90,90);
  const safeLon=validateCoord(lon,-180,180);
  if(safeLat===null||safeLon===null)return null;
  const k=`m${safeLat.toFixed(1)},${safeLon.toFixed(1)}`;
  if(marineCache[k])return marineCache[k];
  try{
    const r=await fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${safeLat}&longitude=${safeLon}&current=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period&daily=wave_height_max,wave_direction_dominant,wave_period_max,swell_wave_height_max&timezone=America%2FSao_Paulo&forecast_days=5`);
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    // Basic response structure validation
    if(!d||typeof d!=='object')throw new Error('Invalid response');
    marineCache[k]=d;
    return d;
  }catch(e){console.warn('fwMarine() error:',e);return null;}
}

// ============ FETCH ============
async function fw(lat,lon){
  // Validate coordinates
  const safeLat=validateCoord(lat,-90,90);
  const safeLon=validateCoord(lon,-180,180);
  if(safeLat===null||safeLon===null)return null;
  const k=`${safeLat.toFixed(1)},${safeLon.toFixed(1)}`;
  if(cache[k])return cache[k];
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${safeLat}&longitude=${safeLon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,surface_pressure,visibility,cloud_cover&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code&timezone=America%2FSao_Paulo&forecast_days=5`);
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    // Basic response structure validation
    if(!d||typeof d!=='object'||!d.current)throw new Error('Invalid response structure');
    cache[k]=d;saveCache();return d;
  }catch(e){console.warn('fw() error:',e);return null;}
}

// ============ FETCH BATCH (27 states in 1 request) ============
async function fwBatch(locations){
  // Filter locations not in cache
  const uncached=[];
  const results=[];
  locations.forEach((loc,i)=>{
    const safeLat=validateCoord(loc.lat,-90,90);
    const safeLon=validateCoord(loc.lon,-180,180);
    const k=`${safeLat.toFixed(1)},${safeLon.toFixed(1)}`;
    if(cache[k]){
      results[i]={loc,d:cache[k],cached:true};
    }else{
      uncached.push({loc,idx:i,k,lat:safeLat,lon:safeLon});
      results[i]={loc,d:null,cached:false};
    }
  });
  // If all cached, return immediately
  if(uncached.length===0)return results;
  // Build batch request
  const lats=uncached.map(u=>u.lat).join(',');
  const lons=uncached.map(u=>u.lon).join(',');
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lons}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,surface_pressure,visibility,cloud_cover&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code&timezone=America%2FSao_Paulo&forecast_days=5`);
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const data=await r.json();
    // Handle single vs multiple results
    const dataArr=Array.isArray(data)?data:[data];
    uncached.forEach((u,i)=>{
      const d=dataArr[i];
      if(d&&d.current){
        cache[u.k]=d;
        results[u.idx].d=d;
      }
    });
    saveCache(); // persist to localStorage
  }catch(e){console.warn('fwBatch() error:',e);}
  return results;
}

// ============ MAP ============
function initMap(lat,lon){
  map=L.map('map',{center:[lat,lon],zoom:5,zoomControl:true,attributionControl:true});
  tileLayer=L.tileLayer(TILES[curTheme],{attribution:'&copy; OSM &copy; CARTO',subdomains:'abcd',maxZoom:18}).addTo(map);
  map.on('click',async(e)=>{const{lat:lt,lng:ln}=e.latlng;await showMapPopup(lt,ln,null);});
  map.fitBounds([[-34,-74],[5,-28]]);
}
function tempColor(t){if(t===null)return'#8b9dc3';if(t<20)return'#4CAF50';if(t<30)return'#FF9800';return'#f44336';}
function makeIcon(temp,icon,highlight=false){
  const col=tempColor(temp);const sz=highlight?48:40;const t=temp!==null?Math.round(temp)+'':'?';
  return L.divIcon({className:'',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2],popupAnchor:[0,-(sz/2+4)],
    html:`<div style="width:${sz}px;height:${sz}px;border-radius:50%;background:${col};border:3px solid rgba(255,255,255,${highlight?.95:.6});display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 ${highlight?25:15}px ${col},0 4px 12px rgba(0,0,0,.5);font-family:'Bebas Neue',sans-serif;line-height:1;cursor:pointer;${highlight?'transform:scale(1.15);':''}"><span style="font-size:${highlight?'1rem':'.85rem'};color:white;font-weight:700;">${t}</span><span style="font-size:${highlight?'.85rem':'.7rem'};margin-top:-2px;">${icon}</span></div>`
  });
}
function makeSpotIcon(type){
  const colors={surf:'#0097a7',kite:'#7c4dff',wind:'#00897b',sail:'#1565c0',fish:'#558b2f',para:'#f57c00'};
  const icons={surf:'\uD83C\uDFC4',kite:'\uD83E\uDE81',wind:'\uD83C\uDFC4',sail:'\u26F5',fish:'\uD83C\uDFA3',para:'\uD83E\uDE82'};
  const col=colors[type]||'#0097a7';const ico=icons[type]||'\uD83C\uDFC4';
  return L.divIcon({className:'',iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-20],
    html:`<div style="width:32px;height:32px;border-radius:50%;background:${col};border:3px solid white;display:flex;align-items:center;justify-content:center;box-shadow:0 0 15px ${col};font-size:1rem;cursor:pointer;">${ico}</div>`
  });
}
function makeUserIcon(){return L.divIcon({className:'',iconSize:[20,20],iconAnchor:[10,10],html:`<div class="loc-dot"></div>`});}

// ============ MARKERS ============
async function placeStateMarkers(){
  if(!map)return;
  // BATCH API: 1 request for all 27 states instead of 27 requests
  const batchRes=await fwBatch(STATES);
  const res=batchRes.map(({loc,d})=>{
    const s=loc;
    s._t=d?d.current.temperature_2m:null;s._h=d?d.current.relative_humidity_2m:null;
    s._w=d?d.current.wind_speed_10m:null;s._wdir=d?d.current.wind_direction_10m:null;
    s._c=d?d.current.weather_code:0;s._daily=d?d.daily:null;s._hourly=d?d.hourly:null;
    s._prec=d&&d.daily?d.daily.precipitation_probability_max[0]:null;
    s._feel=d?d.current.apparent_temperature:null;s._gust=d?d.current.wind_gusts_10m:null;
    const icon=makeIcon(s._t,wmoIcon(s._c));
    const marker=L.marker([s.lat,s.lon],{icon}).addTo(map);
    marker.on('click',()=>{selState(s);showStatePopup(s,marker);});
    stateMarkers.push({s,marker});
    return {s,d};
  });
  buildStateGrid(res);
  placeSpotMarkers();
  setTimeout(()=>document.getElementById('loading').classList.add('hide'),500);
}
async function placeSpotMarkers(){
  if(!map)return;
  SPOTS.forEach(sp=>{
    const marker=L.marker([sp.lat,sp.lon],{icon:makeSpotIcon(sp.type)}).addTo(map);
    marker.on('click',()=>{openSpotModal(sp.name,sp.lat,sp.lon,sp.type);});
    spotMarkers.push({sp,marker});
  });
  buildSpotsGrid();
}
function refreshMarkers(){
  stateMarkers.forEach(({s,marker})=>{marker.setIcon(makeIcon(s._t,wmoIcon(s._c)));});
  if(userMarker)userMarker.setIcon(makeUserIcon());
}

// ============ POPUPS ============
function showStatePopup(s,marker){
  // Build popup safely using escaped values
  const safeName=escapeHtml(s.name).toUpperCase();
  const html=`<div class="pop-content"><div class="pop-title">${safeName}</div><div style="display:flex;align-items:baseline;gap:8px;"><div class="pop-temp">${toN(s._t||0)}</div><div style="font-size:.9rem;opacity:.6;">${celsius?'C':'F'}</div><div style="font-size:1.6rem;margin-left:6px;">${wmoIcon(s._c)}</div></div><div class="pop-desc">${wmoDesc(s._c)}</div><div class="pop-meta"><div class="pop-m"><span class="pop-ml">VENTO</span><span class="pop-mv">${toW(s._w||0)}</span></div><div class="pop-m"><span class="pop-ml">RAJADAS</span><span class="pop-mv">${toW(s._gust||0)}</span></div><div class="pop-m"><span class="pop-ml">UMIDADE</span><span class="pop-mv">${s._h||'--'}%</span></div><div class="pop-m"><span class="pop-ml">CHUVA</span><span class="pop-mv">${s._prec!==null?s._prec+'%':'--'}</span></div></div></div>`;
  marker.bindPopup(html,{maxWidth:240}).openPopup();
}
async function showMapPopup(lat,lon,name){
  const d=await fw(lat,lon);if(!d)return;const c=d.current;
  const tmpMk=L.marker([lat,lon],{icon:makeIcon(c.temperature_2m,wmoIcon(c.weather_code),true)}).addTo(map);
  // Build popup safely using escaped values
  const safeName=name?escapeHtml(name).toUpperCase():'\uD83D\uDCCD '+lat.toFixed(2)+', '+lon.toFixed(2);
  const html=`<div class="pop-content"><div class="pop-title">${safeName}</div><div style="display:flex;align-items:baseline;gap:8px;"><div class="pop-temp">${toN(c.temperature_2m)}</div><div style="font-size:.9rem;opacity:.6;">${celsius?'C':'F'}</div><div style="font-size:1.6rem;margin-left:6px;">${wmoIcon(c.weather_code)}</div></div><div class="pop-desc">${wmoDesc(c.weather_code)}</div><div class="pop-meta"><div class="pop-m"><span class="pop-ml">VENTO</span><span class="pop-mv">${toW(c.wind_speed_10m)}</span></div><div class="pop-m"><span class="pop-ml">RAJADAS</span><span class="pop-mv">${toW(c.wind_gusts_10m)}</span></div><div class="pop-m"><span class="pop-ml">UMIDADE</span><span class="pop-mv">${c.relative_humidity_2m}%</span></div><div class="pop-m"><span class="pop-ml">PRESSAO</span><span class="pop-mv">${Math.round(c.surface_pressure)} hPa</span></div></div></div>`;
  tmpMk.bindPopup(html,{maxWidth:240}).openPopup();
  tmpMk.on('popupclose',()=>map.removeLayer(tmpMk));
}

// ============ LOAD MAIN ============
async function loadMain(lat,lon,city){
  const d=await fw(lat,lon);if(!d||!d.current)return;const c=d.current;
  setThemeByWeather(c.weather_code);
  // Sanitize city name before display
  const safeCity=sanitizeLocationName(city)||'LOCATION';
  document.getElementById('mcity').textContent=safeCity.toUpperCase();
  document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'C':'F')+'</sup>';
  document.getElementById('mdesc').textContent=wmoDesc(c.weather_code);
  document.getElementById('micon').textContent=wmoIcon(c.weather_code);

  // Update header weather status
  document.getElementById('wsIcon').textContent=wmoIcon(c.weather_code);
  document.getElementById('wsTemp').textContent=toN(c.temperature_2m)+'¬∞';
  document.getElementById('wsDesc').textContent=wmoDesc(c.weather_code);
  document.getElementById('wsLoc').textContent='üìç '+safeCity;
  document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
  document.getElementById('mhum').textContent=c.relative_humidity_2m+'%';
  document.getElementById('mgust').textContent=toW(c.wind_gusts_10m);
  document.getElementById('mpress').textContent=Math.round(c.surface_pressure)+' hPa';
  document.getElementById('mvis').textContent=(c.visibility!==null&&c.visibility!==undefined)?(c.visibility/1000).toFixed(1)+' km':'--';
  document.getElementById('mclouds').textContent=c.cloud_cover+'%';
  document.getElementById('wrNeedle').style.setProperty('--wd',c.wind_direction_10m+'deg');
  document.getElementById('wrSpeed').textContent=toW(c.wind_speed_10m);
  document.getElementById('wrDir').textContent=windDir16(c.wind_direction_10m)+' ('+Math.round(c.wind_direction_10m)+')';
  document.getElementById('wrBeaufort').textContent=beaufort(c.wind_speed_10m);
  const kr=kiteRating(c.wind_speed_10m);
  document.getElementById('kiteFill').style.width=(kr*10)+'%';
  document.getElementById('kiteVal').textContent=kr+'/10';
  const cond=surfCondition(c.weather_code,c.wind_speed_10m);
  const badge=document.getElementById('condBadge');
  badge.className='cond-badge '+cond.cls;
  badge.innerHTML=cond.label+' <span class="stars">'+'&#9733;'.repeat(cond.stars)+'&#9734;'.repeat(5-cond.stars)+'</span>';
  buildHours(d.hourly);
  buildWindTable(d.daily);
  // Check for weather alerts
  const alert=checkAlerts(c,d.daily);
  showAlert(alert);
  // Load marine/wave data
  fwMarine(lat,lon).then(marine=>buildWaves(marine));
  // Build tide display
  buildTides();
  if(userMarker)map.removeLayer(userMarker);
  userMarker=L.marker([lat,lon],{icon:makeUserIcon(),zIndexOffset:1000}).addTo(map);
}

// ============ BUILD HOURS ============
function buildHours(hourly){
  const strip=document.getElementById('hourStrip');strip.innerHTML='';
  if(!hourly||!hourly.time||!hourly.temperature_2m)return;
  const now=new Date();const baseHour=now.getHours();
  let peakWind=0,peakIdx=0;
  for(let i=0;i<12;i++){
    const idx=baseHour+i;if(idx>=hourly.time.length)break;
    if(hourly.wind_speed_10m[idx]>peakWind){peakWind=hourly.wind_speed_10m[idx];peakIdx=i;}
  }
  for(let i=0;i<12;i++){
    const idx=baseHour+i;if(idx>=hourly.time.length)break;
    const el=document.createElement('div');
    el.className='hour-item'+(i===peakIdx?' peak':'');
    const hr=(baseHour+i)%24;
    el.innerHTML=`<div class="htime">${String(hr).padStart(2,'0')}H</div><div class="hicon">${wmoIcon(hourly.weather_code[idx])}</div><div class="htemp">${toN(hourly.temperature_2m[idx])}</div><div class="hwind">${toWn(hourly.wind_speed_10m[idx])}${knots?' KT':''}</div>`;
    strip.appendChild(el);
  }
}

// ============ BUILD WIND TABLE ============
function buildWindTable(daily){
  const tbody=document.querySelector('#windTable tbody');tbody.innerHTML='';
  if(!daily||!daily.time)return;
  const D=['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
  for(let i=0;i<5;i++){
    const dt=new Date(daily.time[i]);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i===0?'HOJE':D[dt.getDay()]}</td><td class="wt-icon">${wmoIcon(daily.weather_code[i])}</td><td class="wt-temp">${toN(daily.temperature_2m_max[i])}</td><td class="wt-wind">${toWn(daily.wind_speed_10m_max[i])}</td><td class="wt-gust">(${toWn(daily.wind_gusts_10m_max[i])})</td><td class="wt-precip">${daily.precipitation_probability_max[i]}%</td>`;
    tbody.appendChild(tr);
  }
}

// ============ BUILD WAVES ============
function buildWaves(marine){
  const container=document.getElementById('waveContent');
  if(!marine||!marine.current){
    container.innerHTML='<div class="no-wave-data">SEM DADOS DE ONDAS PARA ESTA LOCALIZACAO</div>';
    return;
  }
  const cur=marine.current;
  const daily=marine.daily;
  const wh=cur.wave_height;
  const swh=cur.swell_wave_height;
  const wd=cur.wave_direction;
  const wp=cur.wave_period;
  const q=waveQuality(wh);

  // Current wave display
  let html=`<div class="wave-display">
    <div class="wave-icon">üåä</div>
    <div class="wave-data">
      <div class="wave-height">${wh!==null?wh.toFixed(1):'--'}<sup>m</sup></div>
      <div class="wave-period">${wp!==null?wp.toFixed(0)+'s':'--'} PERIODO</div>
      <div class="wave-dir">${waveDir(wd)} (${wd!==null?Math.round(wd)+'¬∞':'--'})</div>
    </div>
  </div>`;

  // Wave quality badge
  html+=`<div class="wave-quality ${q.cls}">${q.label}</div>`;

  // Swell info if available
  if(swh!==null&&swh>0){
    html+=`<div style="margin-top:8px;font-family:'Orbitron';font-size:.5rem;opacity:.7;letter-spacing:1px;">SWELL: ${swh.toFixed(1)}m</div>`;
  }

  // 5-day swell strip
  if(daily&&daily.wave_height_max){
    const D=['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
    html+=`<div class="swell-strip">`;
    for(let i=0;i<5;i++){
      const dt=new Date(daily.time[i]);
      const dayH=daily.wave_height_max[i];
      const dayQ=waveQuality(dayH);
      html+=`<div class="swell-item">
        <div class="sw-day">${i===0?'HOJE':D[dt.getDay()]}</div>
        <div class="sw-icon">üåä</div>
        <div class="sw-height">${dayH!==null?dayH.toFixed(1):'--'}m</div>
        <div class="sw-period">${daily.wave_period_max[i]!==null?daily.wave_period_max[i].toFixed(0)+'s':'--'}</div>
      </div>`;
    }
    html+=`</div>`;
  }

  container.innerHTML=html;
}

// ============ STATE GRID ============
function buildStateGrid(res){
  const g=document.getElementById('stgrid');g.innerHTML='';
  res.forEach(({s})=>{
    const btn=document.createElement('button');
    btn.className='stbtn';
    // Sanitize state code for use as ID
    const safeCode=escapeHtml(s.code);
    btn.id='sb-'+safeCode;
    // Build button content safely
    const iconSpan=document.createElement('span');
    iconSpan.textContent=wmoIcon(s._c);
    const br1=document.createElement('br');
    const codeB=document.createElement('b');
    codeB.textContent=safeCode;
    const br2=document.createElement('br');
    const tempSpan=document.createElement('span');
    tempSpan.textContent=s._t!==null?toN(s._t):'?';
    btn.appendChild(iconSpan);
    btn.appendChild(br1);
    btn.appendChild(codeB);
    btn.appendChild(br2);
    btn.appendChild(tempSpan);
    btn.title=s.name;
    btn.onclick=()=>{selState(s);const m=stateMarkers.find(x=>x.s.code===s.code);if(m&&map){map.setView([s.lat,s.lon],7,{animate:true});showStatePopup(s,m.marker);}};
    g.appendChild(btn);
  });
}
function selState(s){
  document.querySelectorAll('.stbtn').forEach(b=>b.classList.remove('on'));
  // Sanitize state code for ID lookup
  const safeCode=escapeHtml(s.code);
  const btn=document.getElementById('sb-'+safeCode);if(btn)btn.classList.add('on');
  loadMain(s.lat,s.lon,s.name);
}

// ============ SPOTS GRID ============
function buildSpotsGrid(){
  const g=document.getElementById('spotsGrid');g.innerHTML='';
  const icons={surf:'\uD83C\uDFC4',kite:'\uD83E\uDE81',wind:'\uD83C\uDFC4',sail:'\u26F5',fish:'\uD83C\uDFA3',para:'\uD83E\uDE82'};
  SPOTS.forEach(sp=>{
    const btn=document.createElement('button');
    btn.className='spot-btn';
    // Build button content safely using DOM methods
    const iconSpan=document.createElement('span');
    iconSpan.className='spot-icon';
    iconSpan.textContent=icons[sp.type]||'\uD83C\uDFC4';
    const nameSpan=document.createElement('span');
    nameSpan.className='spot-name';
    nameSpan.textContent=sp.name.toUpperCase();
    btn.appendChild(iconSpan);
    btn.appendChild(nameSpan);
    btn.onclick=()=>{map.setView([sp.lat,sp.lon],10,{animate:true});openSpotModal(sp.name,sp.lat,sp.lon,sp.type);};
    g.appendChild(btn);
  });
}

// ============ TABS ============
document.querySelectorAll('.tbtn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tbtn').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tcont').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById('tc-'+b.dataset.tab).classList.add('on');
  };
});

// ============ SEARCH ============
const SEARCH_ITEMS=[...STATES.map(s=>({name:s.name+', '+s.code,lat:s.lat,lon:s.lon})),...SPOTS.map(sp=>({name:sp.name,lat:sp.lat,lon:sp.lon}))];
const sinput=document.getElementById('searchInput');
const sresults=document.getElementById('searchResults');
sinput.addEventListener('input',()=>{
  const q=sinput.value.toLowerCase().trim();
  if(q.length<2){sresults.classList.remove('show');return;}
  const matches=SEARCH_ITEMS.filter(c=>c.name.toLowerCase().includes(q)).slice(0,8);
  if(!matches.length){sresults.classList.remove('show');return;}
  // Build search results safely using DOM methods to prevent XSS
  sresults.innerHTML='';
  matches.forEach(c=>{
    const div=document.createElement('div');
    div.className='search-item';
    div.dataset.lat=c.lat;
    div.dataset.lon=c.lon;
    div.dataset.name=c.name;
    div.textContent=c.name.toUpperCase();
    div.addEventListener('click',async()=>{
      const lt=parseFloat(div.dataset.lat),ln=parseFloat(div.dataset.lon),nm=div.dataset.name;
      sinput.value=nm.toUpperCase();sresults.classList.remove('show');
      map.setView([lt,ln],10,{animate:true});
      await showMapPopup(lt,ln,nm);
      await loadMain(lt,ln,nm);
    });
    sresults.appendChild(div);
  });
  sresults.classList.add('show');
});
document.addEventListener('click',e=>{if(!e.target.closest('.search-wrap'))sresults.classList.remove('show');});

// ============ REFRESH ALL ============
function refreshAll(){
  if(uLat&&uLon){
    const k=`${uLat.toFixed(1)},${uLon.toFixed(1)}`;
    if(cache[k]&&cache[k].current){
      const c=cache[k].current;
      document.getElementById('mtemp').innerHTML=toN(c.temperature_2m)+'<sup>'+(celsius?'C':'F')+'</sup>';
      document.getElementById('mfeel').textContent=toC(c.apparent_temperature);
      document.getElementById('mgust').textContent=toW(c.wind_gusts_10m);
      document.getElementById('wrSpeed').textContent=toW(c.wind_speed_10m);
      if(cache[k].hourly)buildHours(cache[k].hourly);
      if(cache[k].daily)buildWindTable(cache[k].daily);
    }
  }
  STATES.forEach(s=>{
    const safeCode=escapeHtml(s.code);
    const btn=document.getElementById('sb-'+safeCode);
    if(btn&&s._t!==null){
      // Rebuild button content safely using DOM methods
      btn.innerHTML='';
      const iconSpan=document.createElement('span');
      iconSpan.textContent=wmoIcon(s._c);
      const br1=document.createElement('br');
      const codeB=document.createElement('b');
      codeB.textContent=safeCode;
      const br2=document.createElement('br');
      const tempSpan=document.createElement('span');
      tempSpan.textContent=toN(s._t);
      btn.appendChild(iconSpan);
      btn.appendChild(br1);
      btn.appendChild(codeB);
      btn.appendChild(br2);
      btn.appendChild(tempSpan);
    }
  });
  refreshMarkers();
}

// ============ LANGUAGE TOGGLE ============
function setLang(lang){
  curLang=lang;
  document.documentElement.lang=lang==='pt'?'pt-BR':'en';

  // Update toggle buttons
  document.getElementById('langPT').classList.toggle('on',lang==='pt');
  document.getElementById('langEN').classList.toggle('on',lang==='en');

  // Update night indicator
  document.getElementById('niText').textContent=isNight?t('night'):t('day');

  // Update sport buttons
  document.querySelectorAll('.sport-btn').forEach(btn=>{
    const sport=btn.dataset.sport;
    const icons={surf:'&#127940;',kite:'&#129667;',wind:'&#127940;',para:'&#129666;',sail:'&#9973;',fish:'&#127907;'};
    const keys={surf:'surf',kite:'kite',wind:'windsurf',para:'paraglide',sail:'sail',fish:'fish'};
    btn.innerHTML=`<span class="sicon">${icons[sport]}</span>${t(keys[sport])}`;
  });

  // Update labels
  const labels={
    currentCondition:'&#127919; ',wind:'&#127744; ',kiteRating:'&#129667; ',
    forecast12h:'&#128337; ',waves:'&#127754; ',tides:'&#127754; ',
    data:'&#128202; ',wind5days:'&#128168; ',legend:'&#127777;&#65039; '
  };
  document.querySelectorAll('.clabel').forEach(el=>{
    const text=el.textContent.trim();
    if(text.includes('CONDICAO')||text.includes('CONDITION'))el.innerHTML=labels.currentCondition+t('currentCondition');
    else if(text.includes('VENTO')&&!text.includes('DIAS')&&!text.includes('DAY'))el.innerHTML=labels.wind+t('wind');
    else if(text.includes('RATING'))el.innerHTML=labels.kiteRating+t('kiteRating');
    else if(text.includes('12H')||text.includes('PREVISAO'))el.innerHTML=labels.forecast12h+t('forecast12h');
    else if(text.includes('ONDAS')||text.includes('WAVES'))el.innerHTML=labels.waves+t('waves');
    else if(text.includes('MARES')||text.includes('TIDES'))el.innerHTML=labels.tides+t('tides');
    else if(text.includes('DADOS')||text.includes('DATA'))el.innerHTML=labels.data+t('data');
    else if(text.includes('5 DIAS')||text.includes('5 DAY'))el.innerHTML=labels.wind5days+t('wind5days');
    else if(text.includes('LEGENDA')||text.includes('LEGEND'))el.innerHTML=labels.legend+t('legend');
  });

  // Update search placeholder
  document.getElementById('searchInput').placeholder=t('searchPlaceholder');

  // Update share toast and button
  document.getElementById('shareToast').textContent=t('linkCopied');
  const shareBtnText=document.getElementById('shareBtnText');
  if(shareBtnText)shareBtnText.textContent=curLang==='pt'?'COMPARTILHAR':'SHARE';

  // Update kite labels
  document.getElementById('kiteLow').textContent=t('kiteLow');
  document.getElementById('kiteHigh').textContent=t('kiteHigh');

  // Re-render dynamic components if data loaded
  if(uLat&&uLon){
    buildTides();
    // Refresh condition badge
    const cacheKey=`${uLat.toFixed(1)},${uLon.toFixed(1)}`;
    if(cache[cacheKey]){
      const c=cache[cacheKey].current;
      const cond=surfCondition(c.weather_code,c.wind_speed_10m);
      document.getElementById('condBadge').innerHTML=`${cond.label} <span class="stars">${'‚òÖ'.repeat(cond.stars)}${'‚òÜ'.repeat(5-cond.stars)}</span>`;
      document.getElementById('condBadge').className='cond-badge '+cond.cls;
      // Update beaufort
      const bfEl=document.getElementById('wrBeaufort');
      if(bfEl)bfEl.textContent=beaufort(c.wind_speed_10m);
    }
  }
}

// Language toggle events
document.getElementById('langPT').onclick=()=>setLang('pt');
document.getElementById('langEN').onclick=()=>setLang('en');

// ============ INIT ============
async function init(){
  initMap(-14,-52);
  startLightning();

  // Check for shared spot URL
  const sharedSpot=parseUrlParams();

  try{
    const r=await fetch('https://ipapi.co/json/');
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    if(!d.latitude||!d.longitude)throw new Error('Invalid geolocation data');
    uLat=parseFloat(d.latitude);uLon=parseFloat(d.longitude);
    const city=(d.city||'Local')+', '+(d.region_code||'BR');
    await loadMain(uLat,uLon,city);
  }catch(e){
    uLat=-23.55;uLon=-46.63;
    await loadMain(uLat,uLon,'Sao Paulo, SP');
  }
  await placeStateMarkers();

  // Start wind animation after data loads (skip on mobile)
  if(!isMobile){
    initWindParticles();
    syncWindCanvas();
    if(!windAnimId)renderWindParticles();
  }

  // Check INMET official alerts (skip on mobile for performance)
  checkINMETAlerts();

  // Open shared spot modal after everything loads
  if(sharedSpot){
    setTimeout(()=>{
      map.setView([sharedSpot.lat,sharedSpot.lon],10,{animate:true});
      openSpotModal(sharedSpot.name,sharedSpot.lat,sharedSpot.lon,sharedSpot.type);
    },1500);
  }
}
init();

// ============ SERVICE WORKER ============
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
